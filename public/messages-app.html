<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messages - WebOS QuÃ©bec</title>
  <style>
    :root {
      --bg1:#09090b; --bg2:#18181b; --bg3:#27272a;
      --ink:#fafafa; --mut:#a1a1aa; --hint:#71717a;
      --elev:#3f3f46; --acc:#3b82f6; --ok:#10b981;
      --wrn:#f59e0b; --err:#ef4444; --brd:#27272a;
      --brd2:#3f3f46;
    }
    * { box-sizing:border-box; margin:0; padding:0 }
    body {
      font-family:system-ui,-apple-system,sans-serif;
      background:var(--bg1); color:var(--ink);
      height:100vh; overflow:hidden;
    }
    .app { display:flex; height:100%; overflow:hidden }
    .sidebar {
      width:320px; border-right:1px solid var(--brd);
      display:flex; flex-direction:column;
    }
    .sidebar-header {
      padding:16px; border-bottom:1px solid var(--brd);
      display:flex; align-items:center; justify-content:space-between;
    }
    .sidebar-title {
      font-size:18px; font-weight:700;
      display:flex; align-items:center; gap:8px;
    }
    .btn-new {
      padding:8px; background:var(--bg3); border:none;
      border-radius:8px; cursor:pointer; color:var(--ink);
      transition:background 0.2s;
    }
    .btn-new:hover { background:var(--elev) }
    .conversations {
      flex:1; overflow-y:auto;
    }
    .conv-item {
      padding:16px; border-bottom:1px solid rgba(39,39,42,0.5);
      cursor:pointer; transition:background 0.2s;
    }
    .conv-item:hover { background:var(--bg3) }
    .conv-item.active { background:var(--bg3) }
    .conv-name { font-weight:600; margin-bottom:4px }
    .conv-phone {
      font-size:12px; color:var(--hint);
      display:flex; align-items:center; gap:4px;
    }
    .conv-last { font-size:14px; color:var(--mut); margin-top:4px }
    .main { flex:1; display:flex; flex-direction:column }
    .chat-header {
      padding:16px; border-bottom:1px solid var(--brd);
    }
    .chat-title { font-weight:700; font-size:16px }
    .chat-subtitle {
      font-size:13px; color:var(--hint);
      display:flex; align-items:center; gap:4px; margin-top:4px;
    }
    .messages {
      flex:1; overflow-y:auto; padding:16px;
      display:flex; flex-direction:column; gap:12px;
    }
    .msg { display:flex }
    .msg.mine { justify-content:flex-end }
    .msg-bubble {
      max-width:60%; padding:12px 16px;
      border-radius:16px; word-break:break-word;
    }
    .msg.mine .msg-bubble {
      background:var(--acc); color:#fff;
      border-bottom-right-radius:4px;
    }
    .msg.other .msg-bubble {
      background:var(--bg3); color:var(--ink);
      border-bottom-left-radius:4px;
    }
    .msg-sender {
      font-size:12px; font-weight:600;
      opacity:0.7; margin-bottom:4px;
    }
    .msg-time {
      font-size:11px; opacity:0.7;
      margin-top:4px; display:flex;
      align-items:center; gap:4px;
    }
    .input-area {
      padding:16px; border-top:1px solid var(--brd);
      display:flex; gap:8px;
    }
    .input-area input {
      flex:1; padding:12px 16px;
      background:var(--bg3); border:1px solid var(--brd2);
      border-radius:12px; color:var(--ink);
      outline:none; font-size:15px;
    }
    .input-area input:focus {
      border-color:var(--acc);
    }
    .btn-send {
      padding:12px 24px; background:var(--acc);
      border:none; border-radius:12px;
      color:#fff; font-weight:600;
      cursor:pointer; transition:opacity 0.2s;
    }
    .btn-send:hover { opacity:0.9 }
    .btn-send:disabled {
      opacity:0.5; cursor:not-allowed;
    }
    .empty {
      flex:1; display:flex; align-items:center;
      justify-content:center; flex-direction:column;
      color:var(--mut);
    }
    .empty svg {
      width:64px; height:64px; opacity:0.5; margin-bottom:16px;
    }
    .loader {
      display:flex; align-items:center; justify-content:center;
      height:100%; color:var(--mut);
    }
    .spinner {
      width:40px; height:40px; border:3px solid var(--brd);
      border-top-color:var(--acc); border-radius:50%;
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg) }}
    .modal {
      position:fixed; inset:0; background:rgba(0,0,0,0.5);
      display:none; align-items:center; justify-content:center;
      z-index:100;
    }
    .modal.show { display:flex }
    .modal-content {
      background:var(--bg2); border:1px solid var(--brd);
      border-radius:12px; padding:24px; width:90%;
      max-width:400px; max-height:80vh; overflow-y:auto;
    }
    .modal-header {
      display:flex; align-items:center;
      justify-content:space-between; margin-bottom:16px;
    }
    .modal-title { font-size:18px; font-weight:700 }
    .btn-close {
      padding:4px; background:transparent; border:none;
      color:var(--mut); cursor:pointer; font-size:24px;
    }
    .user-list { display:flex; flex-direction:column; gap:8px }
    .user-item {
      padding:12px; border-radius:8px;
      background:var(--bg3); cursor:pointer;
      transition:background 0.2s;
      display:flex; align-items:center; gap:12px;
    }
    .user-item:hover { background:var(--elev) }
    .user-item input[type=checkbox] {
      width:18px; height:18px; cursor:pointer;
    }
    .user-info { flex:1 }
    .user-name { font-weight:600 }
    .user-phone {
      font-size:12px; color:var(--hint);
      display:flex; align-items:center; gap:4px;
      margin-top:2px;
    }
    .btn-create {
      width:100%; padding:12px; background:var(--acc);
      border:none; border-radius:8px; color:#fff;
      font-weight:600; cursor:pointer; margin-top:16px;
    }
    .btn-create:disabled {
      opacity:0.5; cursor:not-allowed;
    }
    .check-icon { color:var(--ok); font-size:12px }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          Messages
        </div>
        <button class="btn-new" onclick="showNewConversation()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
        </button>
      </div>
      <div class="conversations" id="conversations">
        <div class="loader"><div class="spinner"></div></div>
      </div>
    </div>

    <div class="main" id="main">
      <div class="empty">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        <p>SÃ©lectionnez une conversation</p>
      </div>
    </div>
  </div>

  <div class="modal" id="newConversationModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Nouvelle conversation</div>
        <button class="btn-close" onclick="hideNewConversation()">&times;</button>
      </div>
      <input type="text" id="searchInput" placeholder="Rechercher par nom, email ou numÃ©ro..." style="width:100%;padding:12px;border:1px solid var(--brd);background:var(--bg2);color:var(--ink);border-radius:8px;margin-bottom:12px;font-size:14px" oninput="filterUsers(this.value)" />
      <div class="user-list" id="userList">
        <div class="loader"><div class="spinner"></div></div>
      </div>
      <button class="btn-create" id="btnCreate" onclick="createConversation()" disabled>
        CrÃ©er (0)
      </button>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.57.4';

    const supabaseUrl = 'https://gwcpuwihjouusnohkmcy.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3Y3B1d2loam91dXNub2hrbWN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxODU1MTAsImV4cCI6MjA3Nzc2MTUxMH0.E9cDmyAmHvcIVNbvzBV7MKlqpLchAME9i2JKwNcuPO4';
    const supabase = createClient(supabaseUrl, supabaseKey, {
      auth: {
        persistSession: true,
        storageKey: 'sb-gwcpuwihjouusnohkmcy-auth-token',
        storage: window.localStorage
      }
    });

    let currentUser = null;
    let selectedConversation = null;
    let selectedUsers = [];
    let allUsers = [];
    let conversations = [];
    let searchTerm = '';
    let activeChannel = null;

    async function init() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;color:#a1a1aa">Non authentifiÃ©</div>';
        return;
      }
      currentUser = user;
      await loadConversations();
      await loadAllUsers();
    }

    async function loadConversations() {
      const { data: convos } = await supabase
        .from('conversations')
        .select('*, conversation_participants!inner(user_id)')
        .order('updated_at', { ascending: false });

      if (convos) {
        conversations = await Promise.all(convos.map(async (c) => {
          const { data: participants } = await supabase
            .from('conversation_participants')
            .select('user_id, users(id, email, full_name, phone_number, phone_verified)')
            .eq('conversation_id', c.id);

          const { data: lastMsg } = await supabase
            .from('messages')
            .select('*')
            .eq('conversation_id', c.id)
            .order('created_at', { ascending: false })
            .limit(1)
            .maybeSingle();

          return { ...c, participants: participants?.map(p => p.users) || [], last_message: lastMsg };
        }));

        renderConversations();
      }
    }

    function renderConversations() {
      const container = document.getElementById('conversations');
      if (!conversations.length) {
        container.innerHTML = '<div style="padding:20px;text-align:center;color:#71717a">Aucune conversation</div>';
        return;
      }

      container.innerHTML = conversations.map(c => {
        const others = c.participants.filter(p => p.id !== currentUser.id);
        const name = c.type === 'group' ? c.name || `Groupe (${c.participants.length})` : others[0]?.full_name || others[0]?.email || 'Utilisateur';
        const phone = others[0]?.phone_number;
        const verified = others[0]?.phone_verified;
        const last = c.last_message?.content || '';

        return `
          <div class="conv-item ${selectedConversation === c.id ? 'active' : ''}" onclick="selectConversation('${c.id}')">
            <div class="conv-name">${name}</div>
            ${phone ? `<div class="conv-phone">ðŸ“± ${phone} ${verified ? '<span class="check-icon">âœ“</span>' : ''}</div>` : ''}
            ${last ? `<div class="conv-last">${last}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    async function selectConversation(id) {
      selectedConversation = id;
      renderConversations();
      await loadMessages(id);
      await markMessagesAsRead(id);
      subscribeToMessages(id);
    }

    async function markMessagesAsRead(conversationId) {
      try {
        const { error } = await supabase.rpc('mark_messages_as_read', {
          p_conversation_id: conversationId,
          p_user_id: currentUser.id
        });
        if (error) console.error('Error marking messages as read:', error);
      } catch (err) {
        console.error('Failed to mark messages as read:', err);
      }
    }

    async function loadMessages(conversationId) {
      const convo = conversations.find(c => c.id === conversationId);
      const others = convo.participants.filter(p => p.id !== currentUser.id);

      const { data: messages } = await supabase
        .from('messages')
        .select(`
          *,
          sender:users!messages_sender_id_fkey(id, email, full_name),
          message_receipts(message_id, user_id, read_at)
        `)
        .eq('conversation_id', conversationId)
        .order('created_at', { ascending: true });

      const main = document.getElementById('main');
      main.innerHTML = `
        <div class="chat-header">
          <div class="chat-title">${convo.type === 'group' ? convo.name || `Groupe (${convo.participants.length})` : others[0]?.full_name || others[0]?.email}</div>
          ${others[0]?.phone_number ? `<div class="chat-subtitle">ðŸ“± ${others[0].phone_number} ${others[0].phone_verified ? '<span class="check-icon">âœ“</span>' : ''}</div>` : ''}
        </div>
        <div class="messages" id="messages">
          ${messages?.map(m => {
            const isMine = m.sender_id === currentUser.id;
            const hasRead = m.message_receipts && m.message_receipts.length > 0;
            return `
              <div class="msg ${isMine ? 'mine' : 'other'}">
                <div class="msg-bubble">
                  ${!isMine && convo.type === 'group' ? `<div class="msg-sender">${m.sender?.full_name || m.sender?.email}</div>` : ''}
                  <div>${m.content}</div>
                  <div class="msg-time">
                    ${new Date(m.created_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}
                    ${isMine ? (hasRead ? 'âœ“âœ“' : 'âœ“') : ''}
                  </div>
                </div>
              </div>
            `;
          }).join('') || ''}
        </div>
        <div class="input-area">
          <input type="text" id="messageInput" placeholder="Tapez votre message..." onkeydown="if(event.key==='Enter') sendMessage()" />
          <button class="btn-send" onclick="sendMessage()">Envoyer</button>
        </div>
      `;

      document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }

    function subscribeToMessages(conversationId) {
      if (activeChannel) {
        supabase.removeChannel(activeChannel);
        activeChannel = null;
      }

      activeChannel = supabase.channel(`messages:${conversationId}`)
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `conversation_id=eq.${conversationId}` },
          async () => {
            await loadMessages(conversationId);
            await markMessagesAsRead(conversationId);
          })
        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'message_receipts' },
          () => loadMessages(conversationId))
        .subscribe();
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      if (!input || !input.value.trim()) return;

      await supabase.from('messages').insert({
        conversation_id: selectedConversation,
        sender_id: currentUser.id,
        content: input.value.trim()
      });

      input.value = '';
      await loadConversations();
    }

    async function loadAllUsers() {
      const { data } = await supabase
        .from('users')
        .select('id, email, full_name, phone_number, phone_verified')
        .neq('id', currentUser.id);
      allUsers = data || [];
    }

    window.filterUsers = function(term) {
      searchTerm = term.toLowerCase();
      const filtered = allUsers.filter(u => {
        const name = (u.full_name || '').toLowerCase();
        const email = (u.email || '').toLowerCase();
        const phone = (u.phone_number || '').replace(/[\s()-]/g, '');
        const searchPhone = term.replace(/[\s()-]/g, '');

        return name.includes(searchTerm) ||
               email.includes(searchTerm) ||
               phone.includes(searchPhone);
      });

      renderUserList(filtered);
    };

    function renderUserList(users) {
      const userList = document.getElementById('userList');
      if (!users.length) {
        userList.innerHTML = '<div style="padding:20px;text-align:center;color:#71717a">Aucun utilisateur trouvÃ©</div>';
        return;
      }

      userList.innerHTML = users.map(u => `
        <label class="user-item">
          <input type="checkbox" onchange="toggleUser('${u.id}')" ${selectedUsers.includes(u.id) ? 'checked' : ''}>
          <div class="user-info">
            <div class="user-name">${u.full_name || u.email}</div>
            ${u.phone_number ? `<div class="user-phone">ðŸ“± ${u.phone_number} ${u.phone_verified ? '<span class="check-icon">âœ“</span>' : ''}</div>` : '<div class="user-phone" style="color:#71717a;font-style:italic">Aucun numÃ©ro enregistrÃ©</div>'}
          </div>
        </label>
      `).join('');
    }

    window.showNewConversation = function() {
      const modal = document.getElementById('newConversationModal');
      searchTerm = '';
      document.getElementById('searchInput').value = '';
      renderUserList(allUsers);
      selectedUsers = [];
      document.getElementById('btnCreate').disabled = true;
      document.getElementById('btnCreate').textContent = 'CrÃ©er (0)';
      modal.classList.add('show');
    };

    window.hideNewConversation = function() {
      document.getElementById('newConversationModal').classList.remove('show');
    };

    window.toggleUser = function(userId) {
      if (selectedUsers.includes(userId)) {
        selectedUsers = selectedUsers.filter(id => id !== userId);
      } else {
        selectedUsers.push(userId);
      }
      document.getElementById('btnCreate').disabled = selectedUsers.length === 0;
      document.getElementById('btnCreate').textContent = `CrÃ©er (${selectedUsers.length})`;
    };

    window.createConversation = async function() {
      if (selectedUsers.length === 0) return;

      const type = selectedUsers.length === 1 ? 'direct' : 'group';
      const { data: convo } = await supabase.from('conversations').insert({ type, created_by: currentUser.id }).select().single();

      if (convo) {
        const participants = [currentUser.id, ...selectedUsers].map(userId => ({
          conversation_id: convo.id,
          user_id: userId
        }));

        await supabase.from('conversation_participants').insert(participants);
        hideNewConversation();
        await loadConversations();
        await selectConversation(convo.id);
      }
    };

    init();
  </script>
</body>
</html>
