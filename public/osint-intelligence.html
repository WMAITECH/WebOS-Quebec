<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OSINT Intelligence System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body, html {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    #root {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="module">
    import { createRoot } from 'https://esm.sh/react-dom@18.3.1/client';
    import { createElement } from 'https://esm.sh/react@18.3.1';
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    window.supabase = createClient(
      'https://gwcpuwihjouusnohkmcy.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3Y3B1d2loam91dXNub2hrbWN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxODU1MTAsImV4cCI6MjA3Nzc2MTUxMH0.E9cDmyAmHvcIVNbvzBV7MKlqpLchAME9i2JKwNcuPO4'
    );

    const OSINTIntelligenceApp = () => {
      const React = window.React || { useState: () => [null, () => {}], useEffect: () => {} };
      const { useState, useEffect } = React;

      const [activeTab, setActiveTab] = useState('query');
      const [query, setQuery] = useState('');
      const [style, setStyle] = useState('adaptive');
      const [isGenerating, setIsGenerating] = useState(false);
      const [synthesis, setSynthesis] = useState('');
      const [synthesisMetadata, setSynthesisMetadata] = useState(null);

      const [learningSessions, setLearningSessions] = useState([]);
      const [knowledgeNodes, setKnowledgeNodes] = useState([]);
      const [recentSyntheses, setRecentSyntheses] = useState([]);
      const [learningMetrics, setLearningMetrics] = useState([]);
      const [isLearning, setIsLearning] = useState(false);

      useEffect(() => {
        loadDashboardData();
        const interval = setInterval(loadDashboardData, 30000);
        return () => clearInterval(interval);
      }, []);

      const loadDashboardData = async () => {
        const { data: sessions } = await window.supabase
          .from('osint_learning_sessions')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(10);
        if (sessions) setLearningSessions(sessions);

        const { data: nodes } = await window.supabase
          .from('knowledge_graph_nodes')
          .select('*')
          .order('importance_score', { ascending: false })
          .limit(20);
        if (nodes) setKnowledgeNodes(nodes);

        const { data: syntheses } = await window.supabase
          .from('mechanical_syntheses')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(10);
        if (syntheses) setRecentSyntheses(syntheses);

        const { data: metrics } = await window.supabase
          .from('learning_metrics')
          .select('*')
          .order('recorded_at', { ascending: false })
          .limit(50);
        if (metrics) setLearningMetrics(metrics);
      };

      const handleGenerateSynthesis = async () => {
        if (!query.trim()) return;

        setIsGenerating(true);
        setSynthesis('');
        setSynthesisMetadata(null);

        try {
          const response = await fetch(
            'https://gwcpuwihjouusnohkmcy.supabase.co/functions/v1/intelligent-synthesis-worker',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3Y3B1d2loam91dXNub2hrbWN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxODU1MTAsImV4cCI6MjA3Nzc2MTUxMH0.E9cDmyAmHvcIVNbvzBV7MKlqpLchAME9i2JKwNcuPO4',
              },
              body: JSON.stringify({ query, style: style === 'adaptive' ? undefined : style, max_sources: 15 }),
            }
          );

          if (!response.ok) throw new Error('Synthesis generation failed');

          const data = await response.json();
          setSynthesis(data.synthesis);
          setSynthesisMetadata(data.metadata);
        } catch (error) {
          console.error('Synthesis error:', error);
          setSynthesis('Failed to generate synthesis. Please try again.');
        } finally {
          setIsGenerating(false);
        }
      };

      const handleTriggerLearning = async () => {
        setIsLearning(true);

        try {
          await fetch(
            'https://gwcpuwihjouusnohkmcy.supabase.co/functions/v1/autonomous-osint-orchestrator',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3Y3B1d2loam91dXNub2hrbWN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxODU1MTAsImV4cCI6MjA3Nzc2MTUxMH0.E9cDmyAmHvcIVNbvzBV7MKlqpLchAME9i2JKwNcuPO4',
              },
              body: JSON.stringify({ action: 'execute_pending_tasks' }),
            }
          );

          setTimeout(loadDashboardData, 2000);
        } catch (error) {
          console.error('Learning trigger error:', error);
        } finally {
          setIsLearning(false);
        }
      };

      return createElement('div', { className: 'flex flex-col h-full', style: { background: 'linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #0f172a 100%)' } },
        createElement('div', { className: 'flex-none', style: { background: 'linear-gradient(to right, #3b82f6, #8b5cf6)', color: 'white', padding: '1.5rem', boxShadow: '0 10px 40px rgba(0,0,0,0.3)' } },
          createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' } },
            createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '1rem' } },
              createElement('div', { style: { padding: '0.5rem', background: 'rgba(255,255,255,0.2)', borderRadius: '0.5rem', backdropFilter: 'blur(10px)' } },
                'ðŸ§ '
              ),
              createElement('div', null,
                createElement('h2', { style: { fontSize: '1.5rem', fontWeight: 'bold' } }, 'OSINT Intelligence System'),
                createElement('p', { style: { fontSize: '0.875rem', color: '#bfdbfe' } }, 'Continuous Learning AI with Mechanical Synthesis')
              )
            ),
            createElement('div', { style: { display: 'flex', gap: '1rem' } },
              createElement('div', { style: { padding: '0.5rem 1rem', background: 'rgba(255,255,255,0.2)', borderRadius: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' } },
                'âš¡',
                createElement('span', { style: { fontSize: '0.875rem', fontWeight: '500' } }, 'System Active')
              ),
              createElement('button', {
                onClick: handleTriggerLearning,
                disabled: isLearning,
                style: { padding: '0.5rem 1rem', background: 'rgba(255,255,255,0.2)', borderRadius: '0.5rem', border: 'none', color: 'white', cursor: isLearning ? 'not-allowed' : 'pointer', opacity: isLearning ? 0.5 : 1 }
              }, isLearning ? 'Learning...' : 'âš¡ Trigger Learning')
            )
          ),
          createElement('div', { style: { display: 'flex', gap: '0.5rem' } },
            ['query', 'knowledge', 'learning', 'metrics'].map(tab =>
              createElement('button', {
                key: tab,
                onClick: () => setActiveTab(tab),
                style: {
                  padding: '0.5rem 1rem',
                  borderRadius: '0.5rem',
                  fontWeight: '500',
                  border: 'none',
                  cursor: 'pointer',
                  background: activeTab === tab ? 'white' : 'rgba(255,255,255,0.2)',
                  color: activeTab === tab ? '#3b82f6' : 'white'
                }
              }, tab.charAt(0).toUpperCase() + tab.slice(1))
            )
          )
        ),
        createElement('div', { className: 'flex-1', style: { overflowY: 'auto', padding: '1.5rem' } },
          activeTab === 'query' && createElement('div', { style: { maxWidth: '1200px', margin: '0 auto' } },
            createElement('div', { style: { background: 'rgba(255,255,255,0.1)', backdropFilter: 'blur(20px)', borderRadius: '1rem', padding: '1.5rem', border: '1px solid rgba(255,255,255,0.2)', marginBottom: '1.5rem' } },
              createElement('h3', { style: { fontSize: '1.25rem', fontWeight: 'bold', color: 'white', marginBottom: '1rem' } }, 'âœ¨ Intelligent Query System'),
              createElement('div', { style: { marginBottom: '1rem' } },
                createElement('label', { style: { display: 'block', fontSize: '0.875rem', color: '#bfdbfe', marginBottom: '0.5rem' } }, 'Your Query'),
                createElement('textarea', {
                  value: query,
                  onChange: (e) => setQuery(e.target.value),
                  placeholder: 'Ask anything...',
                  style: { width: '100%', padding: '0.75rem', background: 'rgba(255,255,255,0.1)', border: '1px solid rgba(255,255,255,0.3)', borderRadius: '0.5rem', color: 'white', minHeight: '100px', resize: 'vertical' }
                })
              ),
              createElement('div', { style: { display: 'flex', gap: '1rem', alignItems: 'end' } },
                createElement('div', { style: { flex: 1 } },
                  createElement('label', { style: { display: 'block', fontSize: '0.875rem', color: '#bfdbfe', marginBottom: '0.5rem' } }, 'Synthesis Style'),
                  createElement('select', {
                    value: style,
                    onChange: (e) => setStyle(e.target.value),
                    style: { width: '100%', padding: '0.75rem', background: 'rgba(255,255,255,0.1)', border: '1px solid rgba(255,255,255,0.3)', borderRadius: '0.5rem', color: 'white' }
                  },
                    ['adaptive', 'journalistic', 'academic', 'conversational', 'technical', 'formal'].map(s =>
                      createElement('option', { key: s, value: s }, s.charAt(0).toUpperCase() + s.slice(1))
                    )
                  )
                ),
                createElement('button', {
                  onClick: handleGenerateSynthesis,
                  disabled: isGenerating || !query.trim(),
                  style: {
                    padding: '0.75rem 2rem',
                    background: 'linear-gradient(to right, #3b82f6, #8b5cf6)',
                    border: 'none',
                    borderRadius: '0.5rem',
                    color: 'white',
                    fontWeight: '500',
                    cursor: (isGenerating || !query.trim()) ? 'not-allowed' : 'pointer',
                    opacity: (isGenerating || !query.trim()) ? 0.5 : 1
                  }
                }, isGenerating ? 'Generating...' : 'Generate Synthesis')
              )
            ),
            isGenerating && createElement('div', { style: { background: 'rgba(255,255,255,0.1)', borderRadius: '1rem', padding: '2rem', textAlign: 'center', marginBottom: '1.5rem' } },
              createElement('div', { style: { width: '4rem', height: '4rem', border: '4px solid #3b82f6', borderTopColor: 'transparent', borderRadius: '50%', animation: 'spin 1s linear infinite', margin: '0 auto 1rem' } }),
              createElement('p', { style: { color: 'white', fontWeight: '500' } }, 'Analyzing knowledge graph...')
            ),
            synthesis && !isGenerating && createElement('div', { style: { background: 'rgba(255,255,255,0.1)', borderRadius: '1rem', padding: '1.5rem', marginBottom: '1.5rem' } },
              createElement('h3', { style: { fontSize: '1.25rem', fontWeight: 'bold', color: 'white', marginBottom: '1rem' } }, 'âœ¨ Generated Synthesis'),
              createElement('div', { style: { color: 'white', whiteSpace: 'pre-wrap', lineHeight: '1.7' } }, synthesis),
              synthesisMetadata && createElement('div', { style: { marginTop: '1.5rem', paddingTop: '1.5rem', borderTop: '1px solid rgba(255,255,255,0.2)' } },
                createElement('div', { style: { display: 'flex', gap: '1rem', fontSize: '0.875rem', color: '#bfdbfe', marginBottom: '1rem' } },
                  createElement('span', null, `Confidence: ${synthesisMetadata.confidenceScore}%`),
                  createElement('span', null, `Coherence: ${synthesisMetadata.coherenceScore}%`),
                  createElement('span', null, `${synthesisMetadata.citationCount} citations`)
                )
              )
            )
          ),
          activeTab === 'knowledge' && createElement('div', { style: { maxWidth: '1400px', margin: '0 auto' } },
            createElement('div', { style: { background: 'rgba(255,255,255,0.1)', borderRadius: '1rem', padding: '1.5rem' } },
              createElement('h3', { style: { fontSize: '1.25rem', fontWeight: 'bold', color: 'white', marginBottom: '1rem' } }, `ðŸ•¸ï¸ Knowledge Graph (${knowledgeNodes.length} Nodes)`),
              createElement('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))', gap: '1rem' } },
                knowledgeNodes.map(node =>
                  createElement('div', { key: node.id, style: { background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '0.5rem', padding: '1rem' } },
                    createElement('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' } },
                      createElement('div', null,
                        createElement('p', { style: { fontWeight: 'bold', color: 'white' } }, node.entity_name),
                        createElement('p', { style: { fontSize: '0.75rem', color: '#93c5fd', textTransform: 'capitalize' } }, node.entity_type)
                      ),
                      createElement('div', { style: { textAlign: 'right' } },
                        createElement('p', { style: { fontSize: '0.75rem', color: '#86efac', fontWeight: '500' } }, `${node.importance_score.toFixed(0)}%`),
                        createElement('p', { style: { fontSize: '0.75rem', color: '#bfdbfe' } }, `${node.mention_count} mentions`)
                      )
                    ),
                    createElement('div', { style: { width: '100%', height: '0.5rem', background: 'rgba(255,255,255,0.1)', borderRadius: '0.25rem', overflow: 'hidden' } },
                      createElement('div', { style: { height: '100%', background: 'linear-gradient(to right, #3b82f6, #8b5cf6)', width: `${node.confidence_score}%`, transition: 'width 0.3s' } })
                    ),
                    createElement('p', { style: { fontSize: '0.75rem', color: '#bfdbfe', marginTop: '0.25rem' } }, `Confidence: ${node.confidence_score.toFixed(0)}%`)
                  )
                )
              )
            )
          )
        )
      );
    };

    window.React = await import('https://esm.sh/react@18.3.1');

    const root = createRoot(document.getElementById('root'));
    root.render(createElement(OSINTIntelligenceApp));
  </script>
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</body>
</html>
