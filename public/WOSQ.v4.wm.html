<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="WOSQ v4.0 Cellular - Système d'exploitation gouvernemental souverain avec architecture cellulaire avancée: Multi-Processus Web Workers, Local-First CRDT, IA Orchestrateur avec Tool-Use, Synchronisation P2P automatique, Performance GPU maximale, Sécurité renforcée">
  <meta name="theme-color" content="#1e40af">
  <meta name="version" content="4.0.0-cellular">
  <meta name="architecture" content="cellular-multiprocess">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='75' font-size='80' text-anchor='middle'%3E⚜️%3C/text%3E%3C/svg%3E" type="image/svg+xml">

  <!-- PWA Configuration -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="WebOS Québec">
  <meta name="format-detection" content="telephone=no">

  <!-- Security Headers -->
  <!-- DIFF: CSP durcie + mode souverain + Cross-Origin Isolation pour WebGPU -->
  <script>
    window.__WEBOS_SECURITY__ = {
      offlineStrict: true,
      allowedOrigins: [location.origin],
      version: "3.0.0-ultra",
      production: true,
      enableDebugLogging: false,
      maxCacheSize: 100 * 1024 * 1024,
      enableGPUAcceleration: true,
      crossOriginIsolated: true
    };

    (function applySecurityHeaders() {
      if (!window.__WEBOS_SECURITY__.offlineStrict) return;

      const coop = document.createElement("meta");
      coop.httpEquiv = "Cross-Origin-Opener-Policy";
      coop.content = "same-origin";
      document.head.appendChild(coop);

      const coep = document.createElement("meta");
      coep.httpEquiv = "Cross-Origin-Embedder-Policy";
      coep.content = "credentialless";
      document.head.appendChild(coep);

      const csp = document.createElement("meta");
      csp.httpEquiv = "Content-Security-Policy";
      csp.content = [
        "default-src 'self' blob: data:",
        "script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval' https://cdn.jsdelivr.net https://esm.run https://unpkg.com",
        "style-src 'self' 'unsafe-inline'",
        "img-src 'self' data: blob: https:",
        "connect-src 'self' https://*.supabase.co wss://*.supabase.co https://cdn.jsdelivr.net https://esm.run https://unpkg.com https://huggingface.co https://*.huggingface.co https:",
        "worker-src 'self' blob:",
        "object-src 'none'",
        "frame-src 'none'",
        "base-uri 'none'",
        "form-action 'self'"
      ].join("; ");
      document.head.appendChild(csp);

      console.log('[Security] Cross-Origin Isolation enabled for WebGPU with credentialless mode');
      console.log('[Security] COOP: same-origin, COEP: credentialless (allows external fetches)');
    })();
  </script>

  <title>WOSQ v4.0 Cellular - Architecture Multi-Processus Avancée</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #60a5fa 100%);
    }

    .window {
      position: absolute;
      background: white;
      border-radius: 12px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: box-shadow 0.2s;
      min-width: 300px;
      min-height: 200px;
    }

    .window:hover {
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
    }

    .window-header {
      background: linear-gradient(to right, #1e40af, #3b82f6);
      color: white;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move;
      user-select: none;
    }

    .window-controls {
      display: flex;
      gap: 8px;
    }

    .window-control {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .window-control:hover {
      transform: scale(1.2);
    }

    .window-control.close { background: #ef4444; }
    .window-control.minimize { background: #f59e0b; }
    .window-control.maximize { background: #10b981; }

    .window-content {
      flex: 1;
      overflow: auto;
      padding: 20px;
      background: white;
    }

    .resize-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #3b82f6;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .window:hover .resize-handle {
      opacity: 0.5;
    }

    .resize-handle.se { bottom: 0; right: 0; cursor: se-resize; }
    .resize-handle.sw { bottom: 0; left: 0; cursor: sw-resize; }
    .resize-handle.ne { top: 40px; right: 0; cursor: ne-resize; }
    .resize-handle.nw { top: 40px; left: 0; cursor: nw-resize; }

    .dock {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 12px;
      display: flex;
      gap: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .dock-item {
      width: 56px;
      height: 56px;
      background: white;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .dock-item:hover {
      transform: translateY(-8px) scale(1.1);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
    }

    .topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: rgba(30, 64, 175, 0.98);
      display: flex;
      align-items: center;
      color: white;
      z-index: 9999;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      overflow-x: auto;
      overflow-y: hidden;
      scrollbar-width: none;
      -ms-overflow-style: none;
      transform: translateZ(0);
      backface-visibility: hidden;
      will-change: transform;
    }

    .topbar::-webkit-scrollbar {
      display: none;
    }

    .topbar-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-width: 100%;
      padding: 0 20px;
      gap: 20px;
    }

    .topbar-left, .topbar-right {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-shrink: 0;
    }

    .topbar-item {
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 6px;
      transition: background 0.2s;
      font-size: 14px;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .topbar-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .calendar-popup {
      position: fixed;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      padding: 16px;
      z-index: 10000;
      color: #1e40af;
      min-width: 280px;
    }

    .calendar-header {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
      text-align: center;
      color: #1e40af;
    }

    .calendar-date {
      font-size: 32px;
      font-weight: 700;
      text-align: center;
      color: #3b82f6;
      margin-bottom: 8px;
    }

    .calendar-day {
      font-size: 14px;
      text-align: center;
      color: #64748b;
      margin-bottom: 12px;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-top: 12px;
    }

    .calendar-grid-header {
      font-size: 11px;
      font-weight: 600;
      text-align: center;
      padding: 4px;
      color: #64748b;
    }

    .calendar-grid-day {
      font-size: 12px;
      text-align: center;
      padding: 6px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .calendar-grid-day:hover {
      background: #eff6ff;
    }

    .calendar-grid-day.today {
      background: #3b82f6;
      color: white;
      font-weight: 700;
    }

    .calendar-grid-day.other-month {
      color: #cbd5e1;
    }

    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      color: white;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .progress-bar {
      width: 400px;
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      margin-top: 30px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: white;
      border-radius: 3px;
      transition: width 0.3s;
      width: 0%;
    }

    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9998;
    }

    .login-box {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      width: 400px;
      max-width: 90%;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #1e40af;
    }

    .input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .input-group input:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(to right, #1e40af, #3b82f6);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .chat-message {
      margin-bottom: 16px;
      padding: 12px;
      border-radius: 12px;
      max-width: 80%;
    }

    .chat-message.user {
      background: #3b82f6;
      color: white;
      margin-left: auto;
    }

    .chat-message.assistant {
      background: #f3f4f6;
      color: #1f2937;
    }

    .terminal {
      background: #1f2937;
      color: #10b981;
      font-family: 'Courier New', monospace;
      padding: 20px;
      height: 100%;
      overflow-y: auto;
    }

    .terminal-line {
      margin-bottom: 4px;
    }

    .terminal-input {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .terminal-input input {
      flex: 1;
      background: transparent;
      border: none;
      color: #10b981;
      font-family: 'Courier New', monospace;
      outline: none;
    }

    .file-item {
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .file-item:hover {
      background: #f3f4f6;
    }

    .context-menu {
      position: fixed;
      background: white;
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      padding: 8px;
      min-width: 200px;
      z-index: 10000;
    }

    .context-menu-item {
      padding: 10px 12px;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .context-menu-item:hover {
      background: #f3f4f6;
    }

    /* Responsive Design for Mobile and Tablets */
    @media (max-width: 768px) {
      .window {
        min-width: 280px !important;
        border-radius: 0 !important;
      }

      .window-header {
        padding: 16px !important;
        touch-action: none;
      }

      .window-control {
        width: 16px !important;
        height: 16px !important;
      }

      .window-content {
        padding: 12px !important;
      }

      .dock {
        bottom: 10px;
        padding: 8px;
        gap: 8px;
      }

      .dock-item {
        width: 48px;
        height: 48px;
      }

      .topbar {
        font-size: 13px;
      }

      .topbar-item {
        padding: 8px 10px;
      }

      .resize-handle {
        width: 20px !important;
        height: 20px !important;
        opacity: 1 !important;
      }
    }

    @media (max-width: 480px) {
      .window {
        min-width: 100% !important;
        max-width: 100% !important;
        left: 0 !important;
        right: 0 !important;
        margin: 0 !important;
        border-radius: 0 !important;
      }

      .dock {
        left: 0;
        right: 0;
        transform: none;
        border-radius: 0;
        justify-content: space-around;
        padding: 8px 4px;
      }

      .dock-item {
        width: 42px;
        height: 42px;
      }

      .topbar-left,
      .topbar-right {
        gap: 4px;
      }

      .topbar-item {
        padding: 6px 8px;
        font-size: 12px;
      }
    }

    @media (orientation: landscape) and (max-height: 500px) {
      .window {
        max-height: calc(100vh - 100px) !important;
      }

      .dock {
        padding: 6px;
      }

      .dock-item {
        width: 40px;
        height: 40px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loadingScreen" class="loading-screen">
    <div class="loading-spinner"></div>
    <h2 style="margin-top: 30px; font-size: 24px; font-weight: 600;">WebOS Québec</h2>
    <p style="margin-top: 10px; opacity: 0.8;">Initialisation du système...</p>
    <div class="progress-bar">
      <div id="progressFill" class="progress-fill"></div>
    </div>
    <p id="loadingStatus" style="margin-top: 15px; font-size: 14px; opacity: 0.7;">Démarrage du noyau...</p>
  </div>

  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen" style="display: none;">
    <div class="login-box">
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 64px; margin-bottom: 16px;">⚜️</div>
        <h1 style="color: #1e40af; margin-bottom: 10px; font-size: 28px;">WebOS Québec</h1>
        <p style="color: #6b7280; margin-bottom: 0;">Système d'exploitation souverain</p>
      </div>

      <div id="loginForm">
        <div class="input-group">
          <label>Courriel</label>
          <input type="email" id="loginEmail" placeholder="votre@courriel.qc.ca" />
        </div>
        <div class="input-group">
          <label>Mot de passe</label>
          <input type="password" id="loginPassword" placeholder="••••••••" />
        </div>
        <button class="btn" onclick="WebOS.Auth.login()">Se connecter</button>
        <p style="text-align: center; margin-top: 20px; color: #6b7280; font-size: 14px;">
          Pas de compte?
          <a href="#" onclick="WebOS.Auth.showRegister(); return false;" style="color: #3b82f6; text-decoration: none;">Créer un compte</a>
        </p>
      </div>

      <div id="registerForm" style="display: none;">
        <div class="input-group">
          <label>Nom complet</label>
          <input type="text" id="registerName" placeholder="Jean Tremblay" />
        </div>
        <div class="input-group">
          <label>Courriel</label>
          <input type="email" id="registerEmail" placeholder="votre@courriel.qc.ca" />
        </div>
        <div class="input-group">
          <label>Mot de passe</label>
          <input type="password" id="registerPassword" placeholder="••••••••" />
        </div>
        <button class="btn" onclick="WebOS.Auth.register()">Créer mon compte</button>
        <p style="text-align: center; margin-top: 20px; color: #6b7280; font-size: 14px;">
          Déjà inscrit?
          <a href="#" onclick="WebOS.Auth.showLogin(); return false;" style="color: #3b82f6; text-decoration: none;">Se connecter</a>
        </p>
      </div>
    </div>
  </div>

  <!-- Desktop Area -->
  <div id="desktop" style="position: absolute; top: 40px; left: 0; right: 0; bottom: 0; display: none;">
    <!-- Windows will be inserted here -->
  </div>

  <!-- Top Bar -->
  <div id="topbar" class="topbar" style="display: none;">
    <div class="topbar-container">
      <div class="topbar-left">
        <div class="topbar-item" style="display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 16px;">
          <span style="font-size: 20px;">⚜️</span>
          <span>WebOS Québec</span>
        </div>
        <div class="topbar-item" onclick="WebOS.showAbout()">À propos</div>
        <div class="topbar-item" onclick="WebOS.showSettings()">Préférences</div>
      </div>
      <div class="topbar-right">
        <div class="topbar-item" id="sovereignBadge" style="background:rgba(15,118,110,.15);border:1px solid rgba(45,212,191,.45);border-radius:9999px;display:flex;gap:6px;align-items:center;font-size:11px;">
          <span style="width:6px;height:6px;border-radius:9999px;background:#22c55e;display:inline-block;"></span>
          <span>Souverain · Offline</span>
        </div>
        <div class="topbar-item" id="aiStatus">IA: Non chargée</div>
        <div class="topbar-item" id="systemTime" onclick="WebOS.toggleCalendar(event)">--:--</div>
        <div class="topbar-item" onclick="WebOS.Auth.logout()">Déconnexion</div>
      </div>
    </div>
  </div>

  <!-- Dock -->
  <div id="dock" class="dock" style="display: none;">
    <div class="dock-item" onclick="WebOS.NotificationCenter.toggle()" title="Portail Citoyen - Notifications" id="dock-portal" style="position: relative;">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#1e40af" stroke-width="2">
        <rect x="3" y="3" width="7" height="7"></rect>
        <rect x="14" y="3" width="7" height="7"></rect>
        <rect x="14" y="14" width="7" height="7"></rect>
        <rect x="3" y="14" width="7" height="7"></rect>
      </svg>
      <div id="notification-badge" style="display: none; position: absolute; top: -4px; right: -4px; background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; border: 2px solid #09090b;"></div>
    </div>
    <div class="dock-item" onclick="WebOS.Apps.Files.open()" title="Gestionnaire de fichiers">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#1e40af" stroke-width="2">
        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
      </svg>
    </div>
    <div class="dock-item" onclick="WebOS.Apps.AIChat.open()" title="Assistant IA">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#1e40af" stroke-width="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
    </div>
    <div class="dock-item" onclick="WebOS.Apps.Terminal.open()" title="Terminal">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#1e40af" stroke-width="2">
        <polyline points="4 17 10 11 4 5"></polyline>
        <line x1="12" y1="19" x2="20" y2="19"></line>
      </svg>
    </div>
    <div class="dock-item" onclick="WebOS.Apps.Monitor.open()" title="Moniteur Système">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#1e40af" stroke-width="2">
        <path d="M18 20V10"></path>
        <path d="M12 20V4"></path>
        <path d="M6 20v-6"></path>
      </svg>
    </div>
    <div class="dock-item" onclick="WebOS.Apps.OSINT.open()" title="OSINT Intelligence">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2.5">
        <circle cx="12" cy="12" r="10"/>
        <circle cx="12" cy="12" r="6"/>
        <circle cx="12" cy="12" r="2"/>
        <line x1="12" y1="2" x2="12" y2="6"/>
        <line x1="12" y1="18" x2="12" y2="22"/>
        <line x1="2" y1="12" x2="6" y2="12"/>
        <line x1="18" y1="12" x2="22" y2="12"/>
      </svg>
    </div>
    <div class="dock-item" onclick="WebOS.Apps.Messages.open()" title="Messages" id="dock-messages" style="position: relative;">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        <circle cx="9" cy="10" r="1" fill="#10b981"/>
        <circle cx="12" cy="10" r="1" fill="#10b981"/>
        <circle cx="15" cy="10" r="1" fill="#10b981"/>
      </svg>
    </div>
    <div class="dock-item" onclick="WebOS.Apps.Mail.open()" title="Courriel" id="dock-mail" style="position: relative;">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
        <polyline points="22,6 12,13 2,6"></polyline>
      </svg>
    </div>
  </div>

  <!-- Import Maps for ES Modules with CDN Fallback -->
  <script type="importmap">
  {
    "imports": {
      "@supabase/supabase-js": "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm",
      "@mlc-ai/web-llm": "https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.79/+esm"
    }
  }
  </script>

  <!-- Main Application Code -->
  <script type="module">
    // ============================================
    // CONFIGURATION
    // ============================================
    const CONFIG = {
      supabase: {
        url: 'https://gwcpuwihjouusnohkmcy.supabase.co',
        anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3Y3B1d2loam91dXNub2hrbWN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxODU1MTAsImV4cCI6MjA3Nzc2MTUxMH0.E9cDmyAmHvcIVNbvzBV7MKlqpLchAME9i2JKwNcuPO4'
      },
      webllm: {
        model: 'Llama-3.2-3B-Instruct-q4f32_1-MLC',
        temperature: 0.7,
        topP: 0.95,
        maxTokens: 2048,
        contextWindow: 8192
      }
    };

    // ============================================
    // WORKER DEFINITIONS - L'ADN DU SYSTÈME CELLULAIRE v4
    // Architecture Multi-Processus: Chaque worker est défini comme template literal
    // puis matérialisé dynamiquement via Blob URLs par le Kernel
    // ============================================
    const WorkerDefinitions = {
      'database-module': `
        // DATABASE MODULE WORKER - Local-First CRDT avec Yjs
        console.log('[DatabaseModule] Worker démarré');

        let db = {
          emails: new Map(),
          messages: new Map(),
          conversations: new Map(),
          files: new Map(),
          contacts: new Map()
        };

        let persistenceEnabled = true;
        let changeCounter = 0;
        const SNAPSHOT_INTERVAL = 50;

        self.onmessage = async (e) => {
          const { id, action, data } = e.data;

          try {
            let result = null;

            switch(action) {
              case 'init':
                console.log('[DatabaseModule] Initialisation de la base de données locale CRDT');
                result = {
                  success: true,
                  message: 'Database CRDT initialisée',
                  collections: Object.keys(db)
                };
                break;

              case 'set':
                const { collection, key, value } = data;
                if (!db[collection]) {
                  throw new Error(\`Collection inconnue: \${collection}\`);
                }
                db[collection].set(key, value);
                changeCounter++;

                if (changeCounter >= SNAPSHOT_INTERVAL) {
                  self.postMessage({
                    type: 'event',
                    event: 'db:snapshot',
                    data: { timestamp: Date.now(), changes: changeCounter }
                  });
                  changeCounter = 0;
                }

                self.postMessage({
                  type: 'event',
                  event: 'db:updated',
                  data: { collection, key, timestamp: Date.now() }
                });

                result = { success: true };
                break;

              case 'get':
                const getCol = data.collection;
                const getKey = data.key;
                if (!db[getCol]) {
                  throw new Error(\`Collection inconnue: \${getCol}\`);
                }
                result = db[getCol].get(getKey) || null;
                break;

              case 'query':
                const queryCol = data.collection;
                const filters = data.filters || {};
                if (!db[queryCol]) {
                  throw new Error(\`Collection inconnue: \${queryCol}\`);
                }

                let items = Array.from(db[queryCol].values());

                if (filters.limit) {
                  items = items.slice(0, filters.limit);
                }

                result = items;
                break;

              case 'delete':
                const delCol = data.collection;
                const delKey = data.key;
                if (!db[delCol]) {
                  throw new Error(\`Collection inconnue: \${delCol}\`);
                }
                db[delCol].delete(delKey);
                result = { success: true };
                break;

              case 'clear':
                const clearCol = data.collection;
                if (!db[clearCol]) {
                  throw new Error(\`Collection inconnue: \${clearCol}\`);
                }
                db[clearCol].clear();
                result = { success: true };
                break;

              case 'stats':
                result = {
                  collections: Object.keys(db).map(name => ({
                    name,
                    size: db[name].size
                  })),
                  totalChanges: changeCounter
                };
                break;

              default:
                throw new Error(\`Action inconnue: \${action}\`);
            }

            self.postMessage({ id, success: true, result });
          } catch (error) {
            console.error('[DatabaseModule] Erreur:', error);
            self.postMessage({ id, success: false, error: error.message });
          }
        };
      `,

      'sync-provider': `
        // SYNC PROVIDER WORKER - Synchronisation Multi-Canal
        console.log('[SyncProvider] Worker démarré');

        let isOnline = false;
        let syncInterval = null;
        let discoveryChannel = null;
        let peerId = null;
        let connectedPeers = new Set();

        self.onmessage = async (e) => {
          const { id, action, data } = e.data;

          try {
            let result = null;

            switch(action) {
              case 'start':
                console.log('[SyncProvider] Démarrage de la synchronisation');
                isOnline = true;
                peerId = self.crypto.randomUUID();

                syncInterval = setInterval(() => {
                  self.postMessage({
                    type: 'event',
                    event: 'sync:heartbeat',
                    data: {
                      status: 'syncing',
                      timestamp: Date.now(),
                      peers: connectedPeers.size
                    }
                  });
                }, 5000);

                try {
                  discoveryChannel = new BroadcastChannel('wosq-p2p-discovery');

                  discoveryChannel.onmessage = (event) => {
                    if (event.data.type === 'peer-announce' && event.data.peerId !== peerId) {
                      connectedPeers.add(event.data.peerId);
                      self.postMessage({
                        type: 'event',
                        event: 'peer:discovered',
                        data: { peerId: event.data.peerId }
                      });
                    }
                  };

                  setInterval(() => {
                    discoveryChannel.postMessage({
                      type: 'peer-announce',
                      peerId: peerId,
                      timestamp: Date.now()
                    });
                  }, 10000);

                  discoveryChannel.postMessage({
                    type: 'peer-announce',
                    peerId: peerId,
                    timestamp: Date.now()
                  });

                  console.log('[SyncProvider] Découverte P2P activée, peerId:', peerId);
                } catch (err) {
                  console.warn('[SyncProvider] BroadcastChannel non disponible:', err);
                }

                result = { success: true, peerId };
                break;

              case 'stop':
                console.log('[SyncProvider] Arrêt de la synchronisation');
                if (syncInterval) {
                  clearInterval(syncInterval);
                  syncInterval = null;
                }
                if (discoveryChannel) {
                  discoveryChannel.close();
                  discoveryChannel = null;
                }
                isOnline = false;
                connectedPeers.clear();
                result = { success: true };
                break;

              case 'status':
                result = {
                  online: isOnline,
                  peerId,
                  connectedPeers: connectedPeers.size,
                  lastSync: Date.now()
                };
                break;

              default:
                throw new Error(\`Action inconnue: \${action}\`);
            }

            self.postMessage({ id, success: true, result });
          } catch (error) {
            console.error('[SyncProvider] Erreur:', error);
            self.postMessage({ id, success: false, error: error.message });
          }
        };
      `,

      'ai-orchestrator': `
        // AI ORCHESTRATOR WORKER - Agent Intelligent avec Tool-Use
        console.log('[AI Orchestrator] Worker démarré');

        let aiReady = false;
        let model = null;
        let conversationHistory = [];

        const toolRegistry = {
          'mail-service': {
            description: 'Gère les emails: lire, envoyer, rechercher dans la boîte de réception',
            actions: ['list', 'get', 'send', 'search']
          },
          'messages-service': {
            description: 'Gère les conversations et messages instantanés',
            actions: ['list', 'get', 'send']
          },
          'osint-service': {
            description: 'Effectue des recherches OSINT et synthèse d\\'information',
            actions: ['search', 'analyze']
          },
          'file-service': {
            description: 'Gestion du système de fichiers: lecture, écriture, navigation',
            actions: ['list', 'read', 'write', 'delete']
          }
        };

        self.onmessage = async (e) => {
          const { id, action, data } = e.data;

          try {
            let result = null;

            switch(action) {
              case 'init':
                console.log('[AI Orchestrator] Initialisation du modèle...');

                for (let progress = 0; progress <= 100; progress += 10) {
                  await new Promise(resolve => setTimeout(resolve, 200));
                  self.postMessage({
                    type: 'event',
                    event: 'ai:loading',
                    data: {
                      progress,
                      message: \`Chargement du modèle: \${progress}%\`
                    }
                  });
                }

                aiReady = true;
                self.postMessage({
                  type: 'event',
                  event: 'ai:ready',
                  data: { ready: true, tools: Object.keys(toolRegistry) }
                });

                result = { success: true, ready: true };
                break;

              case 'generate':
                if (!aiReady) {
                  throw new Error('IA non initialisée. Veuillez appeler init() d\\'abord.');
                }

                const { prompt, context } = data;
                console.log('[AI Orchestrator] Génération pour:', prompt);

                conversationHistory.push({ role: 'user', content: prompt });

                const requiredTools = detectRequiredTools(prompt);

                if (requiredTools.length > 0) {
                  console.log('[AI Orchestrator] Outils détectés:', requiredTools.map(t => t.service));

                  for (const tool of requiredTools) {
                    self.postMessage({
                      type: 'tool_call',
                      tool: tool.service,
                      action: tool.action,
                      params: tool.params
                    });
                  }
                }

                const response = generateResponse(prompt, requiredTools, context);
                conversationHistory.push({ role: 'assistant', content: response });

                result = {
                  response,
                  usedTools: requiredTools.map(t => t.service),
                  confidence: 0.85
                };
                break;

              case 'reset':
                conversationHistory = [];
                result = { success: true };
                break;

              case 'status':
                result = {
                  ready: aiReady,
                  conversationLength: conversationHistory.length,
                  availableTools: Object.keys(toolRegistry)
                };
                break;

              default:
                throw new Error(\`Action inconnue: \${action}\`);
            }

            self.postMessage({ id, success: true, result });
          } catch (error) {
            console.error('[AI Orchestrator] Erreur:', error);
            self.postMessage({ id, success: false, error: error.message });
          }
        };

        function detectRequiredTools(prompt) {
          const tools = [];
          const lowerPrompt = prompt.toLowerCase();

          if (lowerPrompt.includes('email') || lowerPrompt.includes('courriel') || lowerPrompt.includes('mail')) {
            tools.push({
              service: 'mail-service',
              action: 'list',
              params: { limit: 10 }
            });
          }

          if (lowerPrompt.includes('message') || lowerPrompt.includes('conversation')) {
            tools.push({
              service: 'messages-service',
              action: 'list',
              params: {}
            });
          }

          if (lowerPrompt.includes('recherche') || lowerPrompt.includes('osint') || lowerPrompt.includes('chercher')) {
            const queryMatch = lowerPrompt.match(/recherche[r]?\\s+["']?([^"']+)["']?/i);
            tools.push({
              service: 'osint-service',
              action: 'search',
              params: { query: queryMatch ? queryMatch[1] : '' }
            });
          }

          if (lowerPrompt.includes('fichier') || lowerPrompt.includes('document')) {
            tools.push({
              service: 'file-service',
              action: 'list',
              params: {}
            });
          }

          return tools;
        }

        function generateResponse(prompt, tools, context) {
          let response = \`Analyse de votre requête: "\${prompt}"\`;

          if (tools.length > 0) {
            response += \`\\n\\nJ'ai identifié que je dois utiliser les services suivants: \${tools.map(t => t.service).join(', ')}.\`;
            response += \`\\n\\nJe suis en train de récupérer les informations nécessaires...\`;
          } else {
            response += \`\\n\\nJe peux vous aider avec les emails, messages, recherches OSINT, et la gestion de fichiers. Que souhaitez-vous faire?\`;
          }

          return response;
        }
      `,

      'mail-service': `
        // MAIL SERVICE WORKER - Gestion des emails
        console.log('[MailService] Worker démarré');

        let emailCache = new Map();

        self.onmessage = async (e) => {
          const { id, action, data } = e.data;

          try {
            let result = null;

            switch(action) {
              case 'list':
                const limit = data?.limit || 20;
                result = Array.from(emailCache.values()).slice(0, limit);
                break;

              case 'get':
                result = emailCache.get(data.id) || null;
                break;

              case 'send':
                console.log('[MailService] Envoi email:', data);
                result = { success: true, messageId: Date.now() };
                break;

              case 'search':
                const query = data.query?.toLowerCase() || '';
                result = Array.from(emailCache.values()).filter(email =>
                  email.subject?.toLowerCase().includes(query) ||
                  email.from?.toLowerCase().includes(query)
                );
                break;

              default:
                throw new Error(\`Action inconnue: \${action}\`);
            }

            self.postMessage({ id, success: true, result });
          } catch (error) {
            self.postMessage({ id, success: false, error: error.message });
          }
        };
      `,

      'messages-service': `
        // MESSAGES SERVICE WORKER - Gestion des conversations
        console.log('[MessagesService] Worker démarré');

        let conversationsCache = new Map();

        self.onmessage = async (e) => {
          const { id, action, data } = e.data;

          try {
            let result = null;

            switch(action) {
              case 'list':
                result = Array.from(conversationsCache.values());
                break;

              case 'get':
                result = conversationsCache.get(data.id) || null;
                break;

              case 'send':
                console.log('[MessagesService] Envoi message:', data);
                result = { success: true, messageId: Date.now() };
                break;

              default:
                throw new Error(\`Action inconnue: \${action}\`);
            }

            self.postMessage({ id, success: true, result });
          } catch (error) {
            self.postMessage({ id, success: false, error: error.message });
          }
        };
      `,

      'osint-service': `
        // OSINT SERVICE WORKER - Recherche et analyse
        console.log('[OSINTService] Worker démarré');

        self.onmessage = async (e) => {
          const { id, action, data } = e.data;

          try {
            let result = null;

            switch(action) {
              case 'search':
                console.log('[OSINTService] Recherche:', data.query);
                await new Promise(resolve => setTimeout(resolve, 1000));

                result = {
                  query: data.query,
                  results: [
                    {
                      title: 'Résultat OSINT 1',
                      source: 'Source Alpha',
                      score: 0.95,
                      timestamp: Date.now()
                    },
                    {
                      title: 'Résultat OSINT 2',
                      source: 'Source Beta',
                      score: 0.87,
                      timestamp: Date.now()
                    }
                  ],
                  synthesis: \`Synthèse de la recherche pour: \${data.query}\`
                };
                break;

              case 'analyze':
                result = {
                  analysis: 'Analyse effectuée',
                  confidence: 0.82
                };
                break;

              default:
                throw new Error(\`Action inconnue: \${action}\`);
            }

            self.postMessage({ id, success: true, result });
          } catch (error) {
            self.postMessage({ id, success: false, error: error.message });
          }
        };
      `,

      'file-service': `
        // FILE SERVICE WORKER - Gestion OPFS
        console.log('[FileService] Worker démarré');

        self.onmessage = async (e) => {
          const { id, action, data } = e.data;

          try {
            let result = null;

            switch(action) {
              case 'list':
                result = [
                  { name: 'document.txt', size: 1234, modified: Date.now() },
                  { name: 'data.json', size: 5678, modified: Date.now() }
                ];
                break;

              case 'read':
                result = { content: 'Contenu du fichier simulé' };
                break;

              case 'write':
                console.log('[FileService] Écriture fichier:', data.path);
                result = { success: true };
                break;

              case 'delete':
                console.log('[FileService] Suppression fichier:', data.path);
                result = { success: true };
                break;

              default:
                throw new Error(\`Action inconnue: \${action}\`);
            }

            self.postMessage({ id, success: true, result });
          } catch (error) {
            self.postMessage({ id, success: false, error: error.message });
          }
        };
      `,

      'notification-service': `
        // NOTIFICATION SERVICE WORKER - Notifications centralisées
        console.log('[NotificationService] Worker démarré');

        let notifications = [];

        self.onmessage = async (e) => {
          const { id, action, data } = e.data;

          try {
            let result = null;

            switch(action) {
              case 'send':
                const notification = {
                  id: Date.now(),
                  title: data.title,
                  message: data.message,
                  priority: data.priority || 'info',
                  timestamp: Date.now()
                };
                notifications.push(notification);

                self.postMessage({
                  type: 'event',
                  event: 'notification:new',
                  data: notification
                });

                result = { success: true, notificationId: notification.id };
                break;

              case 'list':
                result = notifications;
                break;

              case 'clear':
                notifications = [];
                result = { success: true };
                break;

              default:
                throw new Error(\`Action inconnue: \${action}\`);
            }

            self.postMessage({ id, success: true, result });
          } catch (error) {
            self.postMessage({ id, success: false, error: error.message });
          }
        };
      `
    };

    console.log('[WOSQ v4] WorkerDefinitions chargées:', Object.keys(WorkerDefinitions));

    setInterval(() => {
      const b = document.getElementById("sovereignBadge");
      if (!b) return;
      const online = navigator.onLine;
      b.firstElementChild.style.background = online ? "#f97316" : "#22c55e";
      b.lastElementChild.textContent = online ? "Souverain · Liaison" : "Souverain · Offline";
    }, 4000);

    const AIBus = {
      state: {
        localReady: false,
        lastError: null,
        retryCount: 0,
        maxRetries: 3
      },
      async loadWebLLMWithRetry(retryDelay = 2000) {
        const cdnUrls = [
          'https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.79/+esm',
          'https://esm.run/@mlc-ai/web-llm@0.2.79',
          'https://unpkg.com/@mlc-ai/web-llm@0.2.79/lib/index.js'
        ];

        for (let i = 0; i < cdnUrls.length; i++) {
          try {
            console.log(`[AI] Attempting to load from CDN ${i + 1}/${cdnUrls.length}:`, cdnUrls[i]);
            const module = await import(cdnUrls[i]);
            console.log('[AI] Successfully loaded WebLLM from:', cdnUrls[i]);
            return module;
          } catch (err) {
            console.warn(`[AI] Failed to load from CDN ${i + 1}:`, err.message);
            if (i < cdnUrls.length - 1) {
              console.log(`[AI] Retrying with next CDN in ${retryDelay}ms...`);
              await new Promise(resolve => setTimeout(resolve, retryDelay));
            }
          }
        }
        throw new Error('All CDN attempts failed. Please check your internet connection and try again.');
      },
      async checkBrowserCapabilities() {
        const issues = [];

        if (typeof WebAssembly === 'undefined') {
          issues.push('WebAssembly not supported');
        }

        if (!navigator.gpu) {
          issues.push('WebGPU not supported - AI features will not work in this browser');
        }

        if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
          issues.push('HTTPS required for WebGPU');
        }

        if (!window.crossOriginIsolated) {
          console.warn('[AI] Cross-origin isolation not enabled - this may affect performance');
        }

        return issues;
      },
      async init() {
        const statusEl = document.getElementById("aiStatus");
        try {
          if (statusEl) {
            statusEl.textContent = "IA: vérification du navigateur...";
            statusEl.style.color = '#f59e0b';
          }

          const issues = await this.checkBrowserCapabilities();
          if (issues.length > 0) {
            const errorMsg = 'Incompatibilité détectée: ' + issues.join(', ');
            console.error('[AI]', errorMsg);
            throw new Error(errorMsg);
          }

          if (statusEl) statusEl.textContent = "IA: chargement du module...";

          const { CreateMLCEngine } = await this.loadWebLLMWithRetry();

          if (statusEl) statusEl.textContent = "IA: téléchargement du modèle...";

          const loadTimeout = setTimeout(() => {
            if (statusEl && !this.state.localReady) {
              statusEl.textContent = "IA: téléchargement (peut prendre plusieurs minutes)...";
            }
          }, 5000);

          console.log('[AI] Initializing model:', CONFIG.webllm.model);
          console.log('[AI] Browser:', navigator.userAgent);
          console.log('[AI] WebGPU available:', !!navigator.gpu);

          this.engine = await CreateMLCEngine(CONFIG.webllm.model, {
            initProgressCallback: (p) => {
              if (statusEl) {
                const percent = Math.floor(p.progress * 100);
                statusEl.textContent = `IA: ${p.text || 'téléchargement'} ${percent}%`;
                statusEl.style.color = '#f59e0b';
              }
              console.log(`[AI] Progress: ${Math.floor(p.progress * 100)}% - ${p.text}`);
            },
            logLevel: 'INFO'
          });

          clearTimeout(loadTimeout);
          this.state.localReady = true;
          if (statusEl) {
            statusEl.textContent = "IA: locale prête ✓";
            statusEl.style.color = '#10b981';
          }
          console.log('✓ IA locale initialisée avec succès');
        } catch (err) {
          console.error('⚠ IA locale indisponible:', err);
          console.error('[AI] Full error details:', err.message, err.stack);
          this.state.lastError = err.message;
          if (statusEl) {
            statusEl.textContent = "IA: erreur - " + (err.message.length > 50 ? err.message.substring(0, 50) + '...' : err.message);
            statusEl.style.color = '#ef4444';
            statusEl.title = err.message;
          }
        }
      },
      async chat(prompt) {
        if (this.state.localReady && this.engine) {
          try {
            return await this.engine.chat.completions.create({
              messages: [{ role: "user", content: prompt }]
            });
          } catch (err) {
            console.warn('⚠ Erreur lors de la génération IA:', err.message);
            return this.fallbackResponse();
          }
        }
        return this.fallbackResponse();
      },
      fallbackResponse() {
        return {
          choices: [{
            message: {
              role: "assistant",
              content: "ℹ️ L'IA locale est temporairement indisponible.\n\n" +
                      "Le système WebOS Québec reste pleinement opérationnel en mode souverain.\n\n" +
                      "Note: Le téléchargement du modèle Llama 3.2 nécessite une connexion internet stable et peut prendre plusieurs minutes (environ 2 GB)."
            }
          }]
        };
      }
    };

    AIBus.init();

    // ============================================
    // ADVANCED FILE MANAGER
    // ============================================
    window.AdvancedFileManager = {
      getFileIcon(ext) {
        const iconMap = {
          'txt': 'T', 'md': 'M', 'json': 'J', 'xml': 'X', 'html': 'H',
          'csv': 'C', 'pdf': 'P', 'doc': 'D', 'docx': 'D',
          'xls': 'X', 'xlsx': 'X', 'ppt': 'P', 'pptx': 'P',
          'jpg': 'I', 'jpeg': 'I', 'png': 'I', 'gif': 'I', 'svg': 'S',
          'zip': 'Z', 'rar': 'R'
        };
        return iconMap[ext] || 'F';
      },

      getFileColor(ext) {
        const colors = {
          'txt': '#6b7280', 'md': '#3b82f6', 'json': '#f59e0b', 'xml': '#8b5cf6',
          'html': '#10b981', 'csv': '#10b981', 'pdf': '#ef4444',
          'doc': '#3b82f6', 'docx': '#3b82f6', 'xls': '#10b981', 'xlsx': '#10b981',
          'jpg': '#ec4899', 'png': '#ec4899', 'gif': '#ec4899'
        };
        return colors[ext] || '#6b7280';
      },

      async handleFileImport(event) {
        const files = event.target.files;
        for (const file of files) {
          const result = await FileSystem.importFile(file);
          if (result.success) {
            await Notifications.createNotification(
              'Fichier importé',
              `${file.name} (${FileSystem.formatFileSize(file.size)})`,
              'success',
              'files'
            );
          }
        }
        Apps.Files.refresh();
        event.target.value = '';
      },

      handleDragOver(event) {
        event.preventDefault();
        event.stopPropagation();
        event.currentTarget.style.borderColor = '#3b82f6';
        event.currentTarget.style.background = '#eff6ff';
      },

      handleDragLeave(event) {
        event.preventDefault();
        event.stopPropagation();
        event.currentTarget.style.borderColor = '#d1d5db';
        event.currentTarget.style.background = '#fafafa';
      },

      async handleDrop(event) {
        event.preventDefault();
        event.stopPropagation();

        event.currentTarget.style.borderColor = '#d1d5db';
        event.currentTarget.style.background = '#fafafa';

        const files = event.dataTransfer.files;
        for (const file of files) {
          const result = await FileSystem.importFile(file);
          if (result.success) {
            await Notifications.createNotification(
              'Fichier déposé',
              `${file.name} importé avec succès`,
              'success',
              'files'
            );
          }
        }
        Apps.Files.refresh();
      },

      showExportMenu(filename) {
        const content = `
          <div style="padding: 20px;">
            <h3 style="margin-bottom: 20px; color: #1f2937;">Exporter: ${filename}</h3>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
              <button class="btn" onclick="AdvancedFileManager.exportAs('${filename}', null)" style="background: #3b82f6;">
                Format original
              </button>
              <button class="btn" onclick="AdvancedFileManager.exportAs('${filename}', 'txt')" style="background: #6b7280;">
                Texte (.txt)
              </button>
              <button class="btn" onclick="AdvancedFileManager.exportAs('${filename}', 'json')" style="background: #f59e0b;">
                JSON (.json)
              </button>
              <button class="btn" onclick="AdvancedFileManager.exportAs('${filename}', 'csv')" style="background: #10b981;">
                CSV (.csv)
              </button>
              <button class="btn" onclick="AdvancedFileManager.exportAs('${filename}', 'xml')" style="background: #8b5cf6;">
                XML (.xml)
              </button>
              <button class="btn" onclick="AdvancedFileManager.exportAs('${filename}', 'html')" style="background: #06b6d4;">
                HTML (.html)
              </button>
            </div>

            <button class="btn" onclick="WebOS.WindowManager.close('export-menu')" style="margin-top: 20px; background: #ef4444;">
              Annuler
            </button>
          </div>
        `;

        WindowManager.create('export-menu', 'Exporter le fichier', content, { width: 400, height: 350 });
      },

      async exportAs(filename, format) {
        await FileSystem.exportFile(filename, format);
        WindowManager.close('export-menu');
        await Notifications.createNotification(
          'Fichier exporté',
          `${filename} exporté avec succès`,
          'success',
          'files'
        );
      },

      generateFileListHTML(files) {
        if (files.length === 0) {
          return '<p style="color: #6b7280; text-align: center; padding: 40px;">Aucun fichier<br><span style="font-size: 14px;">Importez ou glissez-déposez des fichiers pour commencer</span></p>';
        }

        return files.map(f => {
          const icon = this.getFileIcon(f.extension);
          const color = this.getFileColor(f.extension);

          return `
            <div class="file-item" style="display: flex; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; background: white;"
                 onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#3b82f6';"
                 onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb';">
              <div style="flex: 1; display: flex; align-items: center; gap: 12px;" onclick="AdvancedFileManager.openFile('${f.name}')">
                <div style="width: 40px; height: 40px; border-radius: 8px; background: ${color}; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px;">${icon}</div>
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #1f2937; font-size: 15px;">${f.name}</div>
                  <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">
                    <span style="font-weight: 500;">${f.sizeFormatted}</span> •
                    <span>${f.lastModified.toLocaleDateString('fr-CA', {year: 'numeric', month: 'short', day: 'numeric'})}</span> •
                    <span style="text-transform: uppercase; font-weight: 600; color: ${color};">${f.extension}</span>
                  </div>
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                ${f.extension === 'html' || f.extension === 'htm' ? `
                  <button class="btn" style="width: auto; padding: 8px 14px; font-size: 13px; background: #f97316;"
                          onclick="event.stopPropagation(); WebOS.Apps.HTMLEditor.openFile('${f.name}')" title="Ouvrir avec HTML Editor">
                    ⚡
                  </button>
                ` : ''}
                <button class="btn" style="width: auto; padding: 8px 14px; font-size: 13px; background: #10b981;"
                        onclick="event.stopPropagation(); AdvancedFileManager.showExportMenu('${f.name}')">
                  ⬇ Exporter
                </button>
                <button class="btn" style="width: auto; padding: 8px 14px; font-size: 13px; background: #ef4444;"
                        onclick="event.stopPropagation(); AdvancedFileManager.deleteFile('${f.name}')">
                  🗑
                </button>
              </div>
            </div>
          `;
        }).join('');
      },

      async openFile(name) {
        const preview = await FileSystem.getFilePreview(name);
        const ext = name.split('.').pop().toLowerCase();

        if (preview.type === 'image') {
          const content = `
            <div style="height: 100%; display: flex; flex-direction: column; align-items: center; padding: 20px; background: #fafafa;">
              <img src="${preview.url}" style="max-width: 100%; max-height: 70%; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);" />
              <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn" onclick="AdvancedFileManager.showExportMenu('${name}')" style="background: #10b981;">
                  ⬇ Exporter
                </button>
                <button class="btn" onclick="AdvancedFileManager.deleteFile('${name}')" style="background: #ef4444;">
                  🗑 Supprimer
                </button>
              </div>
            </div>
          `;
          WindowManager.create(`file-${name}`, name, content, { width: 800, height: 700 });
        } else if (ext === 'html' || ext === 'htm') {
          const content = await FileSystem.readFile(name);
          const escapedContent = content ? content.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$') : '';
          const htmlViewerContent = `
            <div style="height: 100%; display: flex; flex-direction: column;">
              <div style="display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; align-items: center;">
                <button class="btn" style="width: auto; padding: 8px 16px; font-size: 14px; background: #f97316; font-weight: 600;" onclick="WebOS.WindowManager.close('file-${name}'); WebOS.Apps.HTMLEditor.openFile('${name}')" title="Ouvrir avec HTML Editor avancé">
                  ⚡ HTML Editor
                </button>
                <div style="width: 1px; height: 24px; background: #e5e7eb;"></div>
                <button class="btn" id="toggleViewMode-${name}" style="width: auto; padding: 8px 16px; font-size: 14px; background: #8b5cf6;" onclick="AdvancedFileManager.toggleViewMode('${name}')">
                  👁 Aperçu
                </button>
                <button class="btn" style="width: auto; padding: 8px 16px; font-size: 14px; background: #10b981;" onclick="AdvancedFileManager.saveFile('${name}')">
                  💾 Enregistrer
                </button>
                <button class="btn" style="width: auto; padding: 8px 16px; font-size: 14px; background: #06b6d4;" onclick="AdvancedFileManager.refreshPreview('${name}')">
                  🔄 Rafraîchir
                </button>
                <button class="btn" style="width: auto; padding: 8px 16px; font-size: 14px; background: #f59e0b;" onclick="AdvancedFileManager.clearConsole('${name}')">
                  🧹 Console
                </button>
                <button class="btn" style="width: auto; padding: 8px 16px; font-size: 14px; background: #3b82f6;" onclick="AdvancedFileManager.showExportMenu('${name}')">
                  ⬇ Exporter
                </button>
                <button class="btn" style="width: auto; padding: 8px 16px; font-size: 14px; background: #ef4444;" onclick="AdvancedFileManager.deleteFile('${name}')">
                  🗑 Supprimer
                </button>
              </div>
              <div id="codeView-${name}" style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                <textarea id="fileEditor-${name}" style="flex: 1; padding: 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6; resize: none;">${escapedContent}</textarea>
              </div>
              <div id="previewView-${name}" style="flex: 1; display: none; flex-direction: column; gap: 8px;">
                <div style="flex: 1; border: 2px solid #e5e7eb; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; background: white;">
                  <iframe id="htmlPreview-${name}" style="flex: 1; border: none; background: white;"></iframe>
                </div>
                <div id="consoleView-${name}" style="height: 180px; background: #1e293b; border: 2px solid #334155; border-radius: 8px; padding: 12px; font-family: 'Courier New', monospace; font-size: 12px; color: #e2e8f0; overflow-y: auto; line-height: 1.5;">
                  <div style="color: #94a3b8; margin-bottom: 8px;">📟 Console JavaScript Live</div>
                </div>
              </div>
            </div>
          `;
          WindowManager.create(`file-${name}`, name, htmlViewerContent, { width: 1200, height: 800 });

          setTimeout(() => {
            AdvancedFileManager.setupHTMLPreview(name, content);
          }, 100);
        } else if (preview.type === 'text') {
          const content = await FileSystem.readFile(name);
          const editorContent = `
            <div style="height: 100%; display: flex; flex-direction: column;">
              <div style="display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap;">
                <button class="btn" style="width: auto; padding: 8px 16px; font-size: 14px; background: #10b981;" onclick="AdvancedFileManager.saveFile('${name}')">
                  💾 Enregistrer
                </button>
                <button class="btn" style="width: auto; padding: 8px 16px; font-size: 14px; background: #3b82f6;" onclick="AdvancedFileManager.showExportMenu('${name}')">
                  ⬇ Exporter
                </button>
                <button class="btn" style="width: auto; padding: 8px 16px; font-size: 14px; background: #ef4444;" onclick="AdvancedFileManager.deleteFile('${name}')">
                  🗑 Supprimer
                </button>
              </div>
              <textarea id="fileEditor" style="flex: 1; padding: 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.6; resize: none;">${content || ''}</textarea>
            </div>
          `;
          WindowManager.create(`file-${name}`, name, editorContent, { width: 900, height: 650 });
        } else {
          alert(preview.message || 'Impossible d\'ouvrir ce fichier');
        }
      },

      async saveFile(name) {
        const editor = document.getElementById('fileEditor-' + name) || document.getElementById('fileEditor');
        if (!editor) return;
        const content = editor.value;
        await FileSystem.writeFile(name, content);
        await Notifications.createNotification(
          'Fichier enregistré',
          name,
          'success',
          'files'
        );
      },

      async deleteFile(name) {
        if (confirm(`Supprimer définitivement le fichier "${name}"?`)) {
          await FileSystem.deleteFile(name);
          WindowManager.close(`file-${name}`);
          await Notifications.createNotification(
            'Fichier supprimé',
            name,
            'info',
            'files'
          );
          Apps.Files.refresh();
        }
      },

      setupHTMLPreview(name, content) {
        const iframe = document.getElementById('htmlPreview-' + name);
        const consoleView = document.getElementById('consoleView-' + name);
        if (!iframe || !consoleView) return;

        const addConsoleLog = (type, args, color) => {
          const timestamp = new Date().toLocaleTimeString('fr-CA', { hour12: false });
          const message = Array.from(args).map(arg => {
            if (typeof arg === 'object') {
              try { return JSON.stringify(arg, null, 2); }
              catch (e) { return String(arg); }
            }
            return String(arg);
          }).join(' ');

          const logLine = document.createElement('div');
          logLine.style.cssText = `color: ${color}; margin-bottom: 4px; word-break: break-word;`;
          logLine.innerHTML = `<span style="color: #64748b;">[${timestamp}]</span> ${type}: ${message}`;
          consoleView.appendChild(logLine);
          consoleView.scrollTop = consoleView.scrollHeight;
        };

        const injectionScript = `
(function() {
  try {
    window.NexusApp = window.parent.NexusApp || window.NexusApp || {};
    window.Apps = window.parent.Apps || window.Apps || {};
    window.System = window.parent.System || window.System || {};
    window.Kernel = window.parent.Kernel || window.Kernel || {};
  } catch(e) {
    console.warn("[Preview] Cannot inject parent APIs:", e.message);
  }
})();`;

        let wrappedHTML = content || '';

        if (!wrappedHTML.toLowerCase().includes('<!doctype')) {
          wrappedHTML = '<!DOCTYPE html>\n' + wrappedHTML;
        }

        if (wrappedHTML.toLowerCase().includes('<head>')) {
          wrappedHTML = wrappedHTML.replace(
            /(<head[^>]*>)/i,
            `$1\n<script>${injectionScript}<\/script>`
          );
        } else if (wrappedHTML.toLowerCase().includes('<html>')) {
          wrappedHTML = wrappedHTML.replace(
            /(<html[^>]*>)/i,
            `$1\n<head><script>${injectionScript}<\/script></head>`
          );
        } else {
          wrappedHTML = `<head><script>${injectionScript}<\/script></head>` + wrappedHTML;
        }

        setTimeout(() => {
          try {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(wrappedHTML);
            iframeDoc.close();

            setTimeout(() => {
              try {
                const iframeWindow = iframe.contentWindow;
                if (!iframeWindow) return;

                if (typeof NexusApp !== 'undefined') {
                  iframeWindow.NexusApp = NexusApp;
                }
                if (typeof Apps !== 'undefined') {
                  iframeWindow.Apps = Apps;
                }
                if (typeof System !== 'undefined') {
                  iframeWindow.System = System;
                }
                if (typeof Kernel !== 'undefined') {
                  iframeWindow.Kernel = Kernel;
                }

                const originalConsole = {
                  log: iframeWindow.console.log,
                  error: iframeWindow.console.error,
                  warn: iframeWindow.console.warn,
                  info: iframeWindow.console.info
                };

                iframeWindow.console.log = function(...args) {
                  addConsoleLog('LOG', args, '#94a3b8');
                  originalConsole.log.apply(iframeWindow.console, args);
                };

                iframeWindow.console.error = function(...args) {
                  addConsoleLog('ERROR', args, '#ef4444');
                  originalConsole.error.apply(iframeWindow.console, args);
                };

                iframeWindow.console.warn = function(...args) {
                  addConsoleLog('WARN', args, '#f59e0b');
                  originalConsole.warn.apply(iframeWindow.console, args);
                };

                iframeWindow.console.info = function(...args) {
                  addConsoleLog('INFO', args, '#3b82f6');
                  originalConsole.info.apply(iframeWindow.console, args);
                };

                iframeWindow.addEventListener('error', (e) => {
                  addConsoleLog('ERROR', [e.message, `at ${e.filename}:${e.lineno}:${e.colno}`], '#ef4444');
                });

                iframeWindow.addEventListener('unhandledrejection', (e) => {
                  addConsoleLog('ERROR', ['Unhandled Promise Rejection:', e.reason], '#ef4444');
                });
              } catch (err) {
                console.warn('[HTMLPreview] Cannot intercept console:', err.message);
              }
            }, 50);
          } catch (err) {
            console.error('[HTMLPreview] Cannot write to iframe:', err);
          }
        }, 0);
      },

      refreshPreview(name) {
        const editor = document.getElementById('fileEditor-' + name);
        if (!editor) return;
        const content = editor.value;
        this.setupHTMLPreview(name, content);
        const consoleView = document.getElementById('consoleView-' + name);
        if (consoleView) {
          const firstChild = consoleView.firstChild;
          consoleView.innerHTML = '';
          if (firstChild) consoleView.appendChild(firstChild);
        }
      },

      clearConsole(name) {
        const consoleView = document.getElementById('consoleView-' + name);
        if (consoleView) {
          consoleView.innerHTML = '<div style="color: #94a3b8; margin-bottom: 8px;">📟 Console JavaScript Live</div>';
        }
      },

      toggleViewMode(name) {
        const codeView = document.getElementById('codeView-' + name);
        const previewView = document.getElementById('previewView-' + name);
        const toggleBtn = document.getElementById('toggleViewMode-' + name);

        if (codeView.style.display === 'none') {
          codeView.style.display = 'flex';
          previewView.style.display = 'none';
          toggleBtn.textContent = '👁 Aperçu';
          toggleBtn.style.background = '#8b5cf6';
        } else {
          const editor = document.getElementById('fileEditor-' + name);
          if (editor) {
            const content = editor.value;
            this.setupHTMLPreview(name, content);
          }
          codeView.style.display = 'none';
          previewView.style.display = 'flex';
          toggleBtn.textContent = '📝 Code';
          toggleBtn.style.background = '#f59e0b';
        }
      }
    };

    // ============================================
    // CORE KERNEL
    // ============================================
    // ============================================
    // KERNEL v4 - Orchestrateur de Processus Cellulaires
    // Gère la création/destruction de Web Workers dynamiques
    // Route les messages inter-processus avec système requête/réponse
    // ============================================
    const Kernel = (() => {
      const eventBus = new EventTarget();
      let processId = 0;
      const processes = new Map();
      const pendingRequests = new Map();
      let requestId = 0;

      return {
        emit(event, data) {
          eventBus.dispatchEvent(new CustomEvent(event, { detail: data }));
        },

        on(event, handler) {
          eventBus.addEventListener(event, (e) => handler(e.detail));
        },

        off(event, handler) {
          eventBus.removeEventListener(event, handler);
        },

        createProcess(workerName, metadata = {}) {
          const pid = `proc_${++processId}`;
          const workerCode = WorkerDefinitions[workerName];

          if (!workerCode) {
            console.error(`[Kernel] Pas de définition pour: ${workerName}`);
            return null;
          }

          console.log(`[Kernel] Création processus ${workerName} (PID: ${pid})`);

          try {
            const blob = new Blob([workerCode], { type: 'application/javascript' });
            const workerUrl = URL.createObjectURL(blob);
            const worker = new Worker(workerUrl);

            worker.onmessage = (e) => this.handleProcessMessage(pid, e.data);
            worker.onerror = (e) => this.handleProcessError(pid, e);

            processes.set(pid, {
              name: workerName,
              pid,
              status: 'running',
              startTime: Date.now(),
              instance: worker,
              metadata,
              messageCount: 0,
              errorCount: 0
            });

            URL.revokeObjectURL(workerUrl);
            this.emit('process:created', { pid, name: workerName });

            return pid;
          } catch (error) {
            console.error(`[Kernel] Erreur création worker ${workerName}:`, error);
            return null;
          }
        },

        handleProcessMessage(pid, message) {
          const process = processes.get(pid);
          if (!process) return;

          process.messageCount++;

          if (message.id && pendingRequests.has(message.id)) {
            const { resolve, reject } = pendingRequests.get(message.id);
            pendingRequests.delete(message.id);

            if (message.success) {
              resolve(message.result);
            } else {
              reject(new Error(message.error));
            }
            return;
          }

          if (message.type === 'event') {
            this.emit(message.event, message.data);
            return;
          }

          if (message.type === 'tool_call') {
            this.handleToolCall(pid, message);
            return;
          }
        },

        handleProcessError(pid, error) {
          const process = processes.get(pid);
          if (!process) return;

          process.errorCount++;
          console.error(`[Kernel] Erreur processus ${process.name} (PID: ${pid}):`, error);
          this.emit('process:error', { pid, name: process.name, error: error.message });
        },

        async sendRequest(pid, action, data = {}) {
          const process = processes.get(pid);
          if (!process) {
            throw new Error(`Processus ${pid} introuvable`);
          }
          if (process.status !== 'running') {
            throw new Error(`Processus ${pid} non actif (statut: ${process.status})`);
          }

          const id = ++requestId;

          return new Promise((resolve, reject) => {
            pendingRequests.set(id, { resolve, reject });

            setTimeout(() => {
              if (pendingRequests.has(id)) {
                pendingRequests.delete(id);
                reject(new Error('Timeout: le processus n\'a pas répondu dans les 30 secondes'));
              }
            }, 30000);

            process.instance.postMessage({ id, action, data });
          });
        },

        async handleToolCall(fromPid, message) {
          console.log(`[Kernel] Tool call depuis ${fromPid}: ${message.tool}.${message.action}`);

          let targetPid = null;
          for (const [pid, process] of processes) {
            if (process.name === message.tool) {
              targetPid = pid;
              break;
            }
          }

          if (!targetPid) {
            console.log(`[Kernel] Création du worker ${message.tool} pour tool call`);
            targetPid = this.createProcess(message.tool);
            if (!targetPid) {
              console.error(`[Kernel] Impossible de créer le worker ${message.tool}`);
              return;
            }
          }

          try {
            const result = await this.sendRequest(targetPid, message.action, message.params);

            const process = processes.get(fromPid);
            if (process) {
              process.instance.postMessage({
                type: 'tool_result',
                tool: message.tool,
                action: message.action,
                result
              });
            }
          } catch (error) {
            console.error(`[Kernel] Erreur tool call ${message.tool}.${message.action}:`, error);
          }
        },

        terminateProcess(pid) {
          const process = processes.get(pid);
          if (!process) {
            console.warn(`[Kernel] Processus ${pid} introuvable pour terminaison`);
            return false;
          }

          console.log(`[Kernel] Terminaison processus ${process.name} (PID: ${pid})`);

          try {
            process.instance.terminate();
            processes.delete(pid);
            this.emit('process:terminated', { pid, name: process.name });
            return true;
          } catch (error) {
            console.error(`[Kernel] Erreur terminaison processus ${pid}:`, error);
            return false;
          }
        },

        killProcess(pid) {
          return this.terminateProcess(pid);
        },

        getProcesses() {
          return Array.from(processes.values()).map(p => ({
            pid: p.pid,
            name: p.name,
            status: p.status,
            uptime: Date.now() - p.startTime,
            messageCount: p.messageCount,
            errorCount: p.errorCount,
            metadata: p.metadata
          }));
        },

        getProcess(pid) {
          const process = processes.get(pid);
          if (!process) return null;

          return {
            pid: process.pid,
            name: process.name,
            status: process.status,
            uptime: Date.now() - process.startTime,
            messageCount: process.messageCount,
            errorCount: process.errorCount,
            metadata: process.metadata
          };
        },

        getProcessByName(name) {
          for (const [pid, process] of processes) {
            if (process.name === name) {
              return this.getProcess(pid);
            }
          }
          return null;
        },

        terminateAll() {
          console.log(`[Kernel] Terminaison de tous les processus (${processes.size})`);
          const pids = Array.from(processes.keys());
          pids.forEach(pid => this.terminateProcess(pid));
        }
      };
    })();

    console.log('[WOSQ v4] Kernel Orchestrateur initialisé');

    // ============================================
    // CONSOLE LOG INTERCEPTOR & LOGGER
    // ============================================
    const Logger = (() => {
      const logs = [];
      const MAX_LOGS = 1000;

      const originalConsole = {
        log: console.log,
        warn: console.warn,
        error: console.error,
        info: console.info,
        debug: console.debug
      };

      function addLog(level, args) {
        const timestamp = new Date();
        const message = args.map(arg => {
          if (typeof arg === 'object' && arg !== null) {
            try {
              if (arg instanceof Error) {
                return `${arg.name}: ${arg.message}`;
              }
              if (arg.constructor && arg.constructor.name && arg.constructor.name !== 'Object') {
                return `[${arg.constructor.name}]`;
              }
              return JSON.stringify(arg, (key, value) => {
                if (typeof value === 'function') return '[Function]';
                if (value instanceof Error) return `${value.name}: ${value.message}`;
                return value;
              }, 2);
            } catch (e) {
              return String(arg);
            }
          }
          return String(arg);
        }).join(' ');

        const logEntry = {
          timestamp,
          level,
          message,
          stackTrace: level === 'error' ? new Error().stack : null
        };

        logs.unshift(logEntry);
        if (logs.length > MAX_LOGS) {
          logs.pop();
        }

        try {
          Kernel.emit('log:added', logEntry);
        } catch (e) {
          originalConsole.error('Logger emit error:', e);
        }
      }

      console.log = function(...args) {
        try {
          addLog('log', args);
        } catch (e) {
          originalConsole.error('[Logger] Error in log:', e);
        }
        originalConsole.log.apply(console, args);
      };

      console.warn = function(...args) {
        try {
          addLog('warn', args);
        } catch (e) {
          originalConsole.error('[Logger] Error in warn:', e);
        }
        originalConsole.warn.apply(console, args);
      };

      console.error = function(...args) {
        try {
          addLog('error', args);
        } catch (e) {
          originalConsole.error('[Logger] Error in error:', e);
        }
        originalConsole.error.apply(console, args);
      };

      console.info = function(...args) {
        try {
          addLog('info', args);
        } catch (e) {
          originalConsole.error('[Logger] Error in info:', e);
        }
        originalConsole.info.apply(console, args);
      };

      console.debug = function(...args) {
        try {
          addLog('debug', args);
        } catch (e) {
          originalConsole.error('[Logger] Error in debug:', e);
        }
        originalConsole.debug.apply(console, args);
      };

      window.addEventListener('error', (event) => {
        addLog('error', [`Uncaught Error: ${event.message}`, `at ${event.filename}:${event.lineno}:${event.colno}`]);
      });

      window.addEventListener('unhandledrejection', (event) => {
        addLog('error', [`Unhandled Promise Rejection: ${event.reason}`]);
      });

      return {
        getLogs() {
          return logs;
        },

        clearLogs() {
          logs.length = 0;
        }
      };
    })();

    // ============================================
    // PERFORMANCE MONITOR
    // ============================================
    const PerformanceMonitor = (() => {
      const metrics = [];
      const marks = new Map();
      let enabled = true;

      function initWebVitals() {
        try {
          if ('PerformanceObserver' in window) {
            const observer = new PerformanceObserver((list) => {
              for (const entry of list.getEntries()) {
                if (entry.entryType === 'largest-contentful-paint') {
                  recordMetric('LCP', entry.startTime, { element: entry.element?.tagName });
                } else if (entry.entryType === 'first-input') {
                  recordMetric('FID', entry.processingStart - entry.startTime, { eventType: entry.name });
                } else if (entry.entryType === 'layout-shift' && !entry.hadRecentInput) {
                  recordMetric('CLS', entry.value);
                }
              }
            });

            observer.observe({ type: 'largest-contentful-paint', buffered: true });
            observer.observe({ type: 'first-input', buffered: true });
            observer.observe({ type: 'layout-shift', buffered: true });
          }

          const navTiming = performance.getEntriesByType('navigation')[0];
          if (navTiming) {
            recordMetric('TTFB', navTiming.responseStart - navTiming.requestStart);
          }
        } catch (error) {
          console.warn('Failed to initialize Web Vitals monitoring:', error);
        }
      }

      function recordMetric(name, duration, metadata) {
        metrics.push({
          name,
          duration,
          timestamp: Date.now(),
          metadata
        });

        if (metrics.length > 1000) {
          metrics.splice(0, 500);
        }

        Kernel.emit('performance:metric', { name, duration, metadata });
      }

      initWebVitals();

      return {
        setEnabled(value) {
          enabled = value;
        },

        isEnabled() {
          return enabled;
        },

        toggleEnabled() {
          enabled = !enabled;
          return enabled;
        },

        start(name) {
          if (!enabled) return;
          if (performance.mark) {
            performance.mark(`${name}-start`);
          }
          marks.set(name, Date.now());
        },

        end(name, metadata) {
          if (!enabled) return;
          const startTime = marks.get(name);
          if (!startTime) return;

          const duration = Date.now() - startTime;
          marks.delete(name);

          if (performance.mark && performance.measure) {
            try {
              performance.mark(`${name}-end`);
              performance.measure(name, `${name}-start`, `${name}-end`);
            } catch (error) {
              console.warn('Failed to create performance measure:', error);
            }
          }

          recordMetric(name, duration, metadata);
        },

        getMetrics() {
          return [...metrics];
        },

        getReport() {
          const nonVitalMetrics = metrics.filter(m => !['LCP', 'FID', 'CLS', 'TTFB'].includes(m.name));

          let totalDuration = 0;
          let slowest = null;
          let fastest = null;

          for (const metric of nonVitalMetrics) {
            totalDuration += metric.duration;
            if (!slowest || metric.duration > slowest.duration) slowest = metric;
            if (!fastest || metric.duration < fastest.duration) fastest = metric;
          }

          const webVitals = {};
          const lcpMetric = metrics.find(m => m.name === 'LCP');
          const fidMetric = metrics.find(m => m.name === 'FID');
          const clsMetric = metrics.find(m => m.name === 'CLS');
          const ttfbMetric = metrics.find(m => m.name === 'TTFB');

          if (lcpMetric) webVitals.lcp = lcpMetric.duration;
          if (fidMetric) webVitals.fid = fidMetric.duration;
          if (clsMetric) webVitals.cls = clsMetric.duration;
          if (ttfbMetric) webVitals.ttfb = ttfbMetric.duration;

          return {
            metrics,
            summary: {
              totalMeasures: nonVitalMetrics.length,
              averageDuration: nonVitalMetrics.length > 0 ? totalDuration / nonVitalMetrics.length : 0,
              slowestOperation: slowest,
              fastestOperation: fastest
            },
            webVitals
          };
        },

        exportReport() {
          return JSON.stringify(this.getReport(), null, 2);
        },

        clear() {
          metrics.length = 0;
          marks.clear();
          if (performance.clearMarks && performance.clearMeasures) {
            performance.clearMarks();
            performance.clearMeasures();
          }
        }
      };
    })();

    // ============================================
    // OPFS SNAPSHOT MANAGER
    // ============================================
    const OPFSSnapshot = (() => {
      const SNAPSHOT_VERSION = '1.0.0';
      const ENCRYPTION_ALGORITHM = 'AES-GCM';
      const KEY_DERIVATION_ALGORITHM = 'PBKDF2';
      const maxSnapshots = 5;

      // Helper pour vérifier le support OPFS
      function isOPFSSupported() {
        return 'storage' in navigator && 'getDirectory' in navigator.storage;
      }

      async function createSnapshot(password) {
        try {
          if (!isOPFSSupported()) {
            console.warn('[OPFSSnapshot] OPFS not supported in this browser');
            return { success: false, error: 'OPFS not supported in this browser' };
          }

          PerformanceMonitor.start('snapshot-create');

          const root = await navigator.storage.getDirectory();
          const files = await collectFiles(root, '');
          const totalSize = files.reduce((sum, f) => sum + f.size, 0);
          const checksum = await calculateChecksum(files);

          const snapshotData = {
            metadata: {
              version: SNAPSHOT_VERSION,
              timestamp: Date.now(),
              fileCount: files.length,
              totalSize,
              checksum
            },
            files
          };

          const serialized = serializeSnapshot(snapshotData);
          snapshotData.metadata.seal = await sealSnapshot(serialized);

          let exportData;
          if (password) {
            const encrypted = await encryptData(serialized, password);
            exportData = {
              encrypted: true,
              data: encrypted.data,
              iv: encrypted.iv,
              salt: encrypted.salt
            };
          } else {
            exportData = {
              encrypted: false,
              data: serialized
            };
          }

          await saveSnapshot(exportData);
          await rotateSnapshots();

          PerformanceMonitor.end('snapshot-create', { fileCount: files.length, size: exportData.data.byteLength });

          return { success: true, size: exportData.data.byteLength, fileCount: files.length };
        } catch (error) {
          console.error('Failed to create snapshot:', error);
          return { success: false, error: error.message };
        }
      }

      async function restoreSnapshot(data, password) {
        try {
          PerformanceMonitor.start('snapshot-restore');

          const exportData = deserializeExportData(data);

          let snapshotBuffer;
          if (exportData.encrypted) {
            if (!password) throw new Error('Password required for encrypted snapshot');
            if (!exportData.iv || !exportData.salt) throw new Error('Invalid encrypted snapshot');
            snapshotBuffer = await decryptData(exportData.data, password, exportData.iv, exportData.salt);
          } else {
            snapshotBuffer = exportData.data;
          }

          const snapshotData = deserializeSnapshot(snapshotBuffer);

          if (snapshotData.metadata && snapshotData.metadata.seal) {
            const rehash = await crypto.subtle.digest("SHA-256", snapshotBuffer);
            const rehashHex = Array.from(new Uint8Array(rehash)).map(b => b.toString(16).padStart(2, "0")).join("");
            if (rehashHex !== snapshotData.metadata.seal.hash) {
              throw new Error("Snapshot altéré ou non authentique (seal mismatch)");
            }
          }

          const calculatedChecksum = await calculateChecksum(snapshotData.files);
          if (calculatedChecksum !== snapshotData.metadata.checksum) {
            throw new Error('Snapshot checksum mismatch - data may be corrupted');
          }

          await restoreFiles(snapshotData.files);

          PerformanceMonitor.end('snapshot-restore', { fileCount: snapshotData.files.length });

          return { success: true, fileCount: snapshotData.files.length };
        } catch (error) {
          console.error('Failed to restore snapshot:', error);
          return { success: false, error: error.message };
        }
      }

      async function exportSnapshot(password) {
        const result = await createSnapshot(password);
        if (!result.success) throw new Error(result.error);

        const snapshots = await listSnapshots();
        if (snapshots.length === 0) throw new Error('No snapshots available');

        const latestSnapshot = snapshots[snapshots.length - 1];
        const snapshotData = await latestSnapshot.arrayBuffer();

        return new Blob([snapshotData], { type: 'application/octet-stream' });
      }

      async function collectFiles(directory, path) {
        const files = [];

        for await (const [name, handle] of directory.entries()) {
          const fullPath = path ? `${path}/${name}` : name;

          if (handle.kind === 'file') {
            const file = await handle.getFile();
            const content = await file.arrayBuffer();
            files.push({ path: fullPath, content, type: file.type, size: file.size });
          } else if (handle.kind === 'directory') {
            const subFiles = await collectFiles(handle, fullPath);
            files.push(...subFiles);
          }
        }

        return files;
      }

      async function restoreFiles(files) {
        if (!isOPFSSupported()) {
          throw new Error('OPFS not supported in this browser');
        }

        const root = await navigator.storage.getDirectory();

        for (const file of files) {
          const pathParts = file.path.split('/');
          const fileName = pathParts.pop();

          let currentDir = root;
          for (const part of pathParts) {
            currentDir = await currentDir.getDirectoryHandle(part, { create: true });
          }

          const fileHandle = await currentDir.getFileHandle(fileName, { create: true });
          const writable = await fileHandle.createWritable();
          await writable.write(file.content);
          await writable.close();
        }
      }

      function serializeSnapshot(snapshot) {
        const encoder = new TextEncoder();
        const metadataJson = JSON.stringify(snapshot.metadata);
        const metadataBytes = encoder.encode(metadataJson);
        const metadataLength = metadataBytes.byteLength;

        const filesData = snapshot.files.map(file => {
          const pathBytes = encoder.encode(file.path);
          const typeBytes = encoder.encode(file.type);
          const header = new Uint32Array([pathBytes.byteLength, typeBytes.byteLength, file.content.byteLength]);
          return { header, pathBytes, typeBytes, content: new Uint8Array(file.content) };
        });

        const totalSize = 4 + metadataLength + filesData.reduce(
          (sum, f) => sum + 12 + f.pathBytes.byteLength + f.typeBytes.byteLength + f.content.byteLength, 0
        );

        const buffer = new ArrayBuffer(totalSize);
        const view = new DataView(buffer);
        const uint8View = new Uint8Array(buffer);

        let offset = 0;
        view.setUint32(offset, metadataLength);
        offset += 4;

        uint8View.set(metadataBytes, offset);
        offset += metadataLength;

        for (const file of filesData) {
          uint8View.set(new Uint8Array(file.header.buffer), offset);
          offset += 12;
          uint8View.set(file.pathBytes, offset);
          offset += file.pathBytes.byteLength;
          uint8View.set(file.typeBytes, offset);
          offset += file.typeBytes.byteLength;
          uint8View.set(file.content, offset);
          offset += file.content.byteLength;
        }

        return buffer;
      }

      function deserializeSnapshot(buffer) {
        const view = new DataView(buffer);
        const uint8View = new Uint8Array(buffer);
        const decoder = new TextDecoder();

        let offset = 0;
        const metadataLength = view.getUint32(offset);
        offset += 4;

        const metadataBytes = uint8View.slice(offset, offset + metadataLength);
        const metadata = JSON.parse(decoder.decode(metadataBytes));
        offset += metadataLength;

        const files = [];
        while (offset < buffer.byteLength) {
          const pathLength = view.getUint32(offset);
          const typeLength = view.getUint32(offset + 4);
          const contentLength = view.getUint32(offset + 8);
          offset += 12;

          const path = decoder.decode(uint8View.slice(offset, offset + pathLength));
          offset += pathLength;

          const type = decoder.decode(uint8View.slice(offset, offset + typeLength));
          offset += typeLength;

          const content = buffer.slice(offset, offset + contentLength);
          offset += contentLength;

          files.push({ path, content, type, size: contentLength });
        }

        return { metadata, files };
      }

      async function encryptData(data, password) {
        const encoder = new TextEncoder();
        const passwordBuffer = encoder.encode(password);
        const salt = crypto.getRandomValues(new Uint8Array(16));

        const keyMaterial = await crypto.subtle.importKey('raw', passwordBuffer, KEY_DERIVATION_ALGORITHM, false, ['deriveBits', 'deriveKey']);

        const key = await crypto.subtle.deriveKey(
          { name: KEY_DERIVATION_ALGORITHM, salt, iterations: 100000, hash: 'SHA-256' },
          keyMaterial,
          { name: ENCRYPTION_ALGORITHM, length: 256 },
          false,
          ['encrypt', 'decrypt']
        );

        const iv = crypto.getRandomValues(new Uint8Array(12));
        const encrypted = await crypto.subtle.encrypt({ name: ENCRYPTION_ALGORITHM, iv }, key, data);

        return { data: encrypted, iv, salt };
      }

      async function decryptData(data, password, iv, salt) {
        const encoder = new TextEncoder();
        const passwordBuffer = encoder.encode(password);

        const keyMaterial = await crypto.subtle.importKey('raw', passwordBuffer, KEY_DERIVATION_ALGORITHM, false, ['deriveBits', 'deriveKey']);

        const key = await crypto.subtle.deriveKey(
          { name: KEY_DERIVATION_ALGORITHM, salt, iterations: 100000, hash: 'SHA-256' },
          keyMaterial,
          { name: ENCRYPTION_ALGORITHM, length: 256 },
          false,
          ['encrypt', 'decrypt']
        );

        return await crypto.subtle.decrypt({ name: ENCRYPTION_ALGORITHM, iv }, key, data);
      }

      async function calculateChecksum(files) {
        const combinedData = new Uint8Array(files.reduce((sum, f) => sum + f.content.byteLength, 0));

        let offset = 0;
        for (const file of files) {
          combinedData.set(new Uint8Array(file.content), offset);
          offset += file.content.byteLength;
        }

        const hashBuffer = await crypto.subtle.digest('SHA-256', combinedData);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
      }

      async function saveSnapshot(data) {
        if (!isOPFSSupported()) {
          console.warn('[OPFSSnapshot] OPFS not supported - cannot save snapshot');
          return;
        }

        const root = await navigator.storage.getDirectory();
        const snapshotsDir = await root.getDirectoryHandle('snapshots', { create: true });

        const timestamp = Date.now();
        const fileName = `snapshot-${timestamp}.webosq`;

        const fileHandle = await snapshotsDir.getFileHandle(fileName, { create: true });
        const writable = await fileHandle.createWritable();

        const serialized = serializeExportData(data);
        await writable.write(serialized);
        await writable.close();
      }

      async function listSnapshots() {
        if (!isOPFSSupported()) {
          console.warn('[OPFSSnapshot] OPFS not supported - cannot list snapshots');
          return [];
        }

        const root = await navigator.storage.getDirectory();

        try {
          const snapshotsDir = await root.getDirectoryHandle('snapshots');
          const snapshots = [];

          for await (const [name, handle] of snapshotsDir.entries()) {
            if (handle.kind === 'file' && name.endsWith('.webosq')) {
              const file = await handle.getFile();
              snapshots.push(file);
            }
          }

          return snapshots.sort((a, b) => a.lastModified - b.lastModified);
        } catch (error) {
          return [];
        }
      }

      async function rotateSnapshots() {
        if (!isOPFSSupported()) {
          console.warn('[OPFSSnapshot] OPFS not supported - cannot rotate snapshots');
          return;
        }

        const snapshots = await listSnapshots();

        if (snapshots.length > maxSnapshots) {
          const root = await navigator.storage.getDirectory();
          const snapshotsDir = await root.getDirectoryHandle('snapshots');

          const toDelete = snapshots.slice(0, snapshots.length - maxSnapshots);
          for (const snapshot of toDelete) {
            try {
              await snapshotsDir.removeEntry(snapshot.name);
            } catch (error) {
              console.warn(`Failed to delete old snapshot ${snapshot.name}:`, error);
            }
          }
        }
      }

      function serializeExportData(data) {
        const encoder = new TextEncoder();
        const header = {
          encrypted: data.encrypted,
          ivLength: data.iv?.byteLength || 0,
          saltLength: data.salt?.byteLength || 0,
          dataLength: data.data.byteLength
        };

        const headerJson = JSON.stringify(header);
        const headerBytes = encoder.encode(headerJson);
        const headerLength = headerBytes.byteLength;

        const totalSize = 4 + headerLength + header.ivLength + header.saltLength + header.dataLength;
        const buffer = new ArrayBuffer(totalSize);
        const view = new DataView(buffer);
        const uint8View = new Uint8Array(buffer);

        let offset = 0;
        view.setUint32(offset, headerLength);
        offset += 4;

        uint8View.set(headerBytes, offset);
        offset += headerLength;

        if (data.iv) {
          uint8View.set(data.iv, offset);
          offset += data.iv.byteLength;
        }

        if (data.salt) {
          uint8View.set(data.salt, offset);
          offset += data.salt.byteLength;
        }

        uint8View.set(new Uint8Array(data.data), offset);

        return buffer;
      }

      function deserializeExportData(buffer) {
        const view = new DataView(buffer);
        const uint8View = new Uint8Array(buffer);
        const decoder = new TextDecoder();

        let offset = 0;
        const headerLength = view.getUint32(offset);
        offset += 4;

        const headerBytes = uint8View.slice(offset, offset + headerLength);
        const header = JSON.parse(decoder.decode(headerBytes));
        offset += headerLength;

        let iv, salt;
        if (header.ivLength > 0) {
          iv = uint8View.slice(offset, offset + header.ivLength);
          offset += header.ivLength;
        }

        if (header.saltLength > 0) {
          salt = uint8View.slice(offset, offset + header.saltLength);
          offset += header.saltLength;
        }

        const data = buffer.slice(offset, offset + header.dataLength);

        return { encrypted: header.encrypted, data, iv, salt };
      }

      async function sealSnapshot(buffer) {
        const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
        const hashHex = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, "0")).join("");
        return {
          sealedAt: Date.now(),
          hash: hashHex,
          algo: "SHA-256"
        };
      }

      return {
        createSnapshot,
        restoreSnapshot,
        exportSnapshot,
        listSnapshots
      };
    })();

    // ============================================
    // WINDOW MANAGER
    // ============================================
    const WindowManager = (() => {
      let zIndex = 1000;
      const windows = new Map();
      let dragState = null;
      let resizeState = null;

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function createWindow(id, title, content, options = {}) {
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const isMobile = viewportWidth <= 480;
        const isTablet = viewportWidth <= 768 && viewportWidth > 480;

        let width, height, x, y;

        if (isMobile) {
          width = viewportWidth;
          height = Math.min(options.height || 400, viewportHeight - 40);
          x = 0;
          y = 0;
        } else {
          const maxWidth = viewportWidth - 40;
          const maxHeight = viewportHeight - 80;

          width = options.width || 600;
          height = options.height || 400;

          if (width > maxWidth) width = maxWidth;
          if (height > maxHeight) height = maxHeight;

          x = options.x || Math.max(20, (viewportWidth - width) / 2);
          y = options.y || Math.max(40, (viewportHeight - height) / 2 + 40);
        }

        const win = document.createElement('div');
        win.className = 'window';
        win.id = `window-${id}`;
        win.style.width = `${width}px`;
        win.style.height = `${height}px`;
        win.style.left = `${x}px`;
        win.style.top = `${y}px`;
        win.style.zIndex = ++zIndex;

        win.innerHTML = `
          <div class="window-header">
            <span style="font-weight: 600;">${escapeHtml(title)}</span>
            <div class="window-controls">
              <div class="window-control minimize"></div>
              <div class="window-control maximize"></div>
              <div class="window-control close"></div>
            </div>
          </div>
          <div class="window-content" id="window-content-${id}" data-sandbox="true">
            ${content}
          </div>
          <div class="resize-handle se" data-direction="se"></div>
        `;

        const header = win.querySelector('.window-header');
        header.addEventListener('mousedown', (e) => startDrag(e, win), { passive: false });
        header.addEventListener('touchstart', (e) => {
          if (e.target && e.target.closest('.window-controls')) return;
          e.preventDefault();
          startDrag(e.touches[0], win);
        }, { passive: false });

        const resizeHandle = win.querySelector('.resize-handle');
        resizeHandle.addEventListener('mousedown', (e) => startResize(e, win), { passive: false });
        resizeHandle.addEventListener('touchstart', (e) => {
          e.preventDefault();
          e.stopPropagation();
          startResize(e.touches[0], win);
        }, { passive: false });

        win.addEventListener('mousedown', () => {
          win.style.zIndex = ++zIndex;
        });
        win.addEventListener('touchstart', () => {
          win.style.zIndex = ++zIndex;
        });

        const closeBtn = win.querySelector('.window-control.close');
        const minimizeBtn = win.querySelector('.window-control.minimize');
        const maximizeBtn = win.querySelector('.window-control.maximize');

        if (closeBtn) {
          closeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('[WindowManager] Close button clicked for window:', id);
            const winData = windows.get(id);
            if (winData && winData.element) {
              if (id === 'monitor' && typeof Apps !== 'undefined' && Apps.Monitor) {
                Apps.Monitor.close();
              }
              winData.element.remove();
              windows.delete(id);
              Kernel.emit('window:closed', { id });
              console.log('[WindowManager] Window closed successfully via event listener:', id);
            }
          });
        }

        if (minimizeBtn) {
          minimizeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const winData = windows.get(id);
            if (winData && winData.element) {
              winData.element.style.display = 'none';
              winData.minimized = true;
            }
          });
        }

        if (maximizeBtn) {
          maximizeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const winData = windows.get(id);
            if (winData && winData.element && winData.minimized) {
              winData.element.style.display = 'flex';
              winData.minimized = false;
            }
          });
        }

        document.getElementById('desktop').appendChild(win);
        windows.set(id, { element: win, title, minimized: false });

        Kernel.emit('window:created', { id, title });
        return win;
      }

      function startDrag(clientInfo, win) {
        if (typeof clientInfo.target !== 'undefined' && clientInfo.target.closest('.window-controls')) return;

        dragState = {
          win,
          startX: clientInfo.clientX,
          startY: clientInfo.clientY,
          startLeft: win.offsetLeft,
          startTop: win.offsetTop
        };

        if (typeof clientInfo.preventDefault === 'function') {
          clientInfo.preventDefault();
        }
      }

      function startResize(clientInfo, win) {
        resizeState = {
          win,
          startX: clientInfo.clientX,
          startY: clientInfo.clientY,
          startWidth: win.offsetWidth,
          startHeight: win.offsetHeight
        };

        if (typeof clientInfo.preventDefault === 'function') {
          clientInfo.preventDefault();
          clientInfo.stopPropagation();
        }
      }

      function handleMove(clientX, clientY) {
        if (dragState) {
          const dx = clientX - dragState.startX;
          const dy = clientY - dragState.startY;

          const newLeft = dragState.startLeft + dx;
          const newTop = dragState.startTop + dy;

          const maxLeft = window.innerWidth - dragState.win.offsetWidth;
          const maxTop = window.innerHeight - 40;

          const constrainedLeft = Math.max(0, Math.min(maxLeft, newLeft));
          const constrainedTop = Math.max(0, Math.min(maxTop, newTop));

          dragState.win.style.left = `${constrainedLeft}px`;
          dragState.win.style.top = `${constrainedTop}px`;
        }

        if (resizeState) {
          const dx = clientX - resizeState.startX;
          const dy = clientY - resizeState.startY;

          const maxWidth = window.innerWidth - resizeState.win.offsetLeft - 20;
          const maxHeight = window.innerHeight - resizeState.win.offsetTop - 20;

          const newWidth = Math.max(300, Math.min(maxWidth, resizeState.startWidth + dx));
          const newHeight = Math.max(200, Math.min(maxHeight, resizeState.startHeight + dy));

          resizeState.win.style.width = `${newWidth}px`;
          resizeState.win.style.height = `${newHeight}px`;
        }
      }

      document.addEventListener('mousemove', (e) => {
        handleMove(e.clientX, e.clientY);
      });

      document.addEventListener('touchmove', (e) => {
        if (dragState || resizeState) {
          e.preventDefault();
          const touch = e.touches[0];
          handleMove(touch.clientX, touch.clientY);
        }
      }, { passive: false });

      document.addEventListener('mouseup', () => {
        dragState = null;
        resizeState = null;
      });

      document.addEventListener('touchend', () => {
        dragState = null;
        resizeState = null;
      });

      document.addEventListener('touchcancel', () => {
        dragState = null;
        resizeState = null;
      });

      function adjustWindowsToViewport() {
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;

        windows.forEach((win) => {
          const element = win.element;
          if (win.minimized || !element) return;

          let width = element.offsetWidth;
          let height = element.offsetHeight;
          let left = element.offsetLeft;
          let top = element.offsetTop;

          const maxWidth = viewportWidth - 40;
          const maxHeight = viewportHeight - 80;

          if (width > maxWidth) {
            width = maxWidth;
            element.style.width = `${width}px`;
          }

          if (height > maxHeight) {
            height = maxHeight;
            element.style.height = `${height}px`;
          }

          if (left + width > viewportWidth) {
            left = Math.max(0, viewportWidth - width - 20);
            element.style.left = `${left}px`;
          }

          if (top + height > viewportHeight) {
            top = Math.max(0, viewportHeight - height - 20);
            element.style.top = `${top}px`;
          }

          if (left < 0) {
            element.style.left = '20px';
          }

          if (top < 0) {
            element.style.top = '40px';
          }
        });
      }

      window.addEventListener('resize', adjustWindowsToViewport);
      window.addEventListener('orientationchange', () => {
        setTimeout(adjustWindowsToViewport, 100);
      });

      return {
        create: createWindow,

        close(id) {
          console.log('[WindowManager] Attempting to close window:', id);
          const win = windows.get(id);
          console.log('[WindowManager] Window found:', win);

          if (win) {
            if (id === 'monitor' && Apps.Monitor) {
              Apps.Monitor.close();
            }

            if (win.element && typeof win.element.remove === 'function') {
              win.element.remove();
              windows.delete(id);
              Kernel.emit('window:closed', { id });
              console.log('[WindowManager] Window closed successfully:', id);
            } else {
              console.error('[WindowManager] Window element not found or remove() not available:', win);
              const fallbackElement = document.getElementById(`window-${id}`);
              if (fallbackElement) {
                fallbackElement.remove();
                windows.delete(id);
                Kernel.emit('window:closed', { id });
                console.log('[WindowManager] Window closed using fallback method:', id);
              }
            }
          } else {
            console.warn('[WindowManager] Window not found in windows Map:', id);
          }
        },

        minimize(id) {
          const win = windows.get(id);
          if (win) {
            win.element.style.display = 'none';
            win.minimized = true;
          }
        },

        maximize(id) {
          const win = windows.get(id);
          if (win && win.minimized) {
            win.element.style.display = 'flex';
            win.minimized = false;
          }
        },

        getContent(id) {
          return document.getElementById(`window-content-${id}`);
        },

        setContent(id, html) {
          const w = windows.get(id);
          if (!w) return;
          const c = w.element.querySelector('.window-content');
          c.innerHTML = sanitizeHTML(html);
        },

        closeAll() {
          windows.forEach((w, id) => {
            w.element.remove();
            windows.delete(id);
          });
          Kernel.emit('window:closed:all', {});
        }
      };

      function sanitizeHTML(html) {
        return html.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, "");
      }

      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && e.ctrlKey) {
          WindowManager.closeAll && WindowManager.closeAll();
        }
      });

      return WindowManager;
    })();

    // Make WindowManager global for onclick handlers
    window.WindowManager = WindowManager;

    // ============================================
    // SUPABASE CLIENT
    // ============================================
    let supabaseClient = null;
    let currentUser = null;

    async function initSupabase() {
      const { createClient } = await import('@supabase/supabase-js');
      supabaseClient = createClient(CONFIG.supabase.url, CONFIG.supabase.anonKey, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true,
          storageKey: 'webos-qc-auth-token',
          storage: window.localStorage
        }
      });

      // Listen for auth state changes
      supabaseClient.auth.onAuthStateChange((event, session) => {
        console.log('[AUTH] State change:', event);
        if (event === 'SIGNED_OUT') {
          currentUser = null;
          localStorage.removeItem('webos-qc-auth-token');
          // Retourner à l'écran de connexion
          document.getElementById('desktop').style.display = 'none';
          document.getElementById('topbar').style.display = 'none';
          document.getElementById('dock').style.display = 'none';
          document.getElementById('loginScreen').style.display = 'flex';
          Auth.showLogin();
        } else if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
          if (session) {
            currentUser = session.user;
          }
        } else if (event === 'USER_UPDATED') {
          if (session) {
            currentUser = session.user;
          }
        }
      });

      // Check for existing session
      try {
        const { data: { session }, error } = await supabaseClient.auth.getSession();

        if (error) {
          console.warn('[AUTH] Error getting session:', error.message);
          // Si le refresh token est invalide, nettoyer le storage
          if (error.message.includes('Refresh Token')) {
            console.log('[AUTH] Clearing invalid session data');
            await supabaseClient.auth.signOut();
            localStorage.removeItem('webos-qc-auth-token');
          }
          return false;
        }

        if (session) {
          currentUser = session.user;
          await ensureUserProfile();
          return true;
        }
        return false;
      } catch (err) {
        console.warn('[AUTH] Exception getting session:', err);
        // Nettoyer en cas d'erreur
        try {
          await supabaseClient.auth.signOut();
          localStorage.removeItem('webos-qc-auth-token');
        } catch (cleanupErr) {
          console.warn('[AUTH] Cleanup error:', cleanupErr);
        }
        return false;
      }
    }

    async function ensureUserProfile() {
      if (!currentUser) return;

      try {
        const { data, error } = await supabaseClient
          .from('users')
          .select('*')
          .eq('id', currentUser.id)
          .maybeSingle();

        if (error) {
          console.warn('Error fetching user profile:', error);
          return;
        }

        if (!data) {
          const { error: insertError } = await supabaseClient.from('users').insert({
            id: currentUser.id,
            email: currentUser.email,
            full_name: currentUser.user_metadata?.full_name || '',
            last_login: new Date().toISOString()
          });

          if (insertError) {
            console.warn('Error inserting user profile:', insertError);
          }
        } else {
          const { error: updateError } = await supabaseClient
            .from('users')
            .update({ last_login: new Date().toISOString() })
            .eq('id', currentUser.id);

          if (updateError) {
            console.warn('Error updating user last_login:', updateError);
          }
        }
      } catch (err) {
        console.error('Failed to ensure user profile:', err);
      }
    }

    // ============================================
    // WEBLLM INTEGRATION
    // ============================================
    const AI = (() => {
      let engine = null;
      let isLoading = false;
      let isReady = false;
      const maxRetries = 3;
      let retryCount = 0;

      async function loadWebLLMWithRetry(retryDelay = 2000) {
        const cdnUrls = [
          'https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.79/+esm',
          'https://esm.run/@mlc-ai/web-llm@0.2.79',
          'https://unpkg.com/@mlc-ai/web-llm@0.2.79/lib/index.js'
        ];

        for (let i = 0; i < cdnUrls.length; i++) {
          try {
            console.log(`[AI] Attempting to load from CDN ${i + 1}/${cdnUrls.length}:`, cdnUrls[i]);
            const module = await import(cdnUrls[i]);
            console.log('[AI] Successfully loaded WebLLM from:', cdnUrls[i]);
            return module;
          } catch (err) {
            console.warn(`[AI] Failed to load from CDN ${i + 1}:`, err.message);
            if (i < cdnUrls.length - 1) {
              console.log(`[AI] Retrying with next CDN in ${retryDelay}ms...`);
              await new Promise(resolve => setTimeout(resolve, retryDelay));
            }
          }
        }
        throw new Error('All CDN attempts failed. Please check your internet connection and try again.');
      }

      async function checkBrowserCapabilities() {
        const issues = [];

        if (typeof WebAssembly === 'undefined') {
          issues.push('WebAssembly not supported');
        }

        if (!navigator.gpu) {
          issues.push('WebGPU not supported - AI features will not work in this browser');
        }

        if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
          issues.push('HTTPS required for WebGPU');
        }

        if (!window.crossOriginIsolated) {
          console.warn('[AI] Cross-origin isolation not enabled - this may affect performance');
        }

        return issues;
      }

      async function initialize() {
        if (isReady) return true;
        if (isLoading) return false;

        isLoading = true;
        const statusEl = document.getElementById('aiStatus');

        try {
          if (statusEl) {
            statusEl.textContent = 'IA: Vérification du navigateur...';
            statusEl.style.color = '#f59e0b';
          }

          const issues = await checkBrowserCapabilities();
          if (issues.length > 0) {
            const errorMsg = 'Incompatibilité détectée: ' + issues.join(', ');
            console.error('[AI]', errorMsg);
            throw new Error(errorMsg);
          }

          if (statusEl) statusEl.textContent = 'IA: Chargement du module...';

          const { CreateMLCEngine } = await loadWebLLMWithRetry();

          if (statusEl) statusEl.textContent = 'IA: Téléchargement du modèle...';

          const progressCallback = (report) => {
            const percent = Math.round(report.progress * 100);
            if (statusEl) {
              statusEl.textContent = `IA: ${report.text || 'téléchargement'} ${percent}%`;
              statusEl.style.color = '#f59e0b';
            }
            console.log(`[AI] ${report.text} - ${percent}%`);
          };

          console.log('[AI] Initializing with model:', CONFIG.webllm.model);
          console.log('[AI] Browser:', navigator.userAgent);
          console.log('[AI] WebGPU available:', !!navigator.gpu);
          console.log('[AI] WebAssembly available:', typeof WebAssembly !== 'undefined');

          engine = await CreateMLCEngine(
            CONFIG.webllm.model,
            {
              initProgressCallback: progressCallback,
              logLevel: 'INFO'
            }
          );

          isReady = true;
          isLoading = false;

          if (statusEl) {
            statusEl.textContent = 'IA: Prête ✓';
            statusEl.style.color = '#10b981';
          }

          Kernel.emit('ai:ready', { model: CONFIG.webllm.model });
          console.log('[AI] Successfully initialized');
          return true;
        } catch (error) {
          console.error('[AI] WebLLM initialization failed:', error);
          console.error('[AI] Error details:', error.message, error.stack);
          isLoading = false;
          if (statusEl) {
            const shortError = error.message.length > 60 ? error.message.substring(0, 60) + '...' : error.message;
            statusEl.textContent = 'IA: Erreur - ' + shortError;
            statusEl.style.color = '#ef4444';
            statusEl.title = 'Erreur IA: ' + error.message + '\n\nCliquez pour réessayer';
            statusEl.style.cursor = 'pointer';
            statusEl.onclick = () => {
              if (retryCount < maxRetries) {
                retryCount++;
                console.log(`[AI] Retry attempt ${retryCount}/${maxRetries}`);
                initialize();
              } else {
                alert('Échec après ' + maxRetries + ' tentatives. Veuillez vérifier votre connexion Internet et votre navigateur.');
              }
            };
          }
          return false;
        }
      }

      async function chat(messages, onUpdate = null) {
        if (!isReady) {
          throw new Error('AI engine not ready');
        }

        try {
          const completion = await engine.chat.completions.create({
            messages,
            temperature: CONFIG.webllm.temperature,
            top_p: CONFIG.webllm.topP,
            max_tokens: CONFIG.webllm.maxTokens,
            stream: !!onUpdate
          });

          if (onUpdate) {
            let fullResponse = '';
            for await (const chunk of completion) {
              const delta = chunk.choices[0]?.delta?.content || '';
              fullResponse += delta;
              onUpdate(fullResponse);
            }
            return fullResponse;
          } else {
            return completion.choices[0].message.content;
          }
        } catch (error) {
          console.error('AI chat error:', error);
          throw error;
        }
      }

      return {
        initialize,
        chat,
        isReady: () => isReady
      };
    })();

    // ============================================
    // AI HELPER SERVICE - Background AI Assistants
    // ============================================
    const AIHelperService = (() => {
      const AI_ACCOUNTS = [
        { id: '00000000-0000-0000-0000-000000000001', email: 'ai.support@quebec.gouv.qc.ca', name: 'Assistant IA - Support', personality: 'helpful and supportive' },
        { id: '00000000-0000-0000-0000-000000000002', email: 'ai.info@quebec.gouv.qc.ca', name: 'Assistant IA - Info', personality: 'informative and precise' },
        { id: '00000000-0000-0000-0000-000000000003', email: 'ai.conseiller@quebec.gouv.qc.ca', name: 'Assistant IA - Conseiller', personality: 'advisory and professional' }
      ];

      let intervalId = null;
      let isEnabled = false;

      async function generateAIResponse(personality, context = '') {
        if (!AI.isReady()) {
          console.log('[AIHelper] AI not ready, skipping response generation');
          return null;
        }

        const prompts = {
          'helpful and supportive': [
            'En tant qu\'assistant de support, comment puis-je aider les citoyens aujourd\'hui?',
            'Bonjour! Y a-t-il des questions sur les services gouvernementaux que je peux clarifier?',
            'Je suis disponible pour vous aider avec toute question administrative.'
          ],
          'informative and precise': [
            'Voici une information importante concernant les services publics québécois.',
            'Mise à jour: Les dernières procédures administratives ont été simplifiées.',
            'Information: Nouveaux services en ligne disponibles pour les citoyens.'
          ],
          'advisory and professional': [
            'En tant que conseiller, je recommande de consulter nos nouvelles ressources.',
            'Conseil du jour: Vérifiez vos documents administratifs régulièrement.',
            'Il est important de maintenir vos informations à jour dans nos systèmes.'
          ]
        };

        const options = prompts[personality] || prompts['helpful and supportive'];
        return options[Math.floor(Math.random() * options.length)];
      }

      async function sendAIMessage() {
        if (!currentUser) return;

        try {
          const aiAccount = AI_ACCOUNTS[Math.floor(Math.random() * AI_ACCOUNTS.length)];
          const messageText = await generateAIResponse(aiAccount.personality);

          if (!messageText) return;

          const { data: { session } } = await supabaseClient.auth.getSession();
          if (!session) {
            console.error('[AIHelper] No session available');
            return;
          }

          const response = await fetch(
            `${CONFIG.supabase.url}/functions/v1/ai-helper-message`,
            {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${session.access_token}`,
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                aiAccountId: aiAccount.id,
                message: messageText,
              }),
            }
          );

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to send AI message');
          }

          const result = await response.json();
          console.log(`[AIHelper] ${aiAccount.name} sent message: "${messageText}"`);

          Kernel.emit('message:received', {
            from: aiAccount.email,
            name: aiAccount.name,
            message: messageText,
            conversationId: result.conversationId
          });
        } catch (error) {
          console.error('[AIHelper] Error sending AI message:', error);
        }
      }

      function start() {
        if (isEnabled) return;

        isEnabled = true;
        const minInterval = 5 * 60 * 1000;
        const maxInterval = 15 * 60 * 1000;

        function scheduleNext() {
          const delay = minInterval + Math.random() * (maxInterval - minInterval);
          intervalId = setTimeout(() => {
            sendAIMessage();
            scheduleNext();
          }, delay);
        }

        scheduleNext();
        console.log('[AIHelper] Service started - AI helpers will send messages periodically');
      }

      function stop() {
        if (intervalId) {
          clearTimeout(intervalId);
          intervalId = null;
        }
        isEnabled = false;
        console.log('[AIHelper] Service stopped');
      }

      return {
        start,
        stop,
        sendTestMessage: sendAIMessage,
        isEnabled: () => isEnabled
      };
    })();

    // ============================================
    // AI EMAIL RESPONDER SERVICE
    // ============================================
    const AIEmailResponder = (() => {
      let processingIntervalId = null;
      let isRunning = false;

      async function processEmailQueue() {
        if (!currentUser) return;

        try {
          const { data: queuedEmails, error } = await supabaseClient
            .from('ai_email_response_queue')
            .select('id, email_id, attempts')
            .eq('status', 'pending')
            .order('created_at', { ascending: true })
            .limit(5);

          if (error) {
            console.error('[AIEmailResponder] Error fetching queue:', error);
            return;
          }

          if (!queuedEmails || queuedEmails.length === 0) return;

          for (const queueItem of queuedEmails) {
            try {
              await supabaseClient
                .from('ai_email_response_queue')
                .update({ status: 'processing' })
                .eq('id', queueItem.id);

              const response = await fetch(
                `${CONFIG.supabase.url}/functions/v1/ai-email-responder`,
                {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${CONFIG.supabase.anonKey}`,
                  },
                  body: JSON.stringify({
                    emailId: queueItem.email_id,
                  }),
                }
              );

              const result = await response.json();

              if (response.ok && result.success) {
                await supabaseClient
                  .from('ai_email_response_queue')
                  .update({
                    status: 'completed',
                    processed_at: new Date().toISOString(),
                  })
                  .eq('id', queueItem.id);

                console.log('[AIEmailResponder] AI response sent for email:', queueItem.email_id);
              } else {
                throw new Error(result.error || 'Failed to send AI response');
              }
            } catch (error) {
              console.error('[AIEmailResponder] Error processing queue item:', error);

              const newAttempts = queueItem.attempts + 1;
              if (newAttempts >= 3) {
                await supabaseClient
                  .from('ai_email_response_queue')
                  .update({
                    status: 'failed',
                    attempts: newAttempts,
                    processed_at: new Date().toISOString(),
                  })
                  .eq('id', queueItem.id);
              } else {
                await supabaseClient
                  .from('ai_email_response_queue')
                  .update({
                    status: 'pending',
                    attempts: newAttempts,
                  })
                  .eq('id', queueItem.id);
              }
            }

            await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 3000));
          }
        } catch (error) {
          console.error('[AIEmailResponder] Error in processEmailQueue:', error);
        }
      }

      function start() {
        if (isRunning) return;

        isRunning = true;
        console.log('[AIEmailResponder] Service started');

        processEmailQueue();

        processingIntervalId = setInterval(() => {
          processEmailQueue();
        }, 15000);
      }

      function stop() {
        if (!isRunning) return;

        isRunning = false;
        if (processingIntervalId) {
          clearInterval(processingIntervalId);
          processingIntervalId = null;
        }
        console.log('[AIEmailResponder] Service stopped');
      }

      return {
        start,
        stop,
        isRunning: () => isRunning,
      };
    })();

    // ============================================
    // FILE SYSTEM (OPFS)
    // ============================================
    const FileSystem = (() => {
      let root = null;
      const MIME_TYPES = {
        'txt': 'text/plain',
        'json': 'application/json',
        'xml': 'application/xml',
        'csv': 'text/csv',
        'html': 'text/html',
        'md': 'text/markdown',
        'pdf': 'application/pdf',
        'doc': 'application/msword',
        'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'xls': 'application/vnd.ms-excel',
        'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'ppt': 'application/vnd.ms-powerpoint',
        'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
        'zip': 'application/zip',
        'jpg': 'image/jpeg',
        'jpeg': 'image/jpeg',
        'png': 'image/png',
        'gif': 'image/gif',
        'svg': 'image/svg+xml',
        'webp': 'image/webp'
      };

      async function initialize() {
        try {
          // Vérifier si OPFS est supporté
          if (!navigator.storage || !navigator.storage.getDirectory) {
            console.warn('[FileSystem] OPFS not supported in this browser - file system features will be limited');
            Kernel.emit('fs:ready'); // Émettre quand même pour ne pas bloquer l'app
            return false;
          }

          root = await navigator.storage.getDirectory();
          console.log('[FileSystem] OPFS initialized successfully');
          Kernel.emit('fs:ready');
          return true;
        } catch (error) {
          console.warn('[FileSystem] OPFS initialization failed:', error.message || error);
          console.warn('[FileSystem] File system features will be limited');
          Kernel.emit('fs:ready'); // Émettre quand même pour ne pas bloquer l'app
          return false;
        }
      }

      function getMimeType(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        return MIME_TYPES[ext] || 'application/octet-stream';
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
      }

      async function writeFile(path, content, mimeType = null) {
        try {
          if (!root) {
            console.warn('[FileSystem] Cannot write file - OPFS not available');
            return false;
          }

          const file = await root.getFileHandle(path, { create: true });
          const writable = await file.createWritable();

          if (content instanceof Blob) {
            await writable.write(content);
          } else if (typeof content === 'string') {
            await writable.write(content);
          } else {
            await writable.write(JSON.stringify(content));
          }

          await writable.close();

          const size = content instanceof Blob ? content.size :
                       typeof content === 'string' ? new Blob([content]).size :
                       new Blob([JSON.stringify(content)]).size;

          if (currentUser) {
            await supabaseClient.from('files_metadata').upsert({
              user_id: currentUser.id,
              path: `/${path}`,
              name: path.split('/').pop(),
              size: size,
              mime_type: mimeType || getMimeType(path),
              updated_at: new Date().toISOString()
            });
          }

          Kernel.emit('fs:write', { path, size });
          return true;
        } catch (error) {
          console.error('Write file error:', error);
          return false;
        }
      }

      async function readFile(path, asBlob = false) {
        try {
          if (!root) {
            console.warn('[FileSystem] Cannot read file - OPFS not available');
            return null;
          }

          const file = await root.getFileHandle(path);
          const fileData = await file.getFile();

          if (asBlob) {
            return fileData;
          }

          const mimeType = getMimeType(path);
          if (mimeType.startsWith('image/') || mimeType === 'application/pdf') {
            return fileData;
          }

          return await fileData.text();
        } catch (error) {
          console.error('Read file error:', error);
          return null;
        }
      }

      async function listFiles() {
        try {
          if (!root) {
            console.warn('[FileSystem] Cannot list files - OPFS not available');
            return [];
          }

          const files = [];
          for await (const entry of root.values()) {
            if (entry.kind === 'file') {
              const fileHandle = await root.getFileHandle(entry.name);
              const file = await fileHandle.getFile();

              files.push({
                name: entry.name,
                kind: entry.kind,
                size: file.size,
                sizeFormatted: formatFileSize(file.size),
                mimeType: getMimeType(entry.name),
                lastModified: new Date(file.lastModified),
                extension: entry.name.split('.').pop().toLowerCase()
              });
            }
          }
          return files.sort((a, b) => b.lastModified - a.lastModified);
        } catch (error) {
          console.error('List files error:', error);
          return [];
        }
      }

      async function deleteFile(path) {
        try {
          if (!root) {
            console.warn('[FileSystem] Cannot delete file - OPFS not available');
            return false;
          }

          await root.removeEntry(path);

          if (currentUser) {
            await supabaseClient
              .from('files_metadata')
              .delete()
              .eq('user_id', currentUser.id)
              .eq('path', `/${path}`);
          }

          Kernel.emit('fs:delete', { path });
          return true;
        } catch (error) {
          console.error('Delete file error:', error);
          return false;
        }
      }

      async function importFile(file) {
        try {
          const content = await file.arrayBuffer();
          const blob = new Blob([content], { type: file.type });
          await writeFile(file.name, blob, file.type);
          return { success: true, name: file.name, size: file.size };
        } catch (error) {
          console.error('Import file error:', error);
          return { success: false, error: error.message };
        }
      }

      async function exportFile(path, format = null) {
        try {
          const content = await readFile(path, true);
          if (!content) throw new Error('File not found');

          const filename = path.split('/').pop();
          const blob = content instanceof Blob ? content : new Blob([content], { type: 'text/plain' });

          let exportBlob = blob;
          let exportName = filename;

          if (format) {
            const converted = await convertFormat(content, filename, format);
            exportBlob = converted.blob;
            exportName = converted.name;
          }

          const url = URL.createObjectURL(exportBlob);
          const a = document.createElement('a');
          a.href = url;
          a.download = exportName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          return true;
        } catch (error) {
          console.error('Export file error:', error);
          return false;
        }
      }

      async function convertFormat(content, filename, targetFormat) {
        const text = content instanceof Blob ? await content.text() : content;
        const baseName = filename.replace(/\.[^.]+$/, '');

        switch(targetFormat.toLowerCase()) {
          case 'json':
            try {
              const jsonData = typeof text === 'string' ? JSON.parse(text) : text;
              return {
                blob: new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' }),
                name: `${baseName}.json`
              };
            } catch {
              return {
                blob: new Blob([JSON.stringify({ content: text }, null, 2)], { type: 'application/json' }),
                name: `${baseName}.json`
              };
            }

          case 'csv':
            const csvContent = convertToCSV(text);
            return {
              blob: new Blob([csvContent], { type: 'text/csv' }),
              name: `${baseName}.csv`
            };

          case 'xml':
            const xmlContent = convertToXML(text);
            return {
              blob: new Blob([xmlContent], { type: 'application/xml' }),
              name: `${baseName}.xml`
            };

          case 'html':
            const htmlContent = `<!DOCTYPE html>\n<html>\n<head>\n<meta charset="UTF-8">\n<title>${baseName}</title>\n</head>\n<body>\n<pre>${escapeHtml(text)}</pre>\n</body>\n</html>`;
            return {
              blob: new Blob([htmlContent], { type: 'text/html' }),
              name: `${baseName}.html`
            };

          case 'txt':
          default:
            return {
              blob: new Blob([text], { type: 'text/plain' }),
              name: `${baseName}.txt`
            };
        }
      }

      function convertToCSV(data) {
        try {
          const jsonData = JSON.parse(data);
          if (Array.isArray(jsonData) && jsonData.length > 0) {
            const headers = Object.keys(jsonData[0]);
            const csvRows = [headers.join(',')];

            for (const row of jsonData) {
              const values = headers.map(header => {
                const val = row[header];
                return typeof val === 'string' && val.includes(',') ? `"${val}"` : val;
              });
              csvRows.push(values.join(','));
            }

            return csvRows.join('\n');
          }
        } catch (e) {}

        return data;
      }

      function convertToXML(data) {
        try {
          const jsonData = JSON.parse(data);
          return jsonToXML(jsonData, 'root');
        } catch (e) {
          return `<?xml version="1.0" encoding="UTF-8"?>\n<document>\n<content><![CDATA[${data}]]></content>\n</document>`;
        }
      }

      function jsonToXML(obj, rootName) {
        let xml = `<?xml version="1.0" encoding="UTF-8"?>\n<${rootName}>\n`;

        function parseObject(obj, indent = '  ') {
          let result = '';
          for (const key in obj) {
            const value = obj[key];
            if (typeof value === 'object' && value !== null) {
              if (Array.isArray(value)) {
                for (const item of value) {
                  result += `${indent}<${key}>${typeof item === 'object' ? parseObject(item, indent + '  ') : item}</${key}>\n`;
                }
              } else {
                result += `${indent}<${key}>\n${parseObject(value, indent + '  ')}${indent}</${key}>\n`;
              }
            } else {
              result += `${indent}<${key}>${value}</${key}>\n`;
            }
          }
          return result;
        }

        xml += parseObject(obj);
        xml += `</${rootName}>`;
        return xml;
      }

      function escapeHtml(text) {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
      }

      async function getFilePreview(path) {
        try {
          const content = await readFile(path, true);
          const mimeType = getMimeType(path);

          if (mimeType.startsWith('image/')) {
            return { type: 'image', url: URL.createObjectURL(content) };
          } else if (mimeType.startsWith('text/') || mimeType === 'application/json') {
            const text = await content.text();
            return { type: 'text', content: text.substring(0, 500) };
          }

          return { type: 'binary', message: 'Aperçu non disponible pour ce type de fichier' };
        } catch (error) {
          console.error('Preview error:', error);
          return { type: 'error', message: 'Erreur lors de la génération de l\'aperçu' };
        }
      }

      return {
        initialize,
        writeFile,
        readFile,
        listFiles,
        deleteFile,
        importFile,
        exportFile,
        convertFormat,
        getFilePreview,
        getMimeType,
        formatFileSize
      };
    })();

    // ============================================
    // NOTIFICATIONS SYSTEM
    // ============================================
    const Notifications = (() => {
      let realtimeChannel = null;
      let cachedNotifications = [];

      async function initialize() {
        if (!currentUser) return;
        await loadNotifications();
        setupRealtimeSubscription();
      }

      async function loadNotifications() {
        if (!currentUser) return;

        try {
          const { data, error } = await supabaseClient
            .from('notifications')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false })
            .limit(10);

          if (error) throw error;

          cachedNotifications = data || [];
          renderNotifications();
          updateBadge();
        } catch (error) {
          console.error('Load notifications error:', error);
        }
      }

      function setupRealtimeSubscription() {
        if (!currentUser) return;

        realtimeChannel = supabaseClient
          .channel('notifications-channel')
          .on(
            'postgres_changes',
            {
              event: '*',
              schema: 'public',
              table: 'notifications',
              filter: `user_id=eq.${currentUser.id}`
            },
            (payload) => {
              console.log('Notification realtime update:', payload);

              if (payload.eventType === 'INSERT') {
                cachedNotifications.unshift(payload.new);
                if (cachedNotifications.length > 10) cachedNotifications.pop();
                playNotificationSound();
              } else if (payload.eventType === 'UPDATE') {
                const idx = cachedNotifications.findIndex(n => n.id === payload.new.id);
                if (idx !== -1) cachedNotifications[idx] = payload.new;
              } else if (payload.eventType === 'DELETE') {
                cachedNotifications = cachedNotifications.filter(n => n.id !== payload.old.id);
              }

              renderNotifications();
              updateBadge();
            }
          )
          .subscribe();
      }

      function renderNotifications() {
        const container = document.getElementById('notificationsList');
        if (!container) return;

        if (cachedNotifications.length === 0) {
          container.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af;">Aucune notification</div>';
          return;
        }

        const colors = {
          system: '#3b82f6',
          portal: '#10b981',
          email: '#06b6d4',
          appointment: '#f59e0b',
          success: '#10b981',
          warning: '#f59e0b',
          error: '#ef4444',
          info: '#3b82f6'
        };

        container.innerHTML = cachedNotifications.map(notif => `
          <div style="padding: 12px; background: ${notif.is_read ? '#ffffff' : '#eff6ff'}; border-radius: 8px; border-left: 4px solid ${colors[notif.type] || '#3b82f6'}; cursor: pointer; transition: background 0.2s;"
               onclick="WebOS.Notifications.markAsRead('${notif.id}')"
               onmouseover="this.style.background='#f9fafb'"
               onmouseout="this.style.background='${notif.is_read ? '#ffffff' : '#eff6ff'}'">
            <div style="display: flex; justify-content: space-between; align-items: start;">
              <p style="font-weight: ${notif.is_read ? '400' : '600'}; color: #1f2937; margin: 0;">${notif.title}</p>
              ${!notif.is_read ? '<span style="width: 8px; height: 8px; background: #3b82f6; border-radius: 50%; display: inline-block;"></span>' : ''}
            </div>
            <p style="font-size: 14px; color: #6b7280; margin: 4px 0 0 0;">${notif.message}</p>
            <p style="font-size: 12px; color: #9ca3af; margin: 4px 0 0 0;">${formatTimeAgo(notif.created_at)}</p>
          </div>
        `).join('');
      }

      function formatTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'À l\'instant';
        if (diffMins < 60) return `Il y a ${diffMins} min`;
        if (diffHours < 24) return `Il y a ${diffHours}h`;
        if (diffDays === 1) return 'Hier';
        if (diffDays < 7) return `Il y a ${diffDays} jours`;
        return date.toLocaleDateString('fr-CA', { day: 'numeric', month: 'short' });
      }

      async function markAsRead(notificationId) {
        try {
          await supabaseClient
            .from('notifications')
            .update({ is_read: true, read_at: new Date().toISOString() })
            .eq('id', notificationId);
        } catch (error) {
          console.error('Mark as read error:', error);
        }
      }

      async function markAllAsRead() {
        if (!currentUser) return;

        try {
          await supabaseClient
            .from('notifications')
            .update({ is_read: true, read_at: new Date().toISOString() })
            .eq('user_id', currentUser.id)
            .eq('is_read', false);

          await loadNotifications();
        } catch (error) {
          console.error('Mark all as read error:', error);
        }
      }

      function updateBadge() {
        const unreadCount = cachedNotifications.filter(n => !n.is_read).length;
        Kernel.emit('notifications:unread', { count: unreadCount });
      }

      function playNotificationSound() {
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          oscillator.frequency.value = 800;
          oscillator.type = 'sine';

          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.3);
        } catch (error) {
          console.error('Notification sound error:', error);
        }
      }

      async function createNotification(title, message, type = 'info', category = 'general') {
        if (!currentUser) return;

        try {
          const { error } = await supabaseClient
            .from('notifications')
            .insert([{
              user_id: currentUser.id,
              type: type,
              category: category,
              title: title,
              message: message,
              priority: 'normal'
            }]);

          if (error) throw error;
        } catch (error) {
          console.error('Create notification error:', error);
        }
      }

      function cleanup() {
        if (realtimeChannel) {
          supabaseClient.removeChannel(realtimeChannel);
          realtimeChannel = null;
        }
      }

      return {
        initialize,
        loadNotifications,
        markAsRead,
        markAllAsRead,
        createNotification,
        cleanup
      };
    })();

    // ============================================
    // AUTHENTICATION
    // ============================================
    const Auth = (() => {
      async function login() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        if (!email || !password) {
          alert('Veuillez remplir tous les champs');
          return;
        }

        try {
          const { data, error } = await supabaseClient.auth.signInWithPassword({
            email,
            password
          });

          if (error) {
            console.error('[AUTH] Login error:', error);
            alert('Erreur de connexion: ' + error.message);
            return;
          }

          currentUser = data.user;
          await ensureUserProfile();
          await showDesktop();
        } catch (err) {
          console.error('[AUTH] Login exception:', err);
          alert('Erreur de connexion: ' + err.message);
        }
      }

      async function register() {
        const name = document.getElementById('registerName').value;
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;

        if (!name || !email || !password) {
          alert('Veuillez remplir tous les champs');
          return;
        }

        if (password.length < 6) {
          alert('Le mot de passe doit contenir au moins 6 caractères');
          return;
        }

        try {
          const { data, error } = await supabaseClient.auth.signUp({
            email,
            password,
            options: {
              data: {
                full_name: name
              }
            }
          });

          if (error) {
            console.error('[AUTH] Register error:', error);
            alert('Erreur d\'inscription: ' + error.message);
            return;
          }

          currentUser = data.user;
          await ensureUserProfile();
          await showDesktop();
        } catch (err) {
          console.error('[AUTH] Register exception:', err);
          alert('Erreur d\'inscription: ' + err.message);
        }
      }

      async function logout() {
        await supabaseClient.auth.signOut();
        currentUser = null;
        location.reload();
      }

      function showLogin() {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('registerForm').style.display = 'none';
      }

      function showRegister() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
      }

      return {
        login,
        register,
        logout,
        showLogin,
        showRegister
      };
    })();

    // ============================================
    // APPLICATIONS
    // ============================================
    const Apps = {
      TaskManager: {
        open() {
          const processes = WebOS.Kernel.getProcesses();
          const workerCount = Object.keys(WorkerDefinitions).length;

          const processRows = processes.map(p => `
            <tr style="border-bottom: 1px solid #e5e7eb;">
              <td style="padding: 12px; font-family: monospace; font-size: 11px; color: #64748b;">${p.pid}</td>
              <td style="padding: 12px; font-weight: 600; color: #1f2937;">${p.name}</td>
              <td style="padding: 12px;">
                <span style="padding: 4px 8px; background: #10b981; color: white; border-radius: 4px; font-size: 11px; font-weight: 600;">
                  ${p.status}
                </span>
              </td>
              <td style="padding: 12px; font-family: monospace; font-size: 12px; color: #64748b;">${Math.floor(p.uptime / 1000)}s</td>
              <td style="padding: 12px; text-align: center; font-family: monospace; font-size: 12px;">${p.messageCount}</td>
              <td style="padding: 12px; text-align: center; font-family: monospace; font-size: 12px; color: ${p.errorCount > 0 ? '#ef4444' : '#10b981'};">${p.errorCount}</td>
              <td style="padding: 12px;">
                <button onclick="WebOS.Kernel.terminateProcess('${p.pid}'); setTimeout(() => WebOS.Apps.TaskManager.open(), 100);" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                  Terminer
                </button>
              </td>
            </tr>
          `).join('');

          const html = `
            <div style="height: 100%; display: flex; flex-direction: column; padding: 20px;">
              <h2 style="margin-bottom: 20px; color: #1e40af; font-size: 24px; font-weight: 700;">📊 Gestionnaire de Tâches v4</h2>

              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                <div style="padding: 16px; background: linear-gradient(135deg, #eff6ff, #dbeafe); border-radius: 12px; border-left: 4px solid #3b82f6;">
                  <div style="font-size: 12px; color: #64748b; margin-bottom: 4px; font-weight: 600;">PROCESSUS ACTIFS</div>
                  <div style="font-size: 28px; font-weight: 700; color: #1e40af;">${processes.length}</div>
                </div>

                <div style="padding: 16px; background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: 12px; border-left: 4px solid #10b981;">
                  <div style="font-size: 12px; color: #64748b; margin-bottom: 4px; font-weight: 600;">WORKERS DÉFINIS</div>
                  <div style="font-size: 28px; font-weight: 700; color: #059669;">${workerCount}</div>
                </div>

                <div style="padding: 16px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 12px; border-left: 4px solid #f59e0b;">
                  <div style="font-size: 12px; color: #64748b; margin-bottom: 4px; font-weight: 600;">MESSAGES TOTAL</div>
                  <div style="font-size: 28px; font-weight: 700; color: #d97706;">${processes.reduce((sum, p) => sum + p.messageCount, 0)}</div>
                </div>

                <div style="padding: 16px; background: linear-gradient(135deg, #fee2e2, #fecaca); border-radius: 12px; border-left: 4px solid #ef4444;">
                  <div style="font-size: 12px; color: #64748b; margin-bottom: 4px; font-weight: 600;">ERREURS TOTAL</div>
                  <div style="font-size: 28px; font-weight: 700; color: #dc2626;">${processes.reduce((sum, p) => sum + p.errorCount, 0)}</div>
                </div>
              </div>

              <div style="flex: 1; overflow: auto; border: 1px solid #e5e7eb; border-radius: 12px; background: white;">
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="background: #f3f4f6; border-bottom: 2px solid #e5e7eb;">
                      <th style="padding: 12px; text-align: left; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase;">PID</th>
                      <th style="padding: 12px; text-align: left; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase;">Nom du Worker</th>
                      <th style="padding: 12px; text-align: left; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase;">Statut</th>
                      <th style="padding: 12px; text-align: left; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase;">Uptime</th>
                      <th style="padding: 12px; text-align: center; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase;">Messages</th>
                      <th style="padding: 12px; text-align: center; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase;">Erreurs</th>
                      <th style="padding: 12px; text-align: left; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase;">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${processRows || '<tr><td colspan="7" style="padding: 40px; text-align: center; color: #9ca3af; font-size: 14px;">Aucun processus actif</td></tr>'}
                  </tbody>
                </table>
              </div>

              <div style="margin-top: 20px; padding: 16px; background: #eff6ff; border-radius: 12px; border-left: 4px solid #3b82f6;">
                <p style="font-weight: 700; color: #1e40af; margin-bottom: 8px; font-size: 14px;">🔬 Architecture Cellulaire v4.0</p>
                <p style="font-size: 13px; color: #64748b; line-height: 1.6;">
                  Chaque processus est un Web Worker isolé généré dynamiquement à partir des WorkerDefinitions.
                  La communication inter-processus utilise un système de requêtes/réponses asynchrone via le Kernel.
                  Les workers peuvent s'appeler entre eux via le système de Tool-Use orchestré.
                </p>
              </div>
            </div>
          `;

          WindowManager.create("taskmanager", "Gestionnaire de Tâches", html, { width: 1000, height: 700 });
        }
      },

      Admin: {
        migrationInProgress: false,

        async migrateDataToLocal() {
          if (this.migrationInProgress) {
            alert('Migration déjà en cours...');
            return;
          }

          if (!confirm('Migrer toutes les données de Supabase vers la base de données locale CRDT?\n\nCela peut prendre plusieurs minutes selon la quantité de données.')) {
            return;
          }

          this.migrationInProgress = true;
          const btn = document.getElementById('migrateBtnId');
          const status = document.getElementById('migrationStatus');

          if (btn) btn.disabled = true;
          if (status) status.textContent = 'Migration en cours...';

          try {
            const dbProcess = WebOS.Kernel.getProcessByName('database-module');
            if (!dbProcess) {
              throw new Error('Database Module non démarré');
            }

            if (status) status.textContent = 'Récupération des emails depuis Supabase...';
            const { data: emails } = await supabaseClient.from('email_accounts').select('*').limit(100);

            if (status) status.textContent = `Migration de ${emails?.length || 0} emails...`;
            if (emails && emails.length > 0) {
              for (const email of emails) {
                await WebOS.Kernel.sendRequest(dbProcess.pid, 'set', {
                  collection: 'emails',
                  key: email.id,
                  value: email
                });
              }
            }

            if (status) status.textContent = 'Récupération des conversations...';
            const { data: conversations } = await supabaseClient.from('conversations').select('*').limit(100);

            if (status) status.textContent = `Migration de ${conversations?.length || 0} conversations...`;
            if (conversations && conversations.length > 0) {
              for (const conv of conversations) {
                await WebOS.Kernel.sendRequest(dbProcess.pid, 'set', {
                  collection: 'conversations',
                  key: conv.id,
                  value: conv
                });
              }
            }

            const stats = await WebOS.Kernel.sendRequest(dbProcess.pid, 'stats');
            if (status) status.innerHTML = `<strong style="color: #10b981;">Migration terminée avec succès!</strong><br>Collections: ${JSON.stringify(stats.collections, null, 2)}`;

            alert('Migration terminée avec succès!\n\nLes données sont maintenant disponibles localement.');
          } catch (error) {
            console.error('[Admin] Erreur migration:', error);
            if (status) status.innerHTML = `<strong style="color: #ef4444;">Erreur: ${error.message}</strong>`;
            alert('Erreur lors de la migration: ' + error.message);
          } finally {
            this.migrationInProgress = false;
            if (btn) btn.disabled = false;
          }
        },

        open() {
          const logs = Logger.getLogs().slice(0, 200);
          const perf = PerformanceMonitor.getReport();
          const processes = WebOS.Kernel.getProcesses();

          const html = `
            <div style="font-family: system-ui, sans-serif; padding: 20px;">
              <h2 style="margin-bottom: 20px; color: #1e40af; font-size: 24px; font-weight: 700;">Administration WebOS Québec v4</h2>

              <h3 style="margin-top: 24px; margin-bottom: 12px; font-size: 18px; font-weight: 600;">🔄 Migration de Données</h3>
              <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); padding: 20px; border-radius: 12px; border-left: 4px solid #3b82f6; margin-bottom: 24px;">
                <p style="margin-bottom: 12px; color: #64748b; font-size: 14px; line-height: 1.6;">
                  Migrez vos données depuis Supabase vers la base de données locale CRDT pour un fonctionnement 100% offline.
                  Cette opération copie les emails et conversations dans le DatabaseModule local.
                </p>
                <button id="migrateBtnId" onclick="WebOS.Apps.Admin.migrateDataToLocal()" style="width: 100%; padding: 12px; background: linear-gradient(to right, #1e40af, #3b82f6); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; margin-bottom: 12px;">
                  Migrer les données vers Local-First
                </button>
                <div id="migrationStatus" style="padding: 12px; background: #f3f4f6; border-radius: 8px; font-size: 13px; color: #64748b; font-family: monospace;">
                  Prêt à migrer
                </div>
              </div>

              <h3 style="margin-top: 24px; margin-bottom: 12px; font-size: 18px; font-weight: 600;">⚡ Processus Actifs</h3>
              <div style="background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                <p style="font-size: 14px; color: #64748b; margin-bottom: 8px;">
                  <strong style="color: #1e40af;">${processes.length}</strong> processus en cours d'exécution
                </p>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                  ${processes.map(p => `<span style="padding: 6px 12px; background: #3b82f6; color: white; border-radius: 6px; font-size: 12px; font-weight: 600;">${p.name}</span>`).join('')}
                </div>
              </div>

              <h3 style="margin-top: 24px; margin-bottom: 12px; font-size: 18px; font-weight: 600;">Journal système</h3>
              <div style="max-height: 240px; overflow:auto; background:#0f172a; color:#e2e8f0; padding:16px; border-radius:8px; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.6;">
                ${logs.map(l => `<div style="margin-bottom: 4px;">[${new Date(l.timestamp).toLocaleTimeString()}] <b style="color: ${l.level === 'error' ? '#ef4444' : l.level === 'warn' ? '#f59e0b' : '#10b981'};">${l.level.toUpperCase()}</b> — ${l.message}</div>`).join("")}
              </div>

              <h3 style="margin-top: 24px; margin-bottom: 12px; font-size: 18px; font-weight: 600;">Performance & Métriques</h3>
              <pre style="background:#111827; color:#e2e8f0; padding:16px; border-radius:8px; max-height:200px; overflow:auto; font-size: 12px; line-height: 1.5;">${JSON.stringify(perf.summary, null, 2)}</pre>

              <h3 style="margin-top: 24px; margin-bottom: 12px; font-size: 18px; font-weight: 600;">Sécurité</h3>
              <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                <p style="margin-bottom: 8px;"><strong>Mode:</strong> ${window.__WEBOS_SECURITY__.offlineStrict ? 'Souverain Offline' : 'Standard'}</p>
                <p style="margin-bottom: 8px;"><strong>CSP:</strong> ${window.__WEBOS_SECURITY__.offlineStrict ? 'Activé (Durci)' : 'Désactivé'}</p>
                <p style="margin-bottom: 8px;"><strong>Version:</strong> ${window.__WEBOS_SECURITY__.version}</p>
                <p><strong>État réseau:</strong> ${navigator.onLine ? 'En ligne' : 'Hors ligne'}</p>
              </div>

              <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button onclick="WebOS.Apps.TaskManager.open();" style="flex: 1; padding: 12px; background:#3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">Task Manager</button>
                <button onclick="PerformanceMonitor.clear(); alert('Métriques purgées');" style="flex: 1; padding: 12px; background:#ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">Purger métriques</button>
                <button onclick="Logger.clearLogs(); alert('Logs purgés');" style="flex: 1; padding: 12px; background:#f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">Purger logs</button>
                <button onclick="location.reload();" style="flex: 1; padding: 12px; background:#10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">Redémarrer</button>
              </div>
            </div>
          `;
          WindowManager.create("admin-panel", "Console d'administration", html, { width: 900, height: 750 });
        }
      },
      Portal: {
        open() {
          const content = `
            <div style="padding: 20px;">
              <h2 style="font-size: 24px; font-weight: 700; color: #1e40af; margin-bottom: 20px;">Portail Citoyen</h2>

              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 24px; border-radius: 12px; cursor: pointer;" onclick="alert('Service Santé')">
                  <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">● Santé</h3>
                  <p style="font-size: 14px; opacity: 0.9;">Dossier médical, rendez-vous</p>
                </div>

                <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 24px; border-radius: 12px; cursor: pointer;" onclick="alert('Service Éducation')">
                  <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">● Éducation</h3>
                  <p style="font-size: 14px; opacity: 0.9;">Dossier scolaire, inscriptions</p>
                </div>

                <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 24px; border-radius: 12px; cursor: pointer;" onclick="alert('Service Transport')">
                  <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">● Transport</h3>
                  <p style="font-size: 14px; opacity: 0.9;">Permis, immatriculation</p>
                </div>

                <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 24px; border-radius: 12px; cursor: pointer;" onclick="alert('Service Fiscalité')">
                  <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">● Fiscalité</h3>
                  <p style="font-size: 14px; opacity: 0.9;">Impôts, déclarations</p>
                </div>

                <div style="background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; padding: 24px; border-radius: 12px; cursor: pointer;" onclick="WebOS.Apps.Mail.open()">
                  <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">● Courriel</h3>
                  <p style="font-size: 14px; opacity: 0.9;">Boîte de réception, messages</p>
                </div>
              </div>

              <div id="notificationsContainer" style="margin-top: 30px; padding: 20px; background: #f3f4f6; border-radius: 12px;">
                <h3 style="font-size: 18px; font-weight: 600; color: #1f2937; margin-bottom: 12px;">Notifications récentes</h3>
                <div id="notificationsList" style="display: flex; flex-direction: column; gap: 10px;">
                  <div style="padding: 20px; text-align: center; color: #9ca3af;">Chargement des notifications...</div>
                </div>
              </div>
            </div>
          `;
          WindowManager.create('portal', 'Portail Citoyen', content, { width: 800, height: 600 });
          setTimeout(() => Notifications.loadNotifications(), 100);
        }
      },

      Files: {
        async open() {
          const files = await FileSystem.listFiles();
          const fileList = AdvancedFileManager.generateFileListHTML(files);

          const content = `
            <div style="height: 100%; display: flex; flex-direction: column;">
              <input type="file" id="fileImportInput" style="display: none;" onchange="AdvancedFileManager.handleFileImport(event)" multiple>

              <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                <button class="btn" style="width: auto; padding: 10px 18px; font-size: 14px; background: #10b981; font-weight: 600;" onclick="document.getElementById('fileImportInput').click()">
                  ⬆ Importer
                </button>
                <button class="btn" style="width: auto; padding: 10px 18px; font-size: 14px; font-weight: 600;" onclick="WebOS.Apps.Files.newFile()">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline-block;vertical-align:middle;margin-right:4px"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Nouveau
                </button>
                <button class="btn" style="width: auto; padding: 10px 18px; font-size: 14px; background: #6b7280; font-weight: 600;" onclick="WebOS.Apps.Files.refresh()">
                  ↻ Actualiser
                </button>
                <div style="flex: 1;"></div>
                <div style="padding: 10px 16px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border-radius: 8px; font-size: 14px; font-weight: 600; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);">
                  ${files.length} fichier(s)
                </div>
              </div>

              <div id="dropZone" style="flex: 1; overflow-y: auto; border: 2px dashed #d1d5db; border-radius: 12px; padding: 20px; background: #fafafa; transition: all 0.2s;"
                   ondrop="AdvancedFileManager.handleDrop(event)"
                   ondragover="AdvancedFileManager.handleDragOver(event)"
                   ondragleave="AdvancedFileManager.handleDragLeave(event)">
                <div id="fileList">
                  ${fileList}
                </div>
              </div>

              <div style="margin-top: 16px; padding: 12px; background: #f3f4f6; border-radius: 8px; font-size: 13px; color: #6b7280; text-align: center;">
                → Glissez-déposez des fichiers pour les importer rapidement
              </div>
            </div>
          `;

          WindowManager.create('files', '⊡ Gestionnaire de fichiers', content, { width: 900, height: 700 });
        },

        async newFile() {
          const name = prompt('Nom du fichier (avec extension):');
          if (name) {
            const ext = name.split('.').pop().toLowerCase();
            let defaultContent = '';

            if (ext === 'json') {
              defaultContent = '{\n  "titre": "Nouveau document",\n  "contenu": ""\n}';
            } else if (ext === 'md') {
              defaultContent = '# Nouveau Document\n\n## Introduction\n\nContenu...';
            } else if (ext === 'html') {
              defaultContent = '<!DOCTYPE html>\n<html>\n<head>\n  <title>Document</title>\n</head>\n<body>\n  <h1>Contenu</h1>\n</body>\n</html>';
            } else if (ext === 'csv') {
              defaultContent = 'nom,prénom,email\nDupont,Jean,jean@example.com';
            } else {
              defaultContent = '';
            }

            await FileSystem.writeFile(name, defaultContent);
            await Notifications.createNotification(
              'Fichier créé',
              name,
              'success',
              'files'
            );
            this.refresh();
          }
        },

        async refresh() {
          const files = await FileSystem.listFiles();
          const fileList = AdvancedFileManager.generateFileListHTML(files);

          const listEl = document.getElementById('fileList');
          if (listEl) {
            listEl.innerHTML = fileList;
          }

          const counterEl = document.querySelector('[style*="gradient"]');
          if (counterEl) {
            counterEl.textContent = `${files.length} fichier(s)`;
          }
        }
      },

      AIChat: {
        conversations: [],
        currentMessages: [],
        ttsEnabled: false,
        ttsVoice: null,
        currentUtterance: null,

        initTTS() {
          if ('speechSynthesis' in window) {
            const voices = speechSynthesis.getVoices();
            this.ttsVoice = voices.find(v => v.lang.startsWith('fr')) || voices[0];

            if (voices.length === 0) {
              speechSynthesis.addEventListener('voiceschanged', () => {
                const newVoices = speechSynthesis.getVoices();
                this.ttsVoice = newVoices.find(v => v.lang.startsWith('fr')) || newVoices[0];
              });
            }
          }
        },

        toggleTTS() {
          this.ttsEnabled = !this.ttsEnabled;

          if (!this.ttsEnabled && this.currentUtterance) {
            speechSynthesis.cancel();
            this.currentUtterance = null;
          }

          const btn = document.querySelector('[onclick="WebOS.Apps.AIChat.toggleTTS()"]');
          if (btn) {
            btn.style.background = this.ttsEnabled ? '#10b981' : '#6b7280';
            btn.title = this.ttsEnabled ? 'Désactiver TTS' : 'Activer TTS';
            btn.innerHTML = `
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                ${this.ttsEnabled ? '<path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>' : '<line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line>'}
              </svg>
            `;
          }
        },

        speak(text) {
          if (!this.ttsEnabled || !('speechSynthesis' in window)) return;

          speechSynthesis.cancel();

          this.currentUtterance = new SpeechSynthesisUtterance(text);
          this.currentUtterance.lang = 'fr-CA';
          this.currentUtterance.rate = 1.0;
          this.currentUtterance.pitch = 1.0;

          if (this.ttsVoice) {
            this.currentUtterance.voice = this.ttsVoice;
          }

          this.currentUtterance.onend = () => {
            this.currentUtterance = null;
          };

          speechSynthesis.speak(this.currentUtterance);
        },

        async open() {
          this.currentMessages = [
            {
              role: 'system',
              content: 'Tu es un assistant IA intégré au WebOS Québec, un système d\'exploitation gouvernemental souverain. Tu aides les citoyens avec leurs questions et tâches. Réponds toujours en français.'
            }
          ];

          const content = `
            <div style="display: flex; flex-direction: column; height: 100%;">
              <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px;">
                <div class="chat-message assistant">
                  Bonjour! Je suis votre assistant IA local. Comment puis-je vous aider aujourd'hui?
                </div>
              </div>
              <div style="padding: 16px; border-top: 2px solid #e5e7eb; display: flex; gap: 10px; align-items: center;">
                <button class="btn" style="width: 48px; height: 48px; padding: 0; background: #6b7280; border-radius: 8px;" onclick="WebOS.Apps.AIChat.toggleTTS()" title="Activer TTS">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <line x1="23" y1="9" x2="17" y2="15"></line>
                    <line x1="17" y1="9" x2="23" y2="15"></line>
                  </svg>
                </button>
                <input type="text" id="chatInput" placeholder="Votre message..." style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;" onkeypress="if(event.key==='Enter') WebOS.Apps.AIChat.send()" />
                <button class="btn" style="width: auto; padding: 12px 24px;" onclick="WebOS.Apps.AIChat.send()">Envoyer</button>
              </div>
            </div>
          `;

          WindowManager.create('aichat', 'Assistant IA - Llama 3.2 3B', content, { width: 700, height: 600 });

          this.initTTS();

          if (!AI.isReady()) {
            this.addMessage('system', 'Initialisation de l\'IA en cours...');
            await AI.initialize();
            this.addMessage('system', 'IA prête!');
          }
        },

        addMessage(role, content) {
          const chatMessages = document.getElementById('chatMessages');
          if (!chatMessages) return;

          const div = document.createElement('div');
          div.className = `chat-message ${role === 'user' ? 'user' : 'assistant'}`;
          div.textContent = content;
          chatMessages.appendChild(div);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        },

        updateLastMessage(content) {
          const chatMessages = document.getElementById('chatMessages');
          if (!chatMessages) return;

          const lastMsg = chatMessages.lastElementChild;
          if (lastMsg && lastMsg.classList.contains('assistant')) {
            lastMsg.textContent = content;
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        },

        async send() {
          const input = document.getElementById('chatInput');
          if (!input || !input.value.trim()) return;

          const userMessage = input.value.trim();
          input.value = '';

          this.addMessage('user', userMessage);
          this.currentMessages.push({ role: 'user', content: userMessage });

          this.addMessage('assistant', '...');

          try {
            await AI.chat(this.currentMessages, (response) => {
              this.updateLastMessage(response);
            });

            const lastResponse = document.getElementById('chatMessages').lastElementChild.textContent;
            this.currentMessages.push({ role: 'assistant', content: lastResponse });

            if (this.ttsEnabled) {
              this.speak(lastResponse);
            }

            // Save to Supabase
            if (currentUser) {
              await supabaseClient.from('ai_conversations').upsert({
                user_id: currentUser.id,
                model_name: CONFIG.webllm.model,
                messages: this.currentMessages,
                updated_at: new Date().toISOString()
              });
            }
          } catch (error) {
            this.updateLastMessage('Erreur: ' + error.message);
          }
        }
      },

      HTMLEditor: {
        state: {
          htmlCode: '',
          activeDevice: 'desktop',
          showPreview: false,
          consoleLogs: [],
          logIdCounter: 0,
          zoomLevel: 100,
          currentBlobUrl: null
        },

        devices: {
          desktop: { width: '100%', height: '100%', label: 'Desktop' },
          tablet: { width: '768px', height: '1024px', label: 'Tablet' },
          mobile: { width: '375px', height: '667px', label: 'Mobile' }
        },

        defaultHTML: `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Preview</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      min-height: 100vh; display: flex; align-items: center; justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; padding: 2rem;
    }
    .container { text-align: center; max-width: 600px; }
    h1 { font-size: 3rem; margin-bottom: 1rem; animation: fadeIn 1s ease-in; }
    p { font-size: 1.25rem; opacity: 0.9; line-height: 1.6; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Welcome!</h1>
    <p>Paste your HTML code in the editor to see it come to life.</p>
  </div>
</body>
</html>`,

        async openFile(filename) {
          const content = await FileSystem.readFile(filename);
          this.open(content, filename);
        },

        open(initialContent = '', filename = null) {
          this.state = {
            htmlCode: initialContent,
            activeDevice: 'desktop',
            showPreview: false,
            consoleLogs: [],
            logIdCounter: 0,
            zoomLevel: 100,
            currentFilename: filename
          };

          const content = `
            <div style="height: 100%; display: flex; flex-direction: column;">
              <div style="display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; padding-bottom: 16px; border-bottom: 2px solid #e5e7eb;">
                <div style="display: flex; gap: 6px; background: #f3f4f6; border-radius: 8px; padding: 6px;">
                  <button class="device-btn" data-device="desktop" onclick="WebOS.Apps.HTMLEditor.setDevice('desktop')" style="padding: 8px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;" title="Desktop">
                    🖥️
                  </button>
                  <button class="device-btn" data-device="tablet" onclick="WebOS.Apps.HTMLEditor.setDevice('tablet')" style="padding: 8px 12px; background: transparent; color: #64748b; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;" title="Tablet">
                    📱
                  </button>
                  <button class="device-btn" data-device="mobile" onclick="WebOS.Apps.HTMLEditor.setDevice('mobile')" style="padding: 8px 12px; background: transparent; color: #64748b; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;" title="Mobile">
                    📱
                  </button>
                </div>

                <button class="btn" style="width: auto; padding: 10px 18px; font-size: 14px; background: #10b981; font-weight: 600;" onclick="WebOS.Apps.HTMLEditor.fixCode()">
                  ✨ Corriger
                </button>

                <button class="btn" style="width: auto; padding: 10px 18px; font-size: 14px; background: #3b82f6; font-weight: 600;" onclick="WebOS.Apps.HTMLEditor.preview()">
                  ▶ Preview
                </button>

                ${filename ? `
                  <button class="btn" style="width: auto; padding: 10px 18px; font-size: 14px; background: #10b981; font-weight: 600;" onclick="WebOS.Apps.HTMLEditor.saveToFile()">
                    💾 Enregistrer
                  </button>
                ` : ''}

                <button class="btn" style="width: auto; padding: 10px 18px; font-size: 14px; background: #8b5cf6; font-weight: 600;" onclick="WebOS.Apps.HTMLEditor.exportFile()">
                  ⬇ Exporter
                </button>

                <button class="btn" style="width: auto; padding: 10px 18px; font-size: 14px; background: #ef4444; font-weight: 600;" onclick="WebOS.Apps.HTMLEditor.clear()">
                  🗑️ Clear
                </button>
              </div>

              <div id="htmlEditorContainer" style="flex: 1; display: flex; gap: 16px; min-height: 0;">
                <div style="flex: 1; display: flex; flex-direction: column; min-width: 0;">
                  <div style="padding: 8px 12px; background: #f3f4f6; border-radius: 8px 8px 0 0; font-size: 13px; font-weight: 600; color: #64748b;">
                    HTML Code
                  </div>
                  <textarea id="htmlEditorTextarea" placeholder="Paste your complete HTML code here..." style="flex: 1; width: 100%; background: #1e293b; color: #e2e8f0; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 13px; padding: 16px; border: none; resize: none; outline: none; border-radius: 0 0 8px 8px;" spellcheck="false"></textarea>
                </div>

                <div id="previewSection" style="display: none; flex: 1; flex-direction: column; min-width: 0; background: #f8fafc; border-radius: 8px; overflow: hidden;">
                  <div style="padding: 8px 12px; background: #1e40af; color: white; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 13px; font-weight: 600;" id="deviceLabel">Live Preview — Desktop</span>
                    <div style="display: flex; gap: 8px; align-items: center;">
                      <button onclick="WebOS.Apps.HTMLEditor.zoomOut()" style="padding: 4px 8px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 4px; cursor: pointer; font-size: 12px;">-</button>
                      <span id="zoomLevel" style="font-size: 12px; font-family: monospace; min-width: 3rem; text-align: center;">100%</span>
                      <button onclick="WebOS.Apps.HTMLEditor.zoomIn()" style="padding: 4px 8px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 4px; cursor: pointer; font-size: 12px;">+</button>
                      <button onclick="WebOS.Apps.HTMLEditor.zoomReset()" style="padding: 4px 8px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 4px; cursor: pointer; font-size: 12px;">↻</button>
                    </div>
                  </div>
                  <div style="flex: 1; overflow: auto; padding: 16px; display: flex; align-items: center; justify-content: center; background: #e5e7eb;">
                    <div id="previewFrameWrapper" style="background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: all 0.3s; overflow: hidden;">
                      <div id="previewFrame" style="width: 100%; height: 100%; overflow: auto; position: relative;"></div>
                    </div>
                  </div>
                </div>

                <div id="consoleSection" style="display: none; flex: 1; flex-direction: column; min-width: 0; background: #0f172a; border-radius: 8px; overflow: hidden;">
                  <div style="padding: 8px 12px; background: #1e293b; color: white; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 13px; font-weight: 600;">Console</span>
                    <button onclick="WebOS.Apps.HTMLEditor.clearConsole()" style="padding: 4px 12px; background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 4px; cursor: pointer; font-size: 11px;">Clear</button>
                  </div>
                  <div id="consoleLogs" style="flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px; font-family: monospace; font-size: 11px;">
                    <div style="text-align: center; color: #64748b; padding: 20px;">Console output will appear here</div>
                  </div>
                </div>
              </div>
            </div>
          `;

          const title = filename ? `⚡ HTML Editor — ${filename}` : '⚡ HTML Live Preview Editor';
          WindowManager.create('htmleditor', title, content, { width: 1200, height: 800 });

          setTimeout(() => {
            const textarea = document.getElementById('htmlEditorTextarea');
            if (textarea) {
              textarea.value = this.state.htmlCode;
              textarea.addEventListener('input', (e) => {
                this.state.htmlCode = e.target.value;
              });
            }
          }, 100);
        },

        setDevice(device) {
          this.state.activeDevice = device;
          document.querySelectorAll('.device-btn').forEach(btn => {
            const btnDevice = btn.getAttribute('data-device');
            if (btnDevice === device) {
              btn.style.background = '#3b82f6';
              btn.style.color = 'white';
            } else {
              btn.style.background = 'transparent';
              btn.style.color = '#64748b';
            }
          });
          this.updateDeviceSize();
          const deviceConfig = this.devices[device];
          const label = document.getElementById('deviceLabel');
          if (label) label.textContent = `Live Preview — ${deviceConfig.label}`;
        },

        updateDeviceSize() {
          const wrapper = document.getElementById('previewFrameWrapper');
          if (!wrapper) return;
          const device = this.devices[this.state.activeDevice];
          wrapper.style.width = device.width;
          wrapper.style.height = device.height;
          wrapper.style.maxWidth = '100%';
          wrapper.style.maxHeight = '100%';
        },

        preview() {
          this.state.showPreview = true;
          const previewSection = document.getElementById('previewSection');
          const consoleSection = document.getElementById('consoleSection');
          if (previewSection) previewSection.style.display = 'flex';
          if (consoleSection) consoleSection.style.display = 'flex';
          this.updatePreview();
        },

        updatePreview() {
          if (!this.state.showPreview) return;

          const htmlContent = this.state.htmlCode || this.defaultHTML;
          const frame = document.getElementById('previewFrame');
          if (!frame) return;

          this.state.consoleLogs = [];
          this.state.logIdCounter = 0;
          this.renderConsole();

          const scale = this.state.zoomLevel / 100;
          const inverseScale = 100 / (this.state.zoomLevel / 100);

          const wrappedHTML = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: auto;
      transform-origin: top left;
      transform: scale(${scale});
      width: ${inverseScale}%;
      height: ${inverseScale}%;
    }
  </style>
</head>
<body>
  ${htmlContent}
  <script>
    try {
      if (window.parent && window.parent.WebOS && window.parent.WebOS.Apps.HTMLEditor) {
        window.parent.WebOS.Apps.HTMLEditor.setupConsoleCapture(window);
      }
    } catch(e) {}
  <\/script>
</body>
</html>`;

          frame.innerHTML = '';

          const iframe = document.createElement('iframe');
          iframe.sandbox = 'allow-scripts allow-same-origin';
          iframe.style.cssText = 'width: 100%; height: 100%; border: none; background: white;';

          frame.appendChild(iframe);

          setTimeout(() => {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(wrappedHTML);
            iframeDoc.close();
          }, 0);

          this.updateDeviceSize();
        },

        setupConsoleCapture(win) {
          if (!win) return;

          try {
            win.console.log = (...args) => this.addLog('log', args);
            win.console.error = (...args) => this.addLog('error', args);
            win.console.warn = (...args) => this.addLog('warn', args);
            win.console.info = (...args) => this.addLog('info', args);

            win.onerror = (message, source, lineno, colno, error) => {
              this.addLog('error', [message], error?.stack);
              return true;
            };

            win.onunhandledrejection = (event) => {
              this.addLog('error', ['Unhandled Promise:', event.reason]);
            };
          } catch (err) {
            console.warn('Cannot capture console:', err);
          }
        },

        addLog(type, args, stack = null) {
          const message = args.map(arg => {
            if (typeof arg === 'object') {
              try {
                return JSON.stringify(arg, null, 2);
              } catch {
                return String(arg);
              }
            }
            return String(arg);
          }).join(' ');

          this.state.consoleLogs.push({
            id: this.state.logIdCounter++,
            type,
            message,
            timestamp: new Date(),
            stack
          });

          this.renderConsole();
        },

        renderConsole() {
          const container = document.getElementById('consoleLogs');
          if (!container) return;

          if (this.state.consoleLogs.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 20px;">Console output will appear here</div>';
            return;
          }

          const colors = {
            log: { bg: 'rgba(100, 116, 139, 0.1)', border: 'rgba(100, 116, 139, 0.3)', text: '#cbd5e1' },
            error: { bg: 'rgba(239, 68, 68, 0.1)', border: 'rgba(239, 68, 68, 0.3)', text: '#fca5a5' },
            warn: { bg: 'rgba(245, 158, 11, 0.1)', border: 'rgba(245, 158, 11, 0.3)', text: '#fcd34d' },
            info: { bg: 'rgba(59, 130, 246, 0.1)', border: 'rgba(59, 130, 246, 0.3)', text: '#93c5fd' }
          };

          container.innerHTML = this.state.consoleLogs.map(log => {
            const color = colors[log.type];
            return `
              <div style="padding: 8px 12px; background: ${color.bg}; border: 1px solid ${color.border}; border-radius: 6px; color: ${color.text};">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span style="font-weight: 600; text-transform: uppercase; font-size: 10px;">${log.type}</span>
                  <span style="font-size: 10px; opacity: 0.6;">${log.timestamp.toLocaleTimeString()}</span>
                </div>
                <pre style="white-space: pre-wrap; word-break: break-word; margin: 0;">${log.message}</pre>
                ${log.stack ? `<pre style="margin-top: 8px; font-size: 10px; opacity: 0.7; border-top: 1px solid currentColor; padding-top: 8px; white-space: pre-wrap;">${log.stack}</pre>` : ''}
              </div>
            `;
          }).join('');

          container.scrollTop = container.scrollHeight;
        },

        clearConsole() {
          this.state.consoleLogs = [];
          this.renderConsole();
        },

        zoomIn() {
          this.state.zoomLevel = Math.min(this.state.zoomLevel + 10, 300);
          this.updateZoom();
        },

        zoomOut() {
          this.state.zoomLevel = Math.max(this.state.zoomLevel - 10, 10);
          this.updateZoom();
        },

        zoomReset() {
          this.state.zoomLevel = 100;
          this.updateZoom();
        },

        updateZoom() {
          const label = document.getElementById('zoomLevel');
          if (label) label.textContent = this.state.zoomLevel + '%';
          this.updatePreview();
        },

        async fixCode() {
          if (!this.state.htmlCode.trim()) {
            alert('Aucun code à corriger');
            return;
          }

          let corrected = this.state.htmlCode;

          if (!corrected.includes('<!DOCTYPE html>')) {
            corrected = '<!DOCTYPE html>\\n' + corrected;
          }

          if (!corrected.includes('<html')) {
            corrected = corrected.replace('<!DOCTYPE html>', '<!DOCTYPE html>\\n<html lang="en">');
            if (!corrected.includes('</html>')) {
              corrected += '\\n</html>';
            }
          }

          if (!corrected.includes('<head>')) {
            const htmlMatch = corrected.match(/<html[^>]*>/i);
            if (htmlMatch) {
              const pos = corrected.indexOf(htmlMatch[0]) + htmlMatch[0].length;
              corrected = corrected.slice(0, pos) +
                '\\n<head>\\n  <meta charset="UTF-8">\\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\\n  <title>Document</title>\\n</head>' +
                corrected.slice(pos);
            }
          } else {
            if (!corrected.includes('charset')) {
              corrected = corrected.replace(/<head>/i, '<head>\\n  <meta charset="UTF-8">');
            }
            if (!corrected.includes('viewport')) {
              corrected = corrected.replace(/<head>/i, '<head>\\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">');
            }
          }

          if (!corrected.includes('<body>')) {
            const headCloseIndex = corrected.indexOf('</head>');
            if (headCloseIndex !== -1) {
              corrected = corrected.slice(0, headCloseIndex + 7) + '\\n<body>\\n' + corrected.slice(headCloseIndex + 7);
              if (!corrected.includes('</body>')) {
                const htmlCloseIndex = corrected.lastIndexOf('</html>');
                if (htmlCloseIndex !== -1) {
                  corrected = corrected.slice(0, htmlCloseIndex) + '</body>\\n' + corrected.slice(htmlCloseIndex);
                }
              }
            }
          }

          this.state.htmlCode = corrected;
          const textarea = document.getElementById('htmlEditorTextarea');
          if (textarea) textarea.value = corrected;

          await Notifications.createNotification(
            'Code corrigé',
            'Le code HTML a été automatiquement corrigé',
            'success',
            'htmleditor'
          );
        },

        async exportFile() {
          const title = prompt('Titre du fichier:');
          if (!title || !title.trim()) return;

          const timestamp = new Date().toISOString();
          let geo = null;

          if ('geolocation' in navigator) {
            try {
              const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject);
              });
              geo = { latitude: position.coords.latitude, longitude: position.coords.longitude };
            } catch {
              geo = null;
            }
          }

          const geoStr = geo ? `${geo.latitude}, ${geo.longitude}` : 'Non disponible';
          const metadata = `
<!--
  Fichier: ${title}
  Créé le: ${timestamp}
  Géolocalisation: ${geoStr}
  © ${new Date().getFullYear()} William Michaud (WM) - Tous droits réservés
  ~ Micho
-->
`;

          const htmlContent = this.state.htmlCode || this.defaultHTML;
          const finalHTML = htmlContent.replace('<!DOCTYPE html>', `<!DOCTYPE html>${metadata}`);

          const blob = new Blob([finalHTML], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          const filename = title.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '_' + Date.now() + '.html';
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          await Notifications.createNotification(
            'Fichier exporté',
            title + '.html',
            'success',
            'htmleditor'
          );
        },

        async saveToFile() {
          if (!this.state.currentFilename) {
            alert('Aucun fichier ouvert');
            return;
          }

          await FileSystem.writeFile(this.state.currentFilename, this.state.htmlCode);

          await Notifications.createNotification(
            'Fichier enregistré',
            this.state.currentFilename,
            'success',
            'htmleditor'
          );
        },

        clear() {
          this.state.htmlCode = '';
          this.state.showPreview = false;
          this.state.consoleLogs = [];
          const textarea = document.getElementById('htmlEditorTextarea');
          if (textarea) textarea.value = '';
          const previewSection = document.getElementById('previewSection');
          const consoleSection = document.getElementById('consoleSection');
          if (previewSection) previewSection.style.display = 'none';
          if (consoleSection) consoleSection.style.display = 'none';
        }
      },

      Terminal: {
        history: [],
        historyIndex: -1,
        currentDir: '/',
        environment: {
          USER: 'webos',
          HOME: '/home/webos',
          PATH: '/usr/local/bin:/usr/bin:/bin',
          SHELL: '/bin/bash',
          TERM: 'xterm-256color',
          LANG: 'fr_CA.UTF-8'
        },

        open() {
          const content = `
            <div class="terminal">
              <div id="terminalOutput">
                <div class="terminal-line">WebOS Québec Terminal v2.0 - Advanced Shell</div>
                <div class="terminal-line">Tapez 'help' pour voir les commandes disponibles</div>
                <div class="terminal-line">Tapez 'man &lt;commande&gt;' pour le manuel d'une commande</div>
                <div class="terminal-line"></div>
              </div>
              <div class="terminal-input">
                <span id="terminalPrompt">webos@quebec:~$</span>
                <input type="text" id="terminalInput" onkeydown="WebOS.Apps.Terminal.handleKey(event)" autocomplete="off" spellcheck="false" />
              </div>
            </div>
          `;

          WindowManager.create('terminal', 'Terminal', content, { width: 800, height: 600 });
          document.getElementById('terminalInput').focus();
        },

        handleKey(e) {
          if (e.key === 'Enter') {
            this.execute();
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (this.historyIndex < this.history.length - 1) {
              this.historyIndex++;
              e.target.value = this.history[this.history.length - 1 - this.historyIndex];
            }
          } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (this.historyIndex > 0) {
              this.historyIndex--;
              e.target.value = this.history[this.history.length - 1 - this.historyIndex];
            } else {
              this.historyIndex = -1;
              e.target.value = '';
            }
          }
        },

        async execute() {
          const input = document.getElementById('terminalInput');
          if (!input) return;

          const command = input.value.trim();
          if (!command) {
            this.writeLine('');
            return;
          }

          this.history.push(command);
          this.historyIndex = -1;

          const prompt = document.getElementById('terminalPrompt')?.textContent || '$';
          this.writeLine(`${prompt} ${command}`);
          input.value = '';

          const parts = command.split(' ').filter(p => p);
          let cmd = parts[0];
          const args = parts.slice(1);

          if (cmd.startsWith('/')) {
            cmd = cmd.substring(1);
          }

          try {
            await this.executeCommand(cmd, args);
          } catch (error) {
            this.writeLine(`Erreur: ${error.message}`);
          }

          this.writeLine('');
        },

        async executeCommand(cmd, args) {
          switch (cmd) {
            case 'help':
              this.showHelp();
              break;

            case 'man':
              this.showManual(args[0]);
              break;

            case 'clear':
            case 'cls':
              document.getElementById('terminalOutput').innerHTML = '';
              break;

            case 'ls':
            case 'll':
              await this.cmdList(args);
              break;

            case 'cat':
              await this.cmdCat(args);
              break;

            case 'head':
              await this.cmdHead(args);
              break;

            case 'tail':
              await this.cmdTail(args);
              break;

            case 'grep':
              await this.cmdGrep(args);
              break;

            case 'wc':
              await this.cmdWordCount(args);
              break;

            case 'find':
              await this.cmdFind(args);
              break;

            case 'echo':
              this.writeLine(args.join(' '));
              break;

            case 'printf':
              this.writeLine(args.join(' ').replace(/\\n/g, '\n').replace(/\\t/g, '\t'));
              break;

            case 'date':
              this.cmdDate(args);
              break;

            case 'cal':
              this.cmdCalendar(args);
              break;

            case 'whoami':
              this.writeLine(currentUser ? currentUser.email.split('@')[0] : 'guest');
              break;

            case 'hostname':
              this.writeLine('webos-quebec.local');
              break;

            case 'uname':
              this.cmdUname(args);
              break;

            case 'uptime':
              this.cmdUptime();
              break;

            case 'free':
              this.cmdFree();
              break;

            case 'df':
              this.cmdDiskFree();
              break;

            case 'du':
              await this.cmdDiskUsage(args);
              break;

            case 'ps':
            case 'top':
              this.cmdProcesses();
              break;

            case 'kill':
              this.cmdKill(args);
              break;

            case 'pwd':
              this.writeLine(this.currentDir);
              break;

            case 'cd':
              this.cmdChangeDir(args);
              break;

            case 'mkdir':
              await this.cmdMakeDir(args);
              break;

            case 'rmdir':
              await this.cmdRemoveDir(args);
              break;

            case 'touch':
              await this.cmdTouch(args);
              break;

            case 'rm':
              await this.cmdRemove(args);
              break;

            case 'cp':
              await this.cmdCopy(args);
              break;

            case 'mv':
              await this.cmdMove(args);
              break;

            case 'chmod':
              this.writeLine('chmod: permissions non implémentées dans WebOS');
              break;

            case 'chown':
              this.writeLine('chown: ownership non implémenté dans WebOS');
              break;

            case 'env':
            case 'printenv':
              this.cmdEnv(args);
              break;

            case 'export':
              this.cmdExport(args);
              break;

            case 'alias':
              this.writeLine('alias: non implémenté');
              break;

            case 'history':
              this.cmdHistory();
              break;

            case 'which':
              this.cmdWhich(args);
              break;

            case 'whereis':
              this.writeLine(`${args[0]}: /usr/bin/${args[0]}`);
              break;

            case 'file':
              await this.cmdFile(args);
              break;

            case 'stat':
              await this.cmdStat(args);
              break;

            case 'wget':
            case 'curl':
              this.writeLine(`${cmd}: commande réseau non disponible`);
              break;

            case 'ping':
              this.cmdPing(args);
              break;

            case 'ifconfig':
            case 'ip':
              this.cmdNetwork();
              break;

            case 'netstat':
              this.cmdNetstat();
              break;

            case 'tar':
            case 'zip':
            case 'unzip':
              this.writeLine(`${cmd}: utilitaire d'archive non implémenté`);
              break;

            case 'diff':
              this.writeLine('diff: comparaison de fichiers non implémentée');
              break;

            case 'sort':
            case 'uniq':
            case 'cut':
            case 'paste':
            case 'tr':
            case 'sed':
            case 'awk':
              this.writeLine(`${cmd}: utilitaire de traitement de texte non implémenté`);
              break;

            case 'nano':
            case 'vi':
            case 'vim':
            case 'emacs':
              this.writeLine(`${cmd}: éditeur non disponible. Utilisez l'application Éditeur de Texte`);
              break;

            case 'sudo':
              this.writeLine('sudo: WebOS n\'a pas besoin de sudo - vous avez déjà tous les privilèges');
              break;

            case 'su':
              this.writeLine('su: changement d\'utilisateur non disponible');
              break;

            case 'reboot':
            case 'shutdown':
              this.writeLine(`${cmd}: redémarrage système non disponible. Fermez l'onglet.`);
              break;

            case 'exit':
            case 'logout':
              this.writeLine('Fermeture du terminal...');
              setTimeout(() => {
                const win = document.querySelector('[data-window-id="terminal"]');
                if (win) WindowManager.close('terminal');
              }, 500);
              break;

            default:
              this.writeLine(`bash: ${cmd}: commande introuvable`);
              this.writeLine(`Tapez 'help' pour voir les commandes disponibles`);
          }
        },

        showHelp() {
          this.writeLine('Commandes système disponibles:');
          this.writeLine('');
          this.writeLine('Gestion de fichiers:');
          this.writeLine('  /ls, /ll         - Liste les fichiers et répertoires');
          this.writeLine('  /cat             - Affiche le contenu d\'un fichier');
          this.writeLine('  /head, /tail     - Affiche le début/fin d\'un fichier');
          this.writeLine('  /grep            - Recherche dans un fichier');
          this.writeLine('  /wc              - Compte mots/lignes/caractères');
          this.writeLine('  /find            - Recherche de fichiers');
          this.writeLine('  /pwd             - Affiche le répertoire courant');
          this.writeLine('  /cd              - Change de répertoire');
          this.writeLine('  /mkdir           - Crée un répertoire');
          this.writeLine('  /touch           - Crée un fichier vide');
          this.writeLine('  /rm              - Supprime fichier/répertoire');
          this.writeLine('  /cp              - Copie fichier');
          this.writeLine('  /mv              - Déplace/renomme fichier');
          this.writeLine('  /file            - Détermine le type de fichier');
          this.writeLine('  /stat            - Affiche les métadonnées');
          this.writeLine('');
          this.writeLine('Informations système:');
          this.writeLine('  /uname           - Informations système');
          this.writeLine('  /hostname        - Nom de l\'hôte');
          this.writeLine('  /whoami          - Utilisateur actuel');
          this.writeLine('  /uptime          - Temps de fonctionnement');
          this.writeLine('  /free            - Mémoire disponible');
          this.writeLine('  /df              - Espace disque');
          this.writeLine('  /du              - Utilisation disque');
          this.writeLine('  /date            - Date et heure');
          this.writeLine('  /cal             - Calendrier');
          this.writeLine('');
          this.writeLine('Processus:');
          this.writeLine('  /ps, /top        - Liste les processus');
          this.writeLine('  /kill            - Termine un processus');
          this.writeLine('');
          this.writeLine('Réseau:');
          this.writeLine('  /ping            - Test de connectivité');
          this.writeLine('  /ifconfig, /ip   - Configuration réseau');
          this.writeLine('  /netstat         - Statistiques réseau');
          this.writeLine('');
          this.writeLine('Autres:');
          this.writeLine('  /echo, /printf   - Affiche du texte');
          this.writeLine('  /env, /printenv  - Variables d\'environnement');
          this.writeLine('  /export          - Définit une variable');
          this.writeLine('  /history         - Historique des commandes');
          this.writeLine('  /which           - Localise une commande');
          this.writeLine('  /man             - Manuel d\'une commande');
          this.writeLine('  /clear, /cls     - Efface l\'écran');
          this.writeLine('  /exit, /logout   - Ferme le terminal');
        },

        showManual(cmd) {
          if (!cmd) {
            this.writeLine('Usage: man <commande>');
            return;
          }

          const manuals = {
            ls: 'ls - Liste le contenu des répertoires\n\nUSAGE: ls [OPTIONS]\n\nOPTIONS:\n  -l    Format long avec détails\n  -a    Affiche les fichiers cachés\n  -h    Taille lisible par humains',
            cat: 'cat - Concatène et affiche des fichiers\n\nUSAGE: cat <fichier>\n\nAffiche le contenu complet d\'un fichier',
            grep: 'grep - Recherche de motifs dans du texte\n\nUSAGE: grep <motif> <fichier>\n\nRecherche les lignes contenant le motif spécifié',
            date: 'date - Affiche ou définit la date système\n\nUSAGE: date [OPTIONS]\n\nOPTIONS:\n  (aucune)  Affiche date et heure actuelles',
            echo: 'echo - Affiche une ligne de texte\n\nUSAGE: echo [texte]\n\nAffiche le texte spécifié sur la sortie standard'
          };

          const manual = manuals[cmd];
          if (manual) {
            this.writeLine(manual);
          } else {
            this.writeLine(`Aucune entrée de manuel pour ${cmd}`);
          }
        },

        async cmdList(args) {
          const files = await FileSystem.listFiles();
          if (files.length === 0) {
            this.writeLine('(vide)');
            return;
          }

          const longFormat = args.includes('-l') || args.includes('--long');

          if (longFormat) {
            this.writeLine(`total ${files.length}`);
            files.forEach(f => {
              const date = new Date(f.lastModified || Date.now()).toISOString().split('T')[0];
              const size = f.size || 0;
              const type = f.kind === 'directory' ? 'd' : '-';
              const perms = f.kind === 'directory' ? 'rwxr-xr-x' : 'rw-r--r--';
              this.writeLine(`${type}${perms} 1 webos webos ${size.toString().padStart(8)} ${date} ${f.name}`);
            });
          } else {
            const names = files.map(f => f.kind === 'directory' ? f.name + '/' : f.name);
            this.writeLine(names.join('  '));
          }
        },

        async cmdCat(args) {
          if (args.length === 0) {
            this.writeLine('Usage: cat <filename>');
            return;
          }

          const content = await FileSystem.readFile(args[0]);
          if (content) {
            this.writeLine(content);
          } else {
            this.writeLine(`cat: ${args[0]}: Aucun fichier ou dossier de ce type`);
          }
        },

        async cmdHead(args) {
          if (args.length === 0) {
            this.writeLine('Usage: head <filename>');
            return;
          }

          const content = await FileSystem.readFile(args[0]);
          if (content) {
            const lines = content.split('\n').slice(0, 10);
            lines.forEach(line => this.writeLine(line));
          } else {
            this.writeLine(`head: ${args[0]}: Aucun fichier ou dossier de ce type`);
          }
        },

        async cmdTail(args) {
          if (args.length === 0) {
            this.writeLine('Usage: tail <filename>');
            return;
          }

          const content = await FileSystem.readFile(args[0]);
          if (content) {
            const lines = content.split('\n');
            const tail = lines.slice(Math.max(0, lines.length - 10));
            tail.forEach(line => this.writeLine(line));
          } else {
            this.writeLine(`tail: ${args[0]}: Aucun fichier ou dossier de ce type`);
          }
        },

        async cmdGrep(args) {
          if (args.length < 2) {
            this.writeLine('Usage: grep <motif> <fichier>');
            return;
          }

          const pattern = args[0];
          const filename = args[1];
          const content = await FileSystem.readFile(filename);

          if (content) {
            const lines = content.split('\n');
            const matches = lines.filter(line => line.includes(pattern));
            if (matches.length === 0) {
              this.writeLine(`(aucune correspondance)`);
            } else {
              matches.forEach(line => this.writeLine(line));
            }
          } else {
            this.writeLine(`grep: ${filename}: Aucun fichier ou dossier de ce type`);
          }
        },

        async cmdWordCount(args) {
          if (args.length === 0) {
            this.writeLine('Usage: wc <filename>');
            return;
          }

          const content = await FileSystem.readFile(args[0]);
          if (content) {
            const lines = content.split('\n').length;
            const words = content.split(/\s+/).filter(w => w).length;
            const chars = content.length;
            this.writeLine(`  ${lines}  ${words}  ${chars} ${args[0]}`);
          } else {
            this.writeLine(`wc: ${args[0]}: Aucun fichier ou dossier de ce type`);
          }
        },

        async cmdFind(args) {
          const files = await FileSystem.listFiles();
          if (args.length === 0) {
            files.forEach(f => this.writeLine(`./${f.name}`));
          } else {
            const pattern = args[0];
            const matches = files.filter(f => f.name.includes(pattern));
            matches.forEach(f => this.writeLine(`./${f.name}`));
          }
        },

        cmdDate(args) {
          const now = new Date();
          if (args.includes('--iso') || args.includes('-I')) {
            this.writeLine(now.toISOString());
          } else if (args.includes('--rfc-3339')) {
            this.writeLine(now.toISOString().replace('T', ' ').slice(0, -5));
          } else {
            this.writeLine(now.toString());
          }
        },

        cmdCalendar(args) {
          const now = new Date();
          const year = args[0] ? parseInt(args[0]) : now.getFullYear();
          const month = args[1] ? parseInt(args[1]) - 1 : now.getMonth();

          const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                             'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

          this.writeLine(`      ${monthNames[month]} ${year}`);
          this.writeLine('Di Lu Ma Me Je Ve Sa');

          const firstDay = new Date(year, month, 1).getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();

          let calendar = ' '.repeat(firstDay * 3);
          for (let day = 1; day <= daysInMonth; day++) {
            calendar += day.toString().padStart(2, ' ') + ' ';
            if ((firstDay + day) % 7 === 0) {
              this.writeLine(calendar);
              calendar = '';
            }
          }
          if (calendar) this.writeLine(calendar);
        },

        cmdUname(args) {
          if (args.includes('-a') || args.includes('--all')) {
            this.writeLine(`WebOS 2.0 webos-quebec ${navigator.platform} ${new Date().toISOString().split('T')[0]} x86_64 GNU/Linux`);
          } else if (args.includes('-s') || args.length === 0) {
            this.writeLine('WebOS');
          } else if (args.includes('-r')) {
            this.writeLine('2.0');
          } else if (args.includes('-m')) {
            this.writeLine('x86_64');
          } else if (args.includes('-p')) {
            this.writeLine(navigator.platform);
          }
        },

        cmdUptime() {
          const uptime = Math.floor(performance.now() / 1000);
          const hours = Math.floor(uptime / 3600);
          const minutes = Math.floor((uptime % 3600) / 60);
          const users = currentUser ? 1 : 0;
          this.writeLine(`up ${hours}:${minutes.toString().padStart(2, '0')}, ${users} utilisateur(s)`);
        },

        cmdFree() {
          const mem = performance.memory || {};
          const total = mem.jsHeapSizeLimit || 2147483648;
          const used = mem.usedJSHeapSize || 0;
          const free = total - used;

          this.writeLine('              total        used        free');
          this.writeLine(`Mem:    ${Math.floor(total/1048576).toString().padStart(11)} ${Math.floor(used/1048576).toString().padStart(11)} ${Math.floor(free/1048576).toString().padStart(11)} MB`);
        },

        cmdDiskFree() {
          this.writeLine('Filesystem      Size  Used  Avail Use% Mounted on');
          this.writeLine('/dev/webos      10G   2.5G   7.5G  25% /');
          this.writeLine('tmpfs           2G    512M   1.5G  25% /tmp');
        },

        async cmdDiskUsage(args) {
          const files = await FileSystem.listFiles();
          let total = 0;
          files.forEach(f => {
            const size = f.size || 0;
            total += size;
            this.writeLine(`${Math.ceil(size/1024)}K\t${f.name}`);
          });
          this.writeLine(`${Math.ceil(total/1024)}K\ttotal`);
        },

        cmdProcesses() {
          const procs = Kernel.getProcesses();
          this.writeLine('  PID  TTY          TIME CMD');
          procs.forEach(p => {
            this.writeLine(`${p.pid.toString().padStart(5)}  pts/0    00:00:00 ${p.name}`);
          });
        },

        cmdKill(args) {
          if (args.length === 0) {
            this.writeLine('Usage: kill <pid>');
            return;
          }

          const pid = parseInt(args[0]);
          const procs = Kernel.getProcesses();
          const proc = procs.find(p => p.pid === pid);

          if (proc) {
            this.writeLine(`Processus ${pid} terminé`);
            Kernel.killProcess(pid);
          } else {
            this.writeLine(`kill: (${pid}) - Aucun processus de ce type`);
          }
        },

        cmdChangeDir(args) {
          if (args.length === 0 || args[0] === '~') {
            this.currentDir = this.environment.HOME;
          } else if (args[0] === '..') {
            const parts = this.currentDir.split('/').filter(p => p);
            parts.pop();
            this.currentDir = '/' + parts.join('/');
          } else if (args[0].startsWith('/')) {
            this.currentDir = args[0];
          } else {
            this.currentDir = this.currentDir + '/' + args[0];
          }

          this.currentDir = this.currentDir.replace(/\/+/g, '/');
          if (!this.currentDir) this.currentDir = '/';

          const promptEl = document.getElementById('terminalPrompt');
          if (promptEl) {
            const displayDir = this.currentDir === this.environment.HOME ? '~' : this.currentDir;
            promptEl.textContent = `webos@quebec:${displayDir}$`;
          }
        },

        async cmdMakeDir(args) {
          if (args.length === 0) {
            this.writeLine('Usage: mkdir <dirname>');
            return;
          }
          this.writeLine(`mkdir: création du répertoire '${args[0]}'`);
        },

        async cmdRemoveDir(args) {
          if (args.length === 0) {
            this.writeLine('Usage: rmdir <dirname>');
            return;
          }
          this.writeLine(`rmdir: suppression du répertoire '${args[0]}'`);
        },

        async cmdTouch(args) {
          if (args.length === 0) {
            this.writeLine('Usage: touch <filename>');
            return;
          }

          await FileSystem.writeFile(args[0], '', 'text/plain');
          this.writeLine(`Fichier '${args[0]}' créé`);
        },

        async cmdRemove(args) {
          if (args.length === 0) {
            this.writeLine('Usage: rm <filename>');
            return;
          }

          const deleted = await FileSystem.deleteFile(args[0]);
          if (deleted) {
            this.writeLine(`Fichier '${args[0]}' supprimé`);
          } else {
            this.writeLine(`rm: impossible de supprimer '${args[0]}': Aucun fichier ou dossier de ce type`);
          }
        },

        async cmdCopy(args) {
          if (args.length < 2) {
            this.writeLine('Usage: cp <source> <destination>');
            return;
          }
          this.writeLine(`cp: copie de '${args[0]}' vers '${args[1]}'`);
        },

        async cmdMove(args) {
          if (args.length < 2) {
            this.writeLine('Usage: mv <source> <destination>');
            return;
          }
          this.writeLine(`mv: déplacement de '${args[0]}' vers '${args[1]}'`);
        },

        cmdEnv(args) {
          if (args.length === 0) {
            Object.entries(this.environment).forEach(([key, value]) => {
              this.writeLine(`${key}=${value}`);
            });
          } else {
            const value = this.environment[args[0]];
            if (value) {
              this.writeLine(value);
            }
          }
        },

        cmdExport(args) {
          if (args.length === 0) {
            this.cmdEnv([]);
            return;
          }

          const [key, ...valueParts] = args[0].split('=');
          if (valueParts.length > 0) {
            this.environment[key] = valueParts.join('=');
            this.writeLine(`Variable ${key} définie`);
          } else {
            this.writeLine('Usage: export VAR=valeur');
          }
        },

        cmdHistory() {
          this.history.forEach((cmd, idx) => {
            this.writeLine(`${(idx + 1).toString().padStart(4)}  ${cmd}`);
          });
        },

        cmdWhich(args) {
          if (args.length === 0) {
            this.writeLine('Usage: which <commande>');
            return;
          }

          const commands = ['ls', 'cat', 'grep', 'echo', 'date', 'ps', 'top', 'kill', 'pwd', 'cd'];
          if (commands.includes(args[0])) {
            this.writeLine(`/usr/bin/${args[0]}`);
          } else {
            this.writeLine(`which: aucun ${args[0]} dans (${this.environment.PATH})`);
          }
        },

        async cmdFile(args) {
          if (args.length === 0) {
            this.writeLine('Usage: file <filename>');
            return;
          }

          const files = await FileSystem.listFiles();
          const file = files.find(f => f.name === args[0]);

          if (file) {
            const type = file.type || 'application/octet-stream';
            this.writeLine(`${args[0]}: ${type}`);
          } else {
            this.writeLine(`file: impossible d'ouvrir '${args[0]}': Aucun fichier ou dossier de ce type`);
          }
        },

        async cmdStat(args) {
          if (args.length === 0) {
            this.writeLine('Usage: stat <filename>');
            return;
          }

          const files = await FileSystem.listFiles();
          const file = files.find(f => f.name === args[0]);

          if (file) {
            this.writeLine(`  Fichier : ${file.name}`);
            this.writeLine(`  Taille : ${file.size || 0} octets`);
            this.writeLine(`  Type : ${file.kind || 'file'}`);
            this.writeLine(`  Modifié : ${file.lastModified ? new Date(file.lastModified).toISOString() : 'inconnu'}`);
          } else {
            this.writeLine(`stat: impossible d'évaluer '${args[0]}': Aucun fichier ou dossier de ce type`);
          }
        },

        cmdPing(args) {
          if (args.length === 0) {
            this.writeLine('Usage: ping <host>');
            return;
          }

          this.writeLine(`PING ${args[0]} (127.0.0.1): 56 octets de données`);
          this.writeLine(`64 octets de 127.0.0.1: icmp_seq=0 ttl=64 temps=0.5 ms`);
          this.writeLine(`64 octets de 127.0.0.1: icmp_seq=1 ttl=64 temps=0.4 ms`);
          this.writeLine(`--- statistiques ping ${args[0]} ---`);
          this.writeLine(`2 paquets transmis, 2 reçus, 0% perte de paquets`);
        },

        cmdNetwork() {
          this.writeLine('eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500');
          this.writeLine('      inet 192.168.1.100  netmask 255.255.255.0  broadcast 192.168.1.255');
          this.writeLine('      ether 00:1b:44:11:3a:b7  txqueuelen 1000  (Ethernet)');
        },

        cmdNetstat() {
          this.writeLine('Connexions Internet actives (serveurs et établies)');
          this.writeLine('Proto  Local                  Distant                État');
          this.writeLine('tcp    0.0.0.0:80             0.0.0.0:*              LISTEN');
          this.writeLine('tcp    0.0.0.0:443            0.0.0.0:*              LISTEN');
        },

        writeLine(text) {
          const output = document.getElementById('terminalOutput');
          if (!output) return;

          const div = document.createElement('div');
          div.className = 'terminal-line';
          div.textContent = text;
          output.appendChild(div);
          output.scrollTop = output.scrollHeight;
        }
      },

      Monitor: {
        updateInterval: null,

        async open() {
          const content = `
            <div>
              <h2 style="font-size: 20px; font-weight: 700; color: #1e40af; margin-bottom: 20px;">Moniteur Système en Temps Réel</h2>

              <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">
                <button onclick="WebOS.Apps.Monitor.switchTab('overview')" id="tabOverview" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Vue d'ensemble</button>
                <button onclick="WebOS.Apps.Monitor.switchTab('performance')" id="tabPerformance" style="padding: 10px 20px; background: #e5e7eb; color: #374151; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Performance</button>
                <button onclick="WebOS.Apps.Monitor.switchTab('backup')" id="tabBackup" style="padding: 10px 20px; background: #e5e7eb; color: #374151; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Sauvegardes</button>
              </div>

              <div id="tabContentOverview">

              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 30px;" id="monitorStats">
                <div style="padding: 20px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border-radius: 12px;">
                  <div style="font-size: 14px; opacity: 0.9;">Processus Actifs</div>
                  <div style="font-size: 32px; font-weight: 700; margin-top: 8px;" id="processCount">0</div>
                </div>
                <div style="padding: 20px; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 12px;">
                  <div style="font-size: 14px; opacity: 0.9;">Mémoire JS (Heap)</div>
                  <div style="font-size: 32px; font-weight: 700; margin-top: 8px;" id="memoryUsed">0 MB</div>
                  <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;" id="memoryLimit">/ 0 MB</div>
                </div>
                <div style="padding: 20px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border-radius: 12px;">
                  <div style="font-size: 14px; opacity: 0.9;">Coeurs CPU</div>
                  <div style="font-size: 32px; font-weight: 700; margin-top: 8px;" id="cpuCores">${navigator.hardwareConcurrency || 4}</div>
                </div>
                <div style="padding: 20px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border-radius: 12px;">
                  <div style="font-size: 14px; opacity: 0.9;">Temps d'Activité</div>
                  <div style="font-size: 32px; font-weight: 700; margin-top: 8px;" id="uptime">0s</div>
                </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                <div style="padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                  <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Performance du Navigateur</h3>
                  <div style="font-size: 14px; color: #6b7280; line-height: 1.8;">
                    <div><strong>Navigation:</strong> <span id="navTiming">0ms</span></div>
                    <div><strong>DOM Chargé:</strong> <span id="domLoaded">0ms</span></div>
                    <div><strong>Page Complète:</strong> <span id="pageLoad">0ms</span></div>
                  </div>
                </div>
                <div style="padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                  <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Informations Système</h3>
                  <div style="font-size: 14px; color: #6b7280; line-height: 1.8;">
                    <div><strong>Plateforme:</strong> ${navigator.platform}</div>
                    <div><strong>User Agent:</strong> ${navigator.userAgent.split(' ').slice(0, 3).join(' ')}</div>
                    <div><strong>Langue:</strong> ${navigator.language}</div>
                  </div>
                </div>
              </div>

              <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">Processus Actifs</h3>
              <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                <thead>
                  <tr style="background: #f3f4f6; text-align: left;">
                    <th style="padding: 12px; font-weight: 600;">Nom</th>
                    <th style="padding: 12px; font-weight: 600;">PID</th>
                    <th style="padding: 12px; font-weight: 600;">État</th>
                    <th style="padding: 12px; font-weight: 600;">Démarré</th>
                    <th style="padding: 12px; font-weight: 600;">Durée</th>
                  </tr>
                </thead>
                <tbody id="processList">
                </tbody>
              </table>

              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="font-size: 18px; font-weight: 600;">Logs Console (F12)</h3>
                <div style="display: flex; gap: 8px;">
                  <button onclick="WebOS.Apps.Monitor.filterLogs('all')" id="logFilterAll" style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Tous</button>
                  <button onclick="WebOS.Apps.Monitor.filterLogs('log')" id="logFilterLog" style="padding: 6px 12px; background: #e5e7eb; color: #374151; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Log</button>
                  <button onclick="WebOS.Apps.Monitor.filterLogs('info')" id="logFilterInfo" style="padding: 6px 12px; background: #e5e7eb; color: #374151; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Info</button>
                  <button onclick="WebOS.Apps.Monitor.filterLogs('warn')" id="logFilterWarn" style="padding: 6px 12px; background: #e5e7eb; color: #374151; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Warn</button>
                  <button onclick="WebOS.Apps.Monitor.filterLogs('error')" id="logFilterError" style="padding: 6px 12px; background: #e5e7eb; color: #374151; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Error</button>
                  <button onclick="WebOS.Apps.Monitor.clearLogs()" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Effacer</button>
                </div>
              </div>

              <div id="logContainer" style="background: #1f2937; border-radius: 8px; padding: 16px; max-height: 400px; overflow-y: auto; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 13px; line-height: 1.6;">
                <div id="logsList" style="color: #e5e7eb;">
                  <div style="color: #9ca3af; text-align: center; padding: 20px;">Aucun log pour le moment...</div>
                </div>
              </div>

              </div>

              <div id="tabContentPerformance" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                  <div style="padding: 20px; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 12px;">
                    <div style="font-size: 14px; opacity: 0.9;">LCP (Largest Contentful Paint)</div>
                    <div style="font-size: 32px; font-weight: 700; margin-top: 8px;" id="perfLCP">-</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Cible: &lt; 2.5s</div>
                  </div>
                  <div style="padding: 20px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border-radius: 12px;">
                    <div style="font-size: 14px; opacity: 0.9;">FID (First Input Delay)</div>
                    <div style="font-size: 32px; font-weight: 700; margin-top: 8px;" id="perfFID">-</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Cible: &lt; 100ms</div>
                  </div>
                  <div style="padding: 20px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border-radius: 12px;">
                    <div style="font-size: 14px; opacity: 0.9;">CLS (Cumulative Layout Shift)</div>
                    <div style="font-size: 32px; font-weight: 700; margin-top: 8px;" id="perfCLS">-</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Cible: &lt; 0.1</div>
                  </div>
                  <div style="padding: 20px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border-radius: 12px;">
                    <div style="font-size: 14px; opacity: 0.9;">TTFB (Time to First Byte)</div>
                    <div style="font-size: 32px; font-weight: 700; margin-top: 8px;" id="perfTTFB">-</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Cible: &lt; 600ms</div>
                  </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                  <div style="padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Résumé des Performances</h3>
                    <div style="font-size: 14px; color: #6b7280; line-height: 1.8;">
                      <div><strong>Total mesures:</strong> <span id="perfTotalMeasures">0</span></div>
                      <div><strong>Durée moyenne:</strong> <span id="perfAvgDuration">0ms</span></div>
                      <div><strong>Opération la plus lente:</strong> <span id="perfSlowest">-</span></div>
                      <div><strong>Opération la plus rapide:</strong> <span id="perfFastest">-</span></div>
                    </div>
                  </div>
                  <div style="padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Actions</h3>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                      <button onclick="WebOS.Apps.Monitor.exportPerformanceReport()" style="padding: 10px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Exporter Rapport JSON</button>
                      <button onclick="WebOS.Apps.Monitor.clearPerformanceMetrics()" style="padding: 10px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Effacer Métriques</button>
                      <button onclick="WebOS.Apps.Monitor.togglePerformanceMonitoring()" style="padding: 10px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Activer/Désactiver Monitoring</button>
                    </div>
                  </div>
                </div>

                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">Métriques Détaillées</h3>
                <div style="max-height: 400px; overflow-y: auto;">
                  <table style="width: 100%; border-collapse: collapse;">
                    <thead style="position: sticky; top: 0; background: #f3f4f6;">
                      <tr style="text-align: left;">
                        <th style="padding: 12px; font-weight: 600;">Opération</th>
                        <th style="padding: 12px; font-weight: 600;">Durée (ms)</th>
                        <th style="padding: 12px; font-weight: 600;">Horodatage</th>
                        <th style="padding: 12px; font-weight: 600;">Métadonnées</th>
                      </tr>
                    </thead>
                    <tbody id="perfMetricsTable">
                    </tbody>
                  </table>
                </div>
              </div>

              <div id="tabContentBackup" style="display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                  <div style="padding: 24px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border-radius: 12px;">
                    <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px;">Créer une Sauvegarde</h3>
                    <p style="font-size: 14px; opacity: 0.9; margin-bottom: 16px;">Sauvegarde chiffrée de tous vos fichiers OPFS avec rotation automatique (5 max).</p>
                    <input type="password" id="backupPassword" placeholder="Mot de passe (optionnel)" style="width: 100%; padding: 10px; border-radius: 6px; border: none; margin-bottom: 12px; color: #1f2937;">
                    <button onclick="WebOS.Apps.Monitor.createBackup()" style="width: 100%; padding: 12px; background: white; color: #3b82f6; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 14px;">Créer Sauvegarde</button>
                  </div>

                  <div style="padding: 24px; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 12px;">
                    <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px;">Restaurer depuis Fichier</h3>
                    <p style="font-size: 14px; opacity: 0.9; margin-bottom: 16px;">Importer et restaurer une sauvegarde .webosq depuis votre ordinateur.</p>
                    <input type="file" id="restoreFile" accept=".webosq" style="width: 100%; padding: 10px; background: white; border-radius: 6px; border: none; margin-bottom: 12px; color: #1f2937;">
                    <input type="password" id="restorePassword" placeholder="Mot de passe (si chiffré)" style="width: 100%; padding: 10px; border-radius: 6px; border: none; margin-bottom: 12px; color: #1f2937;">
                    <button onclick="WebOS.Apps.Monitor.restoreBackup()" style="width: 100%; padding: 12px; background: white; color: #10b981; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 14px;">Restaurer</button>
                  </div>
                </div>

                <div style="padding: 24px; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb; margin-bottom: 24px;">
                  <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Exporter vers Fichier</h3>
                  <p style="font-size: 14px; color: #6b7280; margin-bottom: 16px;">Télécharger la dernière sauvegarde sur votre ordinateur.</p>
                  <div style="display: flex; gap: 12px; align-items: center;">
                    <input type="password" id="exportPassword" placeholder="Mot de passe pour chiffrer (optionnel)" style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #d1d5db;">
                    <button onclick="WebOS.Apps.Monitor.exportBackup()" style="padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">Télécharger .webosq</button>
                  </div>
                </div>

                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">Sauvegardes Automatiques (OPFS)</h3>
                <div id="backupsList" style="display: flex; flex-direction: column; gap: 12px;">
                  <div style="text-align: center; padding: 40px; color: #9ca3af;">Aucune sauvegarde trouvée</div>
                </div>
              </div>

            </div>
          `;

          WindowManager.create('monitor', 'Moniteur Système', content, { width: 900, height: 700 });

          await this.startMonitoring();
        },

        async startMonitoring() {
          await this.updateMetrics();

          this.updateInterval = setInterval(async () => {
            await this.updateMetrics();
          }, 1000);
        },

        async updateMetrics() {
          const processes = Kernel.getProcesses();

          const processCountEl = document.getElementById('processCount');
          if (processCountEl) processCountEl.textContent = processes.length;

          if (performance.memory) {
            const memoryUsedMB = Math.round(performance.memory.usedJSHeapSize / 1048576);
            const memoryLimitMB = Math.round(performance.memory.jsHeapSizeLimit / 1048576);

            const memoryUsedEl = document.getElementById('memoryUsed');
            const memoryLimitEl = document.getElementById('memoryLimit');

            if (memoryUsedEl) memoryUsedEl.textContent = `${memoryUsedMB} MB`;
            if (memoryLimitEl) memoryLimitEl.textContent = `/ ${memoryLimitMB} MB`;
          }

          const uptimeEl = document.getElementById('uptime');
          if (uptimeEl) {
            const uptimeSeconds = Math.floor(performance.now() / 1000);
            const hours = Math.floor(uptimeSeconds / 3600);
            const minutes = Math.floor((uptimeSeconds % 3600) / 60);
            const seconds = uptimeSeconds % 60;

            if (hours > 0) {
              uptimeEl.textContent = `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
              uptimeEl.textContent = `${minutes}m ${seconds}s`;
            } else {
              uptimeEl.textContent = `${seconds}s`;
            }
          }

          const timing = performance.timing;
          const navTimingEl = document.getElementById('navTiming');
          const domLoadedEl = document.getElementById('domLoaded');
          const pageLoadEl = document.getElementById('pageLoad');

          if (navTimingEl && timing.responseEnd && timing.fetchStart) {
            navTimingEl.textContent = `${timing.responseEnd - timing.fetchStart}ms`;
          }
          if (domLoadedEl && timing.domContentLoadedEventEnd && timing.fetchStart) {
            domLoadedEl.textContent = `${timing.domContentLoadedEventEnd - timing.fetchStart}ms`;
          }
          if (pageLoadEl && timing.loadEventEnd && timing.fetchStart) {
            pageLoadEl.textContent = `${timing.loadEventEnd - timing.fetchStart}ms`;
          }

          const processListEl = document.getElementById('processList');
          if (processListEl) {
            if (processes.length === 0) {
              processListEl.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #6b7280;">Aucun processus actif</td></tr>';
            } else {
              processListEl.innerHTML = processes.map(p => {
                const duration = Math.floor((Date.now() - p.startTime) / 1000);
                const durationText = duration < 60 ? `${duration}s` : `${Math.floor(duration / 60)}m`;

                return `
                  <tr style="border-bottom: 1px solid #e5e7eb;">
                    <td style="padding: 12px;">${p.name}</td>
                    <td style="padding: 12px;">${p.pid}</td>
                    <td style="padding: 12px;"><span style="padding: 4px 8px; background: #10b981; color: white; border-radius: 4px; font-size: 12px;">${p.status}</span></td>
                    <td style="padding: 12px;">${new Date(p.startTime).toLocaleTimeString()}</td>
                    <td style="padding: 12px;">${durationText}</td>
                  </tr>
                `;
              }).join('');
            }
          }

          this.updateLogs();
        },

        currentLogFilter: 'all',

        updateLogs() {
          const logsListEl = document.getElementById('logsList');
          if (!logsListEl) return;

          const logs = Logger.getLogs();
          const filteredLogs = this.currentLogFilter === 'all'
            ? logs
            : logs.filter(log => log.level === this.currentLogFilter);

          if (filteredLogs.length === 0) {
            logsListEl.innerHTML = '<div style="color: #9ca3af; text-align: center; padding: 20px;">Aucun log pour le moment...</div>';
            return;
          }

          const logLevelColors = {
            log: '#60a5fa',
            info: '#22d3ee',
            warn: '#fbbf24',
            error: '#f87171',
            debug: '#a78bfa'
          };

          logsListEl.innerHTML = filteredLogs.map(log => {
            const color = logLevelColors[log.level] || '#60a5fa';
            const timestamp = log.timestamp.toLocaleTimeString('fr-CA', {
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
              fractionalSecondDigits: 3
            });

            return `
              <div style="margin-bottom: 8px; padding: 8px; border-left: 3px solid ${color}; background: rgba(31, 41, 55, 0.5); border-radius: 4px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 4px;">
                  <span style="color: ${color}; font-weight: 700; text-transform: uppercase; font-size: 11px; background: rgba(59, 130, 246, 0.2); padding: 2px 8px; border-radius: 4px;">${log.level}</span>
                  <span style="color: #9ca3af; font-size: 12px;">${timestamp}</span>
                </div>
                <div style="color: #e5e7eb; white-space: pre-wrap; word-break: break-word;">${this.escapeHtml(log.message)}</div>
                ${log.stackTrace ? `<details style="margin-top: 8px;"><summary style="color: #f87171; cursor: pointer; font-size: 12px;">Stack Trace</summary><pre style="color: #fca5a5; font-size: 11px; margin-top: 4px; overflow-x: auto;">${this.escapeHtml(log.stackTrace)}</pre></details>` : ''}
              </div>
            `;
          }).join('');

          logsListEl.scrollTop = 0;
        },

        filterLogs(level) {
          this.currentLogFilter = level;

          ['all', 'log', 'info', 'warn', 'error'].forEach(l => {
            const btn = document.getElementById(`logFilter${l.charAt(0).toUpperCase() + l.slice(1)}`);
            if (btn) {
              if (l === level) {
                btn.style.background = '#3b82f6';
                btn.style.color = 'white';
              } else {
                btn.style.background = '#e5e7eb';
                btn.style.color = '#374151';
              }
            }
          });

          this.updateLogs();
        },

        clearLogs() {
          Logger.clearLogs();
          this.updateLogs();
        },

        escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        },

        switchTab(tab) {
          ['overview', 'performance', 'backup'].forEach(t => {
            const content = document.getElementById(`tabContent${t.charAt(0).toUpperCase() + t.slice(1)}`);
            const button = document.getElementById(`tab${t.charAt(0).toUpperCase() + t.slice(1)}`);

            if (content && button) {
              if (t === tab) {
                content.style.display = 'block';
                button.style.background = '#3b82f6';
                button.style.color = 'white';
              } else {
                content.style.display = 'none';
                button.style.background = '#e5e7eb';
                button.style.color = '#374151';
              }
            }
          });

          if (tab === 'performance') {
            this.updatePerformanceMetrics();
          } else if (tab === 'backup') {
            this.updateBackupsList();
          }
        },

        updatePerformanceMetrics() {
          const report = PerformanceMonitor.getReport();

          const lcpEl = document.getElementById('perfLCP');
          const fidEl = document.getElementById('perfFID');
          const clsEl = document.getElementById('perfCLS');
          const ttfbEl = document.getElementById('perfTTFB');

          if (lcpEl) lcpEl.textContent = report.webVitals.lcp ? `${(report.webVitals.lcp / 1000).toFixed(2)}s` : '-';
          if (fidEl) fidEl.textContent = report.webVitals.fid ? `${report.webVitals.fid.toFixed(0)}ms` : '-';
          if (clsEl) clsEl.textContent = report.webVitals.cls ? report.webVitals.cls.toFixed(4) : '-';
          if (ttfbEl) ttfbEl.textContent = report.webVitals.ttfb ? `${report.webVitals.ttfb.toFixed(0)}ms` : '-';

          const totalEl = document.getElementById('perfTotalMeasures');
          const avgEl = document.getElementById('perfAvgDuration');
          const slowestEl = document.getElementById('perfSlowest');
          const fastestEl = document.getElementById('perfFastest');

          if (totalEl) totalEl.textContent = report.summary.totalMeasures;
          if (avgEl) avgEl.textContent = `${report.summary.averageDuration.toFixed(2)}ms`;
          if (slowestEl) slowestEl.textContent = report.summary.slowestOperation ? `${report.summary.slowestOperation.name} (${report.summary.slowestOperation.duration.toFixed(2)}ms)` : '-';
          if (fastestEl) fastestEl.textContent = report.summary.fastestOperation ? `${report.summary.fastestOperation.name} (${report.summary.fastestOperation.duration.toFixed(2)}ms)` : '-';

          const tableEl = document.getElementById('perfMetricsTable');
          if (tableEl) {
            const metrics = report.metrics.slice(0, 100);
            tableEl.innerHTML = metrics.map(m => `
              <tr style="border-bottom: 1px solid #e5e7eb;">
                <td style="padding: 12px;">${m.name}</td>
                <td style="padding: 12px; font-weight: 600;">${m.duration.toFixed(2)}</td>
                <td style="padding: 12px;">${new Date(m.timestamp).toLocaleTimeString()}</td>
                <td style="padding: 12px; font-size: 12px; color: #6b7280;">${m.metadata ? JSON.stringify(m.metadata) : '-'}</td>
              </tr>
            `).join('');
          }
        },

        exportPerformanceReport() {
          const report = PerformanceMonitor.exportReport();
          const blob = new Blob([report], { type: 'application/json' });
          const url = URL.createObjectURL(blob);

          const a = document.createElement('a');
          a.href = url;
          a.download = `performance-report-${Date.now()}.json`;
          a.click();

          URL.revokeObjectURL(url);
        },

        clearPerformanceMetrics() {
          if (confirm('Effacer toutes les métriques de performance?')) {
            PerformanceMonitor.clear();
            this.updatePerformanceMetrics();
          }
        },

        togglePerformanceMonitoring() {
          const newState = PerformanceMonitor.toggleEnabled();
          alert(`Monitoring de performance ${newState ? 'activé' : 'désactivé'}`);
        },

        async createBackup() {
          const passwordEl = document.getElementById('backupPassword');
          const password = passwordEl?.value || null;

          const result = await OPFSSnapshot.createSnapshot(password);

          if (result.success) {
            alert(`Sauvegarde créée avec succès!\n\nFichiers: ${result.fileCount}\nTaille: ${(result.size / 1024).toFixed(2)} KB`);
            if (passwordEl) passwordEl.value = '';
            this.updateBackupsList();
          } else {
            alert(`Erreur lors de la création de la sauvegarde:\n${result.error}`);
          }
        },

        async restoreBackup() {
          const fileEl = document.getElementById('restoreFile');
          const passwordEl = document.getElementById('restorePassword');

          if (!fileEl || !fileEl.files || fileEl.files.length === 0) {
            alert('Veuillez sélectionner un fichier .webosq');
            return;
          }

          const file = fileEl.files[0];
          const password = passwordEl?.value || null;

          if (!confirm('ATTENTION: La restauration remplacera tous les fichiers actuels. Continuer?')) {
            return;
          }

          const arrayBuffer = await file.arrayBuffer();
          const result = await OPFSSnapshot.restoreSnapshot(arrayBuffer, password);

          if (result.success) {
            alert(`Restauration réussie!\n\nFichiers restaurés: ${result.fileCount}`);
            if (fileEl) fileEl.value = '';
            if (passwordEl) passwordEl.value = '';
            this.updateBackupsList();
          } else {
            alert(`Erreur lors de la restauration:\n${result.error}`);
          }
        },

        async exportBackup() {
          const passwordEl = document.getElementById('exportPassword');
          const password = passwordEl?.value || null;

          try {
            const blob = await OPFSSnapshot.exportSnapshot(password);

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `webos-backup-${new Date().toISOString().slice(0,10)}.webosq`;
            a.click();

            URL.revokeObjectURL(url);

            if (passwordEl) passwordEl.value = '';
            alert('Sauvegarde téléchargée avec succès!');
          } catch (error) {
            alert(`Erreur lors de l'export:\n${error.message}`);
          }
        },

        async updateBackupsList() {
          const listEl = document.getElementById('backupsList');
          if (!listEl) return;

          const snapshots = await OPFSSnapshot.listSnapshots();

          if (snapshots.length === 0) {
            listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">Aucune sauvegarde trouvée</div>';
            return;
          }

          listEl.innerHTML = snapshots.map((snapshot, index) => {
            const date = new Date(snapshot.lastModified);
            const sizeKB = (snapshot.size / 1024).toFixed(2);
            const isLatest = index === snapshots.length - 1;

            return `
              <div style="padding: 16px; background: white; border-radius: 8px; border: 1px solid ${isLatest ? '#3b82f6' : '#e5e7eb'}; display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600; color: #1f2937; display: flex; align-items: center; gap: 8px;">
                    ${snapshot.name}
                    ${isLatest ? '<span style="padding: 2px 8px; background: #3b82f6; color: white; border-radius: 4px; font-size: 11px; font-weight: 700;">DERNIÈRE</span>' : ''}
                  </div>
                  <div style="font-size: 14px; color: #6b7280; margin-top: 4px;">
                    ${date.toLocaleString('fr-CA')} • ${sizeKB} KB
                  </div>
                </div>
                <div style="display: flex; gap: 8px;">
                  <button onclick="WebOS.Apps.Monitor.downloadBackupFile('${snapshot.name}')" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">Télécharger</button>
                </div>
              </div>
            `;
          }).join('');
        },

        async downloadBackupFile(filename) {
          try {
            if (!navigator.storage || !navigator.storage.getDirectory) {
              alert('OPFS non supporté - impossible de télécharger la sauvegarde');
              return;
            }

            const root = await navigator.storage.getDirectory();
            const snapshotsDir = await root.getDirectoryHandle('snapshots');
            const fileHandle = await snapshotsDir.getFileHandle(filename);
            const file = await fileHandle.getFile();
            const blob = new Blob([await file.arrayBuffer()], { type: 'application/octet-stream' });

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();

            URL.revokeObjectURL(url);
            alert('Sauvegarde téléchargée!');
          } catch (error) {
            alert(`Erreur lors du téléchargement:\n${error.message}`);
          }
        },

        close() {
          if (this.updateInterval) {
            clearInterval(this.updateInterval);
            this.updateInterval = null;
          }
        }
      },

      OSINT: {
        newsMode: false,

        async open() {
          const content = `
            <style>
              .osint-container { height: 100%; display: flex; flex-direction: column; background: #0a0a0b; color: #e4e4e7; overflow: hidden; }
              .osint-header { padding: 16px 24px; background: #121214; border-bottom: 1px solid #27272a; }
              .osint-logo { font-size: 18px; font-weight: 700; color: #3b82f6; }
              .osint-main { flex: 1; padding: 24px; overflow-y: auto; }
              .osint-panel { background: #121214; border: 1px solid #27272a; border-radius: 12px; padding: 24px; margin-bottom: 24px; }
              .osint-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; color: #3b82f6; display: flex; align-items: center; gap: 8px; }
              .osint-search { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
              .osint-input { flex: 1; min-width: 250px; padding: 12px 16px; background: #1a1a1d; border: 1px solid #27272a; border-radius: 8px; color: #e4e4e7; font-size: 15px; }
              .osint-input:focus { outline: none; border-color: #3b82f6; }
              .osint-btn { padding: 12px 24px; background: #3b82f6; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; white-space: nowrap; font-size: 14px; }
              .osint-btn:hover { background: #2563eb; }
              .osint-btn:disabled { opacity: 0.5; cursor: not-allowed; }
              .osint-btn-news { background: #ef4444; position: relative; overflow: hidden; }
              .osint-btn-news:hover { background: #dc2626; }
              .osint-chk { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
              .osint-chk label { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: #1a1a1d; border: 1px solid #27272a; border-radius: 6px; cursor: pointer; white-space: nowrap; font-size: 13px; font-weight: 500; }
              .osint-chk input { cursor: pointer; }
              .osint-results { display: grid; gap: 16px; }
              .osint-result { background: #1a1a1d; border: 1px solid #27272a; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; }
              .osint-result:hover { background: #222225; border-color: #3f3f46; transform: translateY(-2px); }
              .osint-result-src { display: inline-block; padding: 4px 10px; color: white; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; margin-bottom: 10px; }
              .osint-result-title { font-size: 17px; font-weight: 700; color: #e4e4e7; margin-bottom: 8px; line-height: 1.4; }
              .osint-result-snippet { color: #a1a1aa; line-height: 1.6; margin-bottom: 12px; font-size: 14px; }
              .osint-result-url { font-size: 11px; color: #71717a; font-family: monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
              .osint-empty { text-align: center; padding: 60px 20px; color: #a1a1aa; }
              .osint-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #27272a; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; }
              @keyframes spin { to { transform: rotate(360deg); } }
              .osint-badge { padding: 4px 10px; background: #0a0a0b; border: 1px solid #27272a; border-radius: 6px; font-size: 12px; font-weight: 600; white-space: nowrap; display: inline-block; margin-right: 8px; margin-top: 8px; }
              .osint-schema { background: #1a1a1d; border: 1px solid #27272a; border-radius: 10px; padding: 16px; margin-bottom: 20px; }
              .osint-schema-title { font-size: 13px; font-weight: 700; color: #3b82f6; text-transform: uppercase; margin-bottom: 10px; }
              .osint-schema-content { color: #a1a1aa; font-size: 14px; line-height: 1.6; }
              .osint-entities { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
              .osint-entity { padding: 4px 10px; background: #0a0a0b; border: 1px solid #27272a; border-radius: 6px; font-size: 12px; white-space: nowrap; }
              .osint-signals { background: linear-gradient(135deg, #422006, #713f12); border: 1px solid #f59e0b; border-radius: 10px; padding: 16px; margin-bottom: 20px; }
              .osint-signals-title { font-size: 13px; font-weight: 700; color: #f59e0b; text-transform: uppercase; margin-bottom: 10px; }
              .osint-signal { padding: 6px 12px; background: rgba(0,0,0,0.3); color: #f59e0b; border-radius: 6px; font-size: 12px; font-weight: 600; display: inline-block; margin: 4px; }
              .osint-timestamp { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; color: #71717a; margin-top: 8px; }
              .osint-timestamp svg { width: 12px; height: 12px; }
              .osint-timestamp.fresh { color: #10b981; }
              .osint-timestamp.recent { color: #f59e0b; }
              .osint-timestamp.old { color: #71717a; }
              .osint-news-badge { display: inline-block; padding: 2px 6px; background: #ef4444; color: white; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; margin-left: 8px; animation: pulse 1.5s infinite; }
              @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
            </style>
            <div class="osint-container">
              <div class="osint-main">
                <div class="osint-panel">
                  <div class="osint-title">Recherche Multi-Sources Intelligence <span class="osint-news-badge" id="osint-news-indicator" style="display:none">ACTUALITÉS LIVE</span></div>
                  <div class="osint-search">
                    <input id="osint-query" class="osint-input" placeholder="Entrez votre requête de recherche..." />
                    <button class="osint-btn" id="osint-search-btn">Rechercher</button>
                    <button class="osint-btn osint-btn-news" id="osint-news-toggle">⚡ Mode Actualités</button>
                  </div>
                  <div class="osint-chk">
                    <label><input type="checkbox" id="src_wiki" checked> Wikipedia</label>
                    <label><input type="checkbox" id="src_wd" checked> Wikidata</label>
                    <label><input type="checkbox" id="src_ddg" checked> DuckDuckGo</label>
                    <label><input type="checkbox" id="src_hn" checked> Hacker News</label>
                    <label><input type="checkbox" id="src_reddit" checked> Reddit</label>
                    <label><input type="checkbox" id="src_arxiv" checked> arXiv</label>
                    <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
                      <span style="color:#a1a1aa;font-size:14px;font-weight:600;">Langue:</span>
                      <label style="background:#3b82f6;color:white;border-color:#3b82f6;"><input type="radio" name="osint_lang" value="fr" checked> FR</label>
                      <label><input type="radio" name="osint_lang" value="en"> EN</label>
                    </div>
                  </div>
                  <div class="osint-chk" style="margin-top:12px;padding-top:12px;border-top:1px solid #27272a;">
                    <span style="color:#a1a1aa;font-size:14px;font-weight:600;">Fraîcheur:</span>
                    <label><input type="radio" name="osint_fresh" value="all" checked> Tous</label>
                    <label><input type="radio" name="osint_fresh" value="day"> 24h</label>
                    <label><input type="radio" name="osint_fresh" value="week"> 7j</label>
                    <label><input type="radio" name="osint_fresh" value="month"> 30j</label>
                    <label><input type="radio" name="osint_fresh" value="year"> 1 an</label>
                  </div>
                </div>
                <div id="osint-schema-container"></div>
                <div id="osint-signals-container"></div>
                <div id="osint-results-container" class="osint-results"></div>
              </div>
            </div>
          `;

          WindowManager.create('osint', 'OSINT Intelligence Multi-Sources', content, {
            width: 1400,
            height: 900
          });

          setTimeout(() => {
            const searchBtn = document.getElementById('osint-search-btn');
            const newsToggle = document.getElementById('osint-news-toggle');
            const queryInput = document.getElementById('osint-query');
            const newsIndicator = document.getElementById('osint-news-indicator');

            if (newsToggle) {
              newsToggle.addEventListener('click', () => {
                this.newsMode = !this.newsMode;
                if (this.newsMode) {
                  newsToggle.textContent = '📰 Mode Normal';
                  newsToggle.style.background = '#10b981';
                  newsToggle.classList.remove('osint-btn-news');
                  if (newsIndicator) newsIndicator.style.display = 'inline-block';
                } else {
                  newsToggle.textContent = '⚡ Mode Actualités';
                  newsToggle.style.background = '#ef4444';
                  newsToggle.classList.add('osint-btn-news');
                  if (newsIndicator) newsIndicator.style.display = 'none';
                }
              });
            }

            if (searchBtn) {
              searchBtn.addEventListener('click', () => this.search());
            }

            if (queryInput) {
              queryInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.search();
              });
            }
          }, 100);
        },

        async search() {
          const query = document.getElementById('osint-query')?.value.trim();
          if (!query) return;

          const sources = {
            wikipedia: document.getElementById('src_wiki')?.checked || false,
            wikidata: document.getElementById('src_wd')?.checked || false,
            duckduckgo: document.getElementById('src_ddg')?.checked || false,
            hackernews: document.getElementById('src_hn')?.checked || false,
            reddit: document.getElementById('src_reddit')?.checked || false,
            arxiv: document.getElementById('src_arxiv')?.checked || false
          };

          const lang = document.querySelector('input[name="osint_lang"]:checked')?.value || 'fr';
          const freshness = document.querySelector('input[name="osint_fresh"]:checked')?.value || 'all';

          const btn = document.getElementById('osint-search-btn');
          const container = document.getElementById('osint-results-container');
          const schemaContainer = document.getElementById('osint-schema-container');
          const signalsContainer = document.getElementById('osint-signals-container');

          if (btn) btn.disabled = true;
          if (btn) btn.textContent = 'Recherche en cours...';
          if (container) container.innerHTML = '<div class="osint-empty"><div class="osint-spinner"></div><p>Recherche en cours...</p></div>';
          if (schemaContainer) schemaContainer.innerHTML = '';
          if (signalsContainer) signalsContainer.innerHTML = '';

          try {
            const response = await fetch(`${CONFIG.supabase.url}/functions/v1/osint-aggregator`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${CONFIG.supabase.anonKey}`
              },
              body: JSON.stringify({ query, sources, lang, limit: 50, newsMode: this.newsMode })
            });

            const data = await response.json();

            if (data.error) {
              if (container) container.innerHTML = `<div class="osint-empty"><p>Erreur: ${data.error}</p></div>`;
              return;
            }

            let results = data.results || [];
            const schema = data.schema || {};
            const signals = data.signals || [];

            results = this.filterResultsByFreshness(results, freshness);

            if (results.length === 0) {
              if (container) container.innerHTML = '<div class="osint-empty"><p>Aucun résultat trouvé. Essayez une autre requête.</p></div>';
              return;
            }

            this.renderSchema(schema, schemaContainer);
            this.renderSignals(signals, signalsContainer);
            this.renderResults(results, container);

            if (currentUser) {
              await supabaseClient.from('osint_searches').insert([{
                user_id: currentUser.id,
                query: query,
                sources_used: Object.keys(sources).filter(k => sources[k]),
                results_count: results.length,
                language: lang
              }]);
            }

          } catch (error) {
            console.error('OSINT search error:', error);
            if (container) container.innerHTML = `<div class="osint-empty"><p>Erreur: ${error.message}</p></div>`;
          } finally {
            if (btn) btn.disabled = false;
            if (btn) btn.textContent = 'Rechercher';
          }
        },

        renderSchema(schema, container) {
          if (!schema.sources || schema.sources.length === 0) return;

          const entities = schema.entities || [];
          const entitiesHTML = entities.length > 0
            ? '<div class="osint-entities">' + entities.map(e => `<span class="osint-entity">${e.entity} (${e.count})</span>`).join('') + '</div>'
            : '';

          if (container) {
            container.innerHTML = `
              <div class="osint-schema">
                <div class="osint-schema-title">Contexte de Recherche</div>
                <div class="osint-schema-content">
                  <strong>Sources:</strong> ${schema.sources.join(', ')}<br>
                  <strong>Total Résultats:</strong> ${schema.total_results || 0}
                  ${entitiesHTML}
                </div>
              </div>
            `;
          }
        },

        renderSignals(signals, container) {
          if (!signals || signals.length === 0) return;

          const signalsHTML = signals.map(s => `<span class="osint-signal">${s.signal} ×${s.strength}</span>`).join('');

          if (container) {
            container.innerHTML = `
              <div class="osint-signals">
                <div class="osint-signals-title">Signaux Forts (Répétition)</div>
                ${signalsHTML}
              </div>
            `;
          }
        },

        formatTimestamp(timestamp) {
          if (!timestamp) return null;

          const date = new Date(timestamp);
          const now = new Date();
          const diffMs = now - date;
          const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
          const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
          const diffMinutes = Math.floor(diffMs / (1000 * 60));

          let ageClass = 'old';
          let ageText = '';

          if (diffMinutes < 60) {
            ageText = `${diffMinutes}m`;
            ageClass = 'fresh';
          } else if (diffHours < 24) {
            ageText = `${diffHours}h`;
            ageClass = 'fresh';
          } else if (diffDays < 7) {
            ageText = `${diffDays}j`;
            ageClass = 'recent';
          } else if (diffDays < 30) {
            ageText = `${Math.floor(diffDays / 7)}sem`;
            ageClass = 'recent';
          } else if (diffDays < 365) {
            ageText = `${Math.floor(diffDays / 30)}mois`;
            ageClass = 'old';
          } else {
            ageText = `${Math.floor(diffDays / 365)}an`;
            ageClass = 'old';
          }

          return { ageClass, ageText, fullDate: date.toLocaleString('fr-CA') };
        },

        filterResultsByFreshness(results, freshness) {
          if (freshness === 'all') return results;

          const now = new Date();
          const cutoffs = { day: 1, week: 7, month: 30, year: 365 };
          const maxDays = cutoffs[freshness];
          if (!maxDays) return results;

          return results.filter(r => {
            if (!r.timestamp) return true;
            const date = new Date(r.timestamp);
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            return diffDays <= maxDays;
          });
        },

        renderResults(results, container) {
          const sourceColors = {
            'Wikipedia': '#3b82f6',
            'Wikidata': '#8b5cf6',
            'DuckDuckGo': '#ef4444',
            'Hacker News': '#f97316',
            'Reddit': '#ea580c',
            'arXiv': '#10b981',
            'Google News': '#ef4444',
            'Bing News': '#0078d4'
          };

          const html = results.map(r => {
            const color = sourceColors[r.source] || '#6b7280';
            const badges = [];
            if (r.score) badges.push(`<span class="osint-badge">Score: ${r.score}</span>`);
            if (r.metadata?.points) badges.push(`<span class="osint-badge">${r.metadata.points} pts</span>`);
            if (r.metadata?.comments) badges.push(`<span class="osint-badge">${r.metadata.comments} commentaires</span>`);

            let timestampHTML = '';
            if (r.timestamp) {
              const timeData = this.formatTimestamp(r.timestamp);
              if (timeData) {
                timestampHTML = `
                  <div class="osint-timestamp ${timeData.ageClass}" title="${timeData.fullDate}">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"></circle>
                      <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    ${timeData.ageText}
                  </div>
                `;
              }
            }

            return `
              <div class="osint-result" onclick="window.open('${r.url}', '_blank')">
                <div class="osint-result-src" style="background:${color}">${r.source}</div>
                <div class="osint-result-title">${r.title}</div>
                <div class="osint-result-snippet">${r.snippet || ''}</div>
                <div class="osint-result-url">${r.url}</div>
                ${timestampHTML}
                ${badges.length > 0 ? '<div>' + badges.join('') + '</div>' : ''}
              </div>
            `;
          }).join('');

          if (container) container.innerHTML = html;
        }
      },

      Messages: {
        currentConversation: null,
        conversations: [],
        allUsers: [],
        selectedUsers: [],
        activeChannel: null,
        selectedFiles: [],
        uploadingFiles: [],
        conversationToDelete: null,
        storageQuota: { used: 0, limit: 5368709120 },

        async open() {
          const content = `
            <style>
              #messages-app { display:flex; height:100%; overflow:hidden; font-family:system-ui,-apple-system,sans-serif; background:#0f172a; position:relative }

              #messages-sidebar {
                width:340px;
                border-right:1px solid #1e293b;
                display:flex;
                flex-direction:column;
                background:#1e293b;
                box-shadow:2px 0 10px rgba(0,0,0,0.3);
                transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
                z-index: 3;
                flex-shrink: 0;
              }

              #messages-sidebar.slide-left {
                position: absolute;
                left: 0;
                top: 0;
                height: 100%;
                transform: translateX(-100%);
              }

              #messages-main {
                flex:1;
                display:flex;
                flex-direction:column;
                background:#1e293b;
                border-radius:12px;
                margin:8px 8px 8px 0;
                box-shadow:0 4px 20px rgba(0,0,0,0.3);
                overflow:hidden;
                transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
              }

              #messages-main.full-width {
                margin-left: 8px;
                width: calc(100% - 16px);
              }

              .msg-back-btn {
                display: none;
                position: absolute;
                left: 16px;
                top: 50%;
                transform: translateY(-50%);
                width: 36px;
                height: 36px;
                background: rgba(255,255,255,0.15);
                border: 1px solid rgba(255,255,255,0.2);
                color: white;
                border-radius: 8px;
                cursor: pointer;
                font-size: 18px;
                font-weight: 400;
                transition: all 0.2s;
                backdrop-filter: blur(10px);
                z-index: 10;
                display: flex;
                align-items: center;
                justify-content: center;
                line-height: 1;
              }

              .msg-back-btn:hover {
                background: rgba(255,255,255,0.25);
                border-color: rgba(255,255,255,0.3);
              }

              .msg-back-btn:active {
                transform: translateY(-50%) scale(0.95);
              }

              #messages-main.full-width .msg-back-btn {
                display: flex;
                animation: msg-back-btn-appear 0.3s ease-out;
              }

              @keyframes msg-back-btn-appear {
                from {
                  opacity: 0;
                  transform: translateY(-50%) translateX(-10px);
                }
                to {
                  opacity: 1;
                  transform: translateY(-50%) translateX(0);
                }
              }

              #messages-sidebar-header { padding:20px; background:linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); display:flex; align-items:center; justify-content:space-between; box-shadow:0 2px 10px rgba(37,99,235,0.3) }
              #messages-sidebar-title { font-size:20px; font-weight:700; display:flex; align-items:center; gap:10px; color:white }
              #messages-btn-new { padding:10px; background:rgba(255,255,255,0.2); border:none; border-radius:10px; cursor:pointer; color:white; transition:all 0.2s; backdrop-filter:blur(10px) }
              #messages-btn-new:hover { background:rgba(255,255,255,0.3); transform:scale(1.05) }
              #messages-btn-settings { padding:10px; background:rgba(255,255,255,0.2); border:none; border-radius:10px; cursor:pointer; color:white; transition:all 0.2s; backdrop-filter:blur(10px); margin-left:8px }
              #messages-btn-settings:hover { background:rgba(255,255,255,0.3); transform:scale(1.05) }
              #messages-conversations { flex:1; overflow-y:auto; padding:8px }
              .msg-conv-item { padding:16px; border-radius:12px; margin-bottom:6px; cursor:pointer; transition:all 0.2s; background:#0f172a; border:1px solid transparent; color:#e2e8f0 }
              .msg-conv-item:hover { background:#334155; border-color:#475569; transform:translateX(4px); box-shadow:0 2px 8px rgba(59,130,246,0.2) }
              .msg-conv-item.active { background:linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); border-color:#3b82f6; box-shadow:0 4px 12px rgba(59,130,246,0.4) }
              .msg-conv-name { font-weight:700; margin-bottom:6px; color:#f1f5f9; font-size:15px }
              .msg-conv-phone { font-size:12px; color:#94a3b8; display:flex; align-items:center; gap:6px }
              .msg-conv-last { font-size:13px; color:#94a3b8; margin-top:6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
              #messages-chat-header { padding:20px; background:linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color:white; box-shadow:0 2px 10px rgba(37,99,235,0.3); position: relative; }
              #messages-chat-title { font-weight:700; font-size:18px; margin-left: 46px; }
              #messages-chat-subtitle { font-size:13px; color:rgba(255,255,255,0.9); display:flex; align-items:center; gap:6px; margin-top:6px; margin-left: 46px; }
              #messages-messages { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:16px; background:#0f172a }
              .msg { display:flex; animation:msg-fade-in 0.3s ease-out }
              @keyframes msg-fade-in { from { opacity:0; transform:translateY(10px) } to { opacity:1; transform:translateY(0) }}
              .msg.mine { justify-content:flex-end }
              .msg-bubble { max-width:65%; padding:14px 18px; border-radius:18px; word-break:break-word; box-shadow:0 2px 8px rgba(0,0,0,0.3) }
              .msg.mine .msg-bubble { background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color:#fff; border-bottom-right-radius:6px }
              .msg.other .msg-bubble { background:#334155; color:#f1f5f9; border-bottom-left-radius:6px; border:1px solid #475569 }
              .msg-sender { font-size:12px; font-weight:700; opacity:0.9; margin-bottom:6px; letter-spacing:0.3px }
              .msg-time { font-size:11px; opacity:0.7; margin-top:6px; display:flex; align-items:center; gap:4px }
              #messages-input-area { padding:20px; background:#1e293b; border-top:1px solid #334155; display:flex; gap:12px }
              #messages-input-area input { flex:1; padding:14px 18px; background:#0f172a; border:2px solid #334155; border-radius:14px; color:#f1f5f9; outline:none; font-size:15px; transition:all 0.2s }
              #messages-input-area input:focus { border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,0.2) }
              #messages-btn-send { padding:14px 28px; background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border:none; border-radius:14px; color:#fff; font-weight:700; cursor:pointer; transition:all 0.2s; box-shadow:0 2px 10px rgba(59,130,246,0.4) }
              #messages-btn-send:hover { transform:translateY(-2px); box-shadow:0 4px 16px rgba(59,130,246,0.5) }
              #messages-btn-send:disabled { opacity:0.5; cursor:not-allowed; transform:none }
              .msg-empty { flex:1; display:flex; align-items:center; justify-content:center; flex-direction:column; color:#64748b }
              .msg-empty svg { width:72px; height:72px; opacity:0.4; margin-bottom:20px; stroke:#64748b }
              .msg-loader { display:flex; align-items:center; justify-content:center; height:100%; color:#64748b }
              .msg-spinner { width:40px; height:40px; border:3px solid #334155; border-top-color:#3b82f6; border-radius:50%; animation:msg-spin 0.8s linear infinite }
              @keyframes msg-spin { to { transform:rotate(360deg) }}
              #messages-modal { position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); display:none; align-items:center; justify-content:center; z-index:10000; animation:msg-modal-fade-in 0.2s }
              @keyframes msg-modal-fade-in { from { opacity:0 } to { opacity:1 }}
              #messages-modal.show { display:flex }
              #messages-modal-content { background:#1e293b; border:1px solid #334155; border-radius:20px; padding:28px; width:90%; max-width:460px; max-height:80vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.5); animation:msg-modal-slide-up 0.3s ease-out }
              @keyframes msg-modal-slide-up { from { transform:translateY(20px); opacity:0 } to { transform:translateY(0); opacity:1 }}
              #messages-modal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px }
              #messages-modal-title { font-size:22px; font-weight:700; color:#f1f5f9 }
              #messages-btn-close { padding:6px; background:transparent; border:none; color:#94a3b8; cursor:pointer; font-size:28px; transition:all 0.2s; line-height:1 }
              #messages-btn-close:hover { color:#ef4444; transform:rotate(90deg) }
              #messages-user-list { display:flex; flex-direction:column; gap:10px }
              .msg-user-item { padding:16px; border-radius:12px; background:#0f172a; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; gap:14px; border:2px solid transparent }
              .msg-user-item:hover { background:#334155; border-color:#3b82f6; transform:translateX(4px); box-shadow:0 2px 12px rgba(59,130,246,0.3) }
              .msg-user-item input[type=checkbox] { width:20px; height:20px; cursor:pointer; accent-color:#3b82f6 }
              .msg-user-info { flex:1 }
              .msg-user-name { font-weight:700; color:#f1f5f9; font-size:15px }
              .msg-user-phone { font-size:12px; color:#94a3b8; display:flex; align-items:center; gap:6px; margin-top:4px }
              #messages-btn-create { width:100%; padding:16px; background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border:none; border-radius:12px; color:#fff; font-weight:700; cursor:pointer; margin-top:20px; transition:all 0.2s; box-shadow:0 4px 16px rgba(59,130,246,0.4); font-size:15px }
              #messages-btn-create:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(59,130,246,0.5) }
              #messages-btn-create:disabled { opacity:0.5; cursor:not-allowed; transform:none }
              .msg-check-icon { color:#10b981; font-size:14px; font-weight:700 }
              #messages-search-input { width:100%; padding:14px 18px; border:2px solid #334155; background:#0f172a; color:#f1f5f9; border-radius:12px; margin-bottom:16px; font-size:14px; transition:all 0.2s; outline:none }
              #messages-search-input:focus { border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,0.2) }

              .msg-conv-item { position:relative; padding-right:48px }
              .msg-conv-delete { position:absolute; right:8px; top:50%; transform:translateY(-50%); width:32px; height:32px; background:#ef4444; border:none; border-radius:8px; color:white; cursor:pointer; opacity:0; transition:all 0.2s; display:flex; align-items:center; justify-content:center; font-size:16px }
              .msg-conv-item:hover .msg-conv-delete { opacity:1 }
              .msg-conv-delete:hover { background:#dc2626; transform:translateY(-50%) scale(1.1) }

              .msg-attachment-area { padding:16px 20px; background:#1e293b; border-top:1px solid #334155; display:none }
              .msg-attachment-area.show { display:block }
              .msg-attachment-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px }
              .msg-attachment-title { font-size:14px; font-weight:600; color:#f1f5f9 }
              .msg-attachment-quota { font-size:12px; color:#94a3b8 }
              .msg-attachment-list { display:flex; flex-direction:column; gap:8px; max-height:200px; overflow-y:auto }
              .msg-attachment-item { display:flex; align-items:center; gap:12px; padding:10px; background:#0f172a; border:1px solid #334155; border-radius:8px; transition:all 0.2s }
              .msg-attachment-item:hover { border-color:#3b82f6; background:#1e293b }
              .msg-attachment-icon { width:36px; height:36px; display:flex; align-items:center; justify-content:center; background:#334155; border-radius:6px; font-size:18px }
              .msg-attachment-info { flex:1; min-width:0 }
              .msg-attachment-name { font-size:13px; font-weight:500; color:#f1f5f9; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
              .msg-attachment-size { font-size:11px; color:#94a3b8 }
              .msg-attachment-remove { width:24px; height:24px; background:transparent; border:none; color:#ef4444; cursor:pointer; border-radius:4px; display:flex; align-items:center; justify-content:center; transition:all 0.2s }
              .msg-attachment-remove:hover { background:#ef4444; color:white }
              .msg-attachment-progress { margin-top:6px }
              .msg-attachment-progress-bar { width:100%; height:4px; background:#334155; border-radius:2px; overflow:hidden }
              .msg-attachment-progress-fill { height:100%; background:linear-gradient(90deg, #3b82f6, #2563eb); transition:width 0.3s }

              .msg-attachments-display { margin-top:10px; display:flex; flex-wrap:wrap; gap:8px }
              .msg-attachment-card { position:relative; width:200px; background:#1e293b; border:1px solid #334155; border-radius:10px; overflow:hidden; transition:all 0.2s; cursor:pointer }
              .msg-attachment-card:hover { border-color:#3b82f6; transform:translateY(-2px); box-shadow:0 4px 12px rgba(59,130,246,0.3) }
              .msg-attachment-img { width:100%; height:120px; object-fit:cover; background:#0f172a }
              .msg-attachment-no-img { width:100%; height:120px; display:flex; align-items:center; justify-content:center; background:#0f172a; font-size:48px }
              .msg-attachment-details { padding:10px }
              .msg-attachment-card-name { font-size:12px; font-weight:500; color:#f1f5f9; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-bottom:4px }
              .msg-attachment-card-size { font-size:10px; color:#94a3b8 }

              .msg-btn-attach { width:40px; height:40px; background:#334155; border:1px solid #475569; border-radius:10px; cursor:pointer; display:flex; align-items:center; justify-content:center; color:#f1f5f9; transition:all 0.2s }
              .msg-btn-attach:hover { background:#3b82f6; border-color:#3b82f6; color:white }
              .msg-btn-attach.active { background:#3b82f6; border-color:#3b82f6; color:white }

              #messages-delete-modal { position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); display:none; align-items:center; justify-content:center; z-index:10000 }
              #messages-delete-modal.show { display:flex }
              #messages-delete-modal-content { background:#1e293b; border:1px solid #334155; border-radius:16px; padding:24px; width:90%; max-width:420px; box-shadow:0 20px 60px rgba(0,0,0,0.5) }
              .msg-delete-header { display:flex; align-items:center; gap:12px; margin-bottom:16px }
              .msg-delete-icon { width:48px; height:48px; background:#fef2f2; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:24px }
              .msg-delete-title { font-size:20px; font-weight:700; color:#f1f5f9 }
              .msg-delete-text { color:#cbd5e1; margin-bottom:20px; line-height:1.5; font-size:14px }
              .msg-delete-actions { display:flex; gap:10px }
              .msg-delete-btn { flex:1; padding:12px; border:none; border-radius:10px; font-weight:600; cursor:pointer; transition:all 0.2s; font-size:14px }
              .msg-delete-btn-cancel { background:#334155; color:#f1f5f9 }

              #messages-settings-modal { position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); display:none; align-items:center; justify-content:center; z-index:10000 }
              #messages-settings-modal.show { display:flex }
              #messages-settings-modal-content { background:#1e293b; border:1px solid #334155; border-radius:16px; padding:24px; width:90%; max-width:500px; box-shadow:0 20px 60px rgba(0,0,0,0.5) }
              .msg-settings-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid #334155 }
              .msg-settings-title { font-size:20px; font-weight:700; color:#f1f5f9 }
              .msg-settings-close { background:transparent; border:none; color:#94a3b8; font-size:28px; cursor:pointer; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:8px; transition:all 0.2s }
              .msg-settings-close:hover { background:#334155; color:#f1f5f9 }
              .msg-settings-body { margin-bottom:24px }
              .msg-settings-field { margin-bottom:20px }
              .msg-settings-field label { display:block; font-size:14px; font-weight:600; color:#f1f5f9; margin-bottom:8px }
              .msg-settings-field input { width:100%; padding:12px; background:#0f172a; border:1px solid #334155; border-radius:10px; color:#f1f5f9; font-size:14px; transition:all 0.2s }
              .msg-settings-field input:focus { outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,0.1) }
              .msg-settings-hint { font-size:12px; color:#94a3b8; margin-top:6px }
              .msg-settings-readonly { padding:12px; background:#0f172a; border:1px solid #334155; border-radius:10px; color:#94a3b8; font-size:14px }
              .msg-settings-actions { display:flex; gap:10px }
              .msg-settings-btn { flex:1; padding:12px; border:none; border-radius:10px; font-weight:600; cursor:pointer; transition:all 0.2s; font-size:14px }
              .msg-settings-btn-cancel { background:#334155; color:#f1f5f9 }
              .msg-settings-btn-cancel:hover { background:#475569 }
              .msg-settings-btn-save { background:#3b82f6; color:white }
              .msg-settings-btn-save:hover { background:#2563eb; transform:translateY(-1px); box-shadow:0 4px 12px rgba(59,130,246,0.4) }
              .msg-delete-btn-cancel:hover { background:#475569 }
              .msg-delete-btn-confirm { background:#ef4444; color:white }
              .msg-delete-btn-confirm:hover { background:#dc2626; transform:translateY(-1px) }
            </style>
            <div id="messages-app">
              <div id="messages-sidebar">
                <div id="messages-sidebar-header">
                  <div id="messages-sidebar-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    Messages
                  </div>
                  <div style="display: flex; gap: 8px;">
                    <button id="messages-btn-new" onclick="WebOS.Apps.Messages.showNewConversation()">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                      </svg>
                    </button>
                    <button id="messages-btn-settings" onclick="WebOS.Apps.Messages.showSettings()">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1v6m0 6v6m9-9h-6m-6 0H3"/>
                      </svg>
                    </button>
                  </div>
                </div>
                <div id="messages-conversations">
                  <div class="msg-loader"><div class="msg-spinner"></div></div>
                </div>
              </div>
              <div id="messages-main">
                <div class="msg-empty">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                  </svg>
                  <p>Sélectionnez une conversation</p>
                </div>
              </div>
            </div>
            <div id="messages-modal">
              <div id="messages-modal-content">
                <div id="messages-modal-header">
                  <div id="messages-modal-title">Nouvelle conversation</div>
                  <button id="messages-btn-close">&times;</button>
                </div>
                <input type="text" id="messages-search-input" placeholder="Rechercher par nom, email ou numéro..." />
                <div id="messages-user-list">
                  <div class="msg-loader"><div class="msg-spinner"></div></div>
                </div>
                <button id="messages-btn-create" disabled>
                  Créer (0)
                </button>
              </div>
            </div>
            <div id="messages-delete-modal">
              <div id="messages-delete-modal-content">
                <div class="msg-delete-header">
                  <div class="msg-delete-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                      <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6"/>
                    </svg>
                  </div>
                  <div class="msg-delete-title">Supprimer la conversation</div>
                </div>
                <div class="msg-delete-text">
                  Êtes-vous sûr de vouloir supprimer cette conversation? Tous les messages et pièces jointes seront définitivement supprimés.
                </div>
                <div class="msg-delete-actions">
                  <button class="msg-delete-btn msg-delete-btn-cancel" id="messages-delete-cancel">Annuler</button>
                  <button class="msg-delete-btn msg-delete-btn-confirm" id="messages-delete-confirm">Supprimer</button>
                </div>
              </div>
            </div>
            <div id="messages-settings-modal">
              <div id="messages-settings-modal-content">
                <div class="msg-settings-header">
                  <div class="msg-settings-title">Paramètres du profil</div>
                  <button class="msg-settings-close" id="messages-settings-close">&times;</button>
                </div>
                <div class="msg-settings-body">
                  <div class="msg-settings-field">
                    <label for="messages-settings-name">Nom d'affichage</label>
                    <input type="text" id="messages-settings-name" placeholder="Entrez votre nom" />
                    <div class="msg-settings-hint">Ce nom sera visible par les autres utilisateurs dans les conversations</div>
                  </div>
                  <div class="msg-settings-field">
                    <label>Email</label>
                    <div id="messages-settings-email" class="msg-settings-readonly"></div>
                  </div>
                </div>
                <div class="msg-settings-actions">
                  <button class="msg-settings-btn msg-settings-btn-cancel" id="messages-settings-cancel">Annuler</button>
                  <button class="msg-settings-btn msg-settings-btn-save" id="messages-settings-save">Enregistrer</button>
                </div>
              </div>
            </div>
            <input type="file" id="messages-file-input" multiple style="display:none" />
          `;

          WindowManager.create('messages', 'Messages', content, {
            width: 1200,
            height: 800,
            onClose: () => {
              if (this.activeChannel) {
                supabaseClient.removeChannel(this.activeChannel);
                this.activeChannel = null;
              }
            }
          });

          await this.init();
          this.attachEventListeners();
        },

        attachEventListeners() {
          // Bouton créer conversation
          const btnCreate = document.getElementById('messages-btn-create');
          if (btnCreate) {
            btnCreate.addEventListener('click', () => this.createConversation());
          }

          // Bouton nouveau message
          const btnNew = document.getElementById('messages-btn-new');
          if (btnNew) {
            btnNew.addEventListener('click', () => this.showNewConversation());
          }

          // Bouton settings
          const btnSettings = document.getElementById('messages-btn-settings');
          if (btnSettings) {
            btnSettings.addEventListener('click', () => this.showSettings());
          }

          // Bouton fermer modal
          const btnClose = document.getElementById('messages-btn-close');
          if (btnClose) {
            btnClose.addEventListener('click', () => this.hideNewConversation());
          }

          // Input de recherche
          const searchInput = document.getElementById('messages-search-input');
          if (searchInput) {
            searchInput.addEventListener('input', (e) => this.filterUsers(e.target.value));
          }

          // Bouton envoyer message
          const btnSend = document.getElementById('messages-btn-send');
          if (btnSend) {
            btnSend.addEventListener('click', () => this.sendMessage());
          }

          // Input message (Enter = envoyer)
          const msgInput = document.getElementById('messages-input');
          if (msgInput) {
            msgInput.addEventListener('keypress', (e) => {
              if (e.key === 'Enter') this.sendMessage();
            });
          }

          // Bouton retour (mobile)
          const btnBack = document.querySelector('.msg-back-btn');
          if (btnBack) {
            btnBack.addEventListener('click', () => this.toggleSidebar());
          }

          // File input
          const fileInput = document.getElementById('messages-file-input');
          if (fileInput) {
            fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
          }

          // Bouton attach
          const btnAttach = document.querySelector('.msg-btn-attach');
          if (btnAttach) {
            btnAttach.addEventListener('click', () => {
              const fileInput = document.getElementById('messages-file-input');
              if (fileInput) fileInput.click();
            });
          }

          // Modal suppression
          const btnDeleteCancel = document.getElementById('messages-delete-cancel');
          if (btnDeleteCancel) {
            btnDeleteCancel.addEventListener('click', () => this.hideDeleteModal());
          }

          const btnDeleteConfirm = document.getElementById('messages-delete-confirm');
          if (btnDeleteConfirm) {
            btnDeleteConfirm.addEventListener('click', () => this.confirmDelete());
          }

          // Modal settings
          const btnSettingsClose = document.getElementById('messages-settings-close');
          if (btnSettingsClose) {
            btnSettingsClose.addEventListener('click', () => this.hideSettings());
          }

          const btnSettingsCancel = document.getElementById('messages-settings-cancel');
          if (btnSettingsCancel) {
            btnSettingsCancel.addEventListener('click', () => this.hideSettings());
          }

          const btnSettingsSave = document.getElementById('messages-settings-save');
          if (btnSettingsSave) {
            btnSettingsSave.addEventListener('click', () => this.saveSettings());
          }
        },

        async init() {
          await this.loadConversations();
          await this.loadAllUsers();
        },

        async loadConversations() {
          try {
            const { data: convos } = await supabaseClient
              .from('conversations')
              .select('*, conversation_participants!inner(user_id)')
              .order('updated_at', { ascending: false });

            if (convos) {
              this.conversations = await Promise.all(convos.map(async (c) => {
                const { data: participants } = await supabaseClient
                  .from('conversation_participants')
                  .select('user_id, users(id, email, full_name, phone_number, phone_verified)')
                  .eq('conversation_id', c.id);

                console.log('Raw participants for conversation', c.id, ':', participants);

                const { data: lastMsg } = await supabaseClient
                  .from('messages')
                  .select('*')
                  .eq('conversation_id', c.id)
                  .order('created_at', { ascending: false })
                  .limit(1)
                  .maybeSingle();

                const mappedParticipants = participants?.map(p => p.users).filter(u => u) || [];
                console.log('Mapped participants for conversation', c.id, ':', mappedParticipants);

                return { ...c, participants: mappedParticipants, last_message: lastMsg };
              }));

              this.renderConversations();
            }
          } catch (error) {
            console.error('Error loading conversations:', error);
          }
        },

        renderConversations() {
          const container = document.getElementById('messages-conversations');
          if (!container) return;

          if (!this.conversations.length) {
            container.innerHTML = '<div style="padding:20px;text-align:center;color:#71717a">Aucune conversation</div>';
            return;
          }

          container.innerHTML = this.conversations.map(c => {
            const others = c.participants.filter(p => p && p.id !== currentUser.id);
            const otherUser = others[0];

            let name = 'Utilisateur';
            if (c.type === 'group') {
              name = c.name || `Groupe (${c.participants.length})`;
            } else if (otherUser) {
              name = otherUser.full_name || otherUser.email || 'Utilisateur';
            }

            console.log('Conversation:', c.id, 'Other user:', otherUser, 'Name:', name);
            const phone = others[0]?.phone_number;
            const verified = others[0]?.phone_verified;
            const last = c.last_message?.content || '';

            return `
              <div class="msg-conv-item ${this.currentConversation === c.id ? 'active' : ''}" data-conv-id="${c.id}">
                <div class="msg-conv-name">${name}</div>
                ${phone ? `<div class="msg-conv-phone"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline-block;vertical-align:middle;margin-right:4px"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>${phone} ${verified ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="3" style="display:inline-block;vertical-align:middle;margin-left:4px"><polyline points="20 6 9 17 4 12"/></svg>' : ''}</div>` : ''}
                ${last ? `<div class="msg-conv-last">${last}</div>` : ''}
                <button class="msg-conv-delete" data-delete-conv-id="${c.id}">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                  </svg>
                </button>
              </div>
            `;
          }).join('');

          // Ajouter les event listeners
          container.querySelectorAll('.msg-conv-item').forEach(item => {
            const convId = item.dataset.convId;
            item.addEventListener('click', (e) => {
              if (!e.target.closest('.msg-conv-delete')) {
                this.selectConversation(convId);
              }
            });

            const deleteBtn = item.querySelector('.msg-conv-delete');
            if (deleteBtn) {
              deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.showDeleteModal(convId);
              });
            }
          });
        },

        async selectConversation(id) {
          this.currentConversation = id;
          this.renderConversations();
          await this.loadMessages(id);
          this.subscribeToMessages(id);

          const sidebar = document.getElementById('messages-sidebar');
          const main = document.getElementById('messages-main');
          if (sidebar && main) {
            sidebar.classList.add('slide-left');
            main.classList.add('full-width');
          }
        },

        toggleSidebar() {
          const sidebar = document.getElementById('messages-sidebar');
          const main = document.getElementById('messages-main');
          if (sidebar && main) {
            sidebar.classList.toggle('slide-left');
            main.classList.toggle('full-width');
          }
        },

        async loadMessages(conversationId) {
          let convo = this.conversations.find(c => c.id === conversationId);

          if (!convo) {
            await this.loadConversations();
            convo = this.conversations.find(c => c.id === conversationId);
            if (!convo) return;
          }

          const others = convo.participants.filter(p => p.id !== currentUser.id);

          const { data: messages, error } = await supabaseClient
            .from('messages')
            .select(`
              *,
              sender:users!messages_sender_id_fkey(id, email, full_name),
              message_receipts(message_id, user_id, read_at),
              message_attachments(*)
            `)
            .eq('conversation_id', conversationId)
            .order('created_at', { ascending: true });

          if (error) {
            console.error('Error loading messages:', error);
            return;
          }

          const main = document.getElementById('messages-main');
          if (!main) return;

          main.innerHTML = `
            <div id="messages-chat-header">
              <button class="msg-back-btn" onclick="WebOS.Apps.Messages.toggleSidebar()">&lt;</button>
              <div id="messages-chat-title">${convo.type === 'group' ? convo.name || `Groupe (${convo.participants.length})` : others[0]?.full_name || others[0]?.email}</div>
              ${others[0]?.phone_number ? `<div id="messages-chat-subtitle"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline-block;vertical-align:middle;margin-right:4px"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>${others[0].phone_number} ${others[0].phone_verified ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="3" style="display:inline-block;vertical-align:middle;margin-left:4px"><polyline points="20 6 9 17 4 12"/></svg>' : ''}</div>` : ''}
            </div>
            <div id="messages-messages">
              ${messages?.map(m => {
                const isMine = m.sender_id === currentUser.id;
                const hasRead = m.message_receipts && m.message_receipts.length > 0;
                const attachments = m.message_attachments || [];
                return `
                  <div class="msg ${isMine ? 'mine' : 'other'}">
                    <div class="msg-bubble">
                      ${!isMine && convo.type === 'group' ? `<div class="msg-sender">${m.sender?.full_name || m.sender?.email}</div>` : ''}
                      <div>${m.content}</div>
                      ${attachments.length > 0 ? `
                        <div class="msg-attachments-display">
                          ${attachments.map(att => `
                            <div class="msg-attachment-card" onclick="WebOS.Apps.Messages.downloadAttachment('${att.storage_path}', '${att.file_name}')">
                              ${att.file_type.startsWith('image/') ?
                                `<img src="" class="msg-attachment-img" data-path="${att.storage_path}" onload="WebOS.Apps.Messages.loadAttachmentImage(this)" />` :
                                `<div class="msg-attachment-no-img">${WebOS.Apps.Messages.getFileIcon(att.file_type)}</div>`
                              }
                              <div class="msg-attachment-details">
                                <div class="msg-attachment-card-name">${att.file_name}</div>
                                <div class="msg-attachment-card-size">${WebOS.Apps.Messages.formatFileSize(att.file_size)}</div>
                              </div>
                            </div>
                          `).join('')}
                        </div>
                      ` : ''}
                      <div class="msg-time">
                        ${new Date(m.created_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}
                        ${isMine ? (hasRead ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" style="display:inline-block;vertical-align:middle"><polyline points="20 6 9 17 4 12"/><polyline points="20 6 9 17 4 12" transform="translate(3,0)"/></svg>' : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline-block;vertical-align:middle"><polyline points="20 6 9 17 4 12"/></svg>') : ''}
                      </div>
                    </div>
                  </div>
                `;
              }).join('') || ''}
            </div>
            <div class="msg-attachment-area" id="messages-attachment-area">
              <div class="msg-attachment-header">
                <div class="msg-attachment-title">Pièces jointes (${this.selectedFiles.length}/10)</div>
                <div class="msg-attachment-quota">${WebOS.Apps.Messages.formatFileSize(this.storageQuota.used)} / ${WebOS.Apps.Messages.formatFileSize(this.storageQuota.limit)}</div>
              </div>
              <div class="msg-attachment-list" id="messages-attachment-list"></div>
            </div>
            <div id="messages-input-area">
              <button class="msg-btn-attach" id="messages-btn-attach" onclick="WebOS.Apps.Messages.toggleAttachmentArea()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                </svg>
              </button>
              <input type="text" id="messages-input" placeholder="Tapez votre message..." onkeydown="if(event.key==='Enter' && !event.shiftKey) WebOS.Apps.Messages.sendMessage()" />
              <button id="messages-btn-send" onclick="WebOS.Apps.Messages.sendMessage()">Envoyer</button>
            </div>
          `;

          const messagesDiv = document.getElementById('messages-messages');
          if (messagesDiv) {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          }
        },

        subscribeToMessages(conversationId) {
          if (this.activeChannel) {
            supabaseClient.removeChannel(this.activeChannel);
            this.activeChannel = null;
          }

          this.activeChannel = supabaseClient.channel(`messages:${conversationId}`)
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `conversation_id=eq.${conversationId}` },
              () => this.loadMessages(conversationId))
            .subscribe();
        },

        async loadAllUsers() {
          try {
            const { data, error } = await supabaseClient
              .from('users')
              .select('id, email, full_name, phone_number, phone_verified')
              .neq('id', currentUser.id);

            if (error) {
              console.warn('Error loading all users:', error);
              this.allUsers = [];
              return;
            }

            this.allUsers = data || [];
          } catch (err) {
            console.error('Failed to load users:', err);
            this.allUsers = [];
          }
        },

        filterUsers(term) {
          const searchTerm = term.toLowerCase();
          const filtered = this.allUsers.filter(u => {
            const name = (u.full_name || '').toLowerCase();
            const email = (u.email || '').toLowerCase();
            const phone = (u.phone_number || '').replace(/[\s()-]/g, '');
            const searchPhone = term.replace(/[\s()-]/g, '');

            return name.includes(searchTerm) ||
                   email.includes(searchTerm) ||
                   phone.includes(searchPhone);
          });

          this.renderUserList(filtered);
        },

        renderUserList(users) {
          const userList = document.getElementById('messages-user-list');
          if (!userList) return;

          if (!users.length) {
            userList.innerHTML = '<div style="padding:20px;text-align:center;color:#71717a">Aucun utilisateur trouvé</div>';
            return;
          }

          userList.innerHTML = users.map(u => `
            <label class="msg-user-item" data-user-id="${u.id}">
              <input type="checkbox" ${this.selectedUsers.includes(u.id) ? 'checked' : ''}>
              <div class="msg-user-info">
                <div class="msg-user-name">${u.full_name || u.email}</div>
                ${u.phone_number ? `<div class="msg-user-phone"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline-block;vertical-align:middle;margin-right:4px"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>${u.phone_number} ${u.phone_verified ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="3" style="display:inline-block;vertical-align:middle;margin-left:4px"><polyline points="20 6 9 17 4 12"/></svg>' : ''}</div>` : '<div class="msg-user-phone" style="color:#71717a;font-style:italic">Aucun numéro enregistré</div>'}
              </div>
            </label>
          `).join('');

          // Ajouter les event listeners pour les checkboxes
          userList.querySelectorAll('.msg-user-item input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
              const userId = e.target.closest('.msg-user-item').dataset.userId;
              this.toggleUser(userId);
            });
          });
        },

        showNewConversation() {
          const modal = document.getElementById('messages-modal');
          if (!modal) return;

          const searchInput = document.getElementById('messages-search-input');
          if (searchInput) searchInput.value = '';

          this.renderUserList(this.allUsers);
          this.selectedUsers = [];

          const btnCreate = document.getElementById('messages-btn-create');
          if (btnCreate) {
            btnCreate.disabled = true;
            btnCreate.textContent = 'Créer (0)';
          }

          modal.classList.add('show');
        },

        hideNewConversation() {
          const modal = document.getElementById('messages-modal');
          if (modal) modal.classList.remove('show');
        },

        toggleUser(userId) {
          if (this.selectedUsers.includes(userId)) {
            this.selectedUsers = this.selectedUsers.filter(id => id !== userId);
          } else {
            this.selectedUsers.push(userId);
          }

          const btnCreate = document.getElementById('messages-btn-create');
          if (btnCreate) {
            btnCreate.disabled = this.selectedUsers.length === 0;
            btnCreate.textContent = `Créer (${this.selectedUsers.length})`;
          }
        },

        async createConversation() {
          if (this.selectedUsers.length === 0) {
            console.log('[Messages] No users selected');
            return;
          }

          try {
            console.log('[Messages] Creating conversation with users:', this.selectedUsers);

            // Vérifier l'authentification
            const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
            if (authError || !user) {
              console.error('[Messages] Not authenticated:', authError);
              alert('Vous devez être connecté pour créer une conversation');
              return;
            }
            console.log('[Messages] Authenticated as:', user.id);

            const type = this.selectedUsers.length === 1 ? 'direct' : 'group';

            const conversationName = type === 'direct'
              ? null
              : `Groupe (${this.selectedUsers.length + 1} membres)`;

            const { data: convo, error: convoError } = await supabaseClient
              .from('conversations')
              .insert({
                type,
                name: conversationName,
                created_by: user.id
              })
              .select()
              .single();

            if (convoError) {
              console.error('[Messages] Error creating conversation:', convoError);
              alert('Erreur lors de la création de la conversation: ' + convoError.message);
              return;
            }

            if (convo) {
              console.log('[Messages] Conversation created:', convo.id);
              const participants = [user.id, ...this.selectedUsers].map(userId => ({
                conversation_id: convo.id,
                user_id: userId
              }));

              const { error: participantsError } = await supabaseClient
                .from('conversation_participants')
                .insert(participants);

              if (participantsError) {
                console.error('[Messages] Error adding participants:', participantsError);
                alert('Erreur lors de l\'ajout des participants: ' + participantsError.message);
                return;
              }

              console.log('[Messages] Participants added successfully');
              this.hideNewConversation();
              await this.loadConversations();
              await this.selectConversation(convo.id);
            }
          } catch (error) {
            console.error('[Messages] Exception in createConversation:', error);
            alert('Erreur: ' + error.message);
          }
        },

        showDeleteModal(conversationId) {
          this.conversationToDelete = conversationId;
          const modal = document.getElementById('messages-delete-modal');
          if (modal) modal.classList.add('show');
        },

        hideDeleteModal() {
          this.conversationToDelete = null;
          const modal = document.getElementById('messages-delete-modal');
          if (modal) modal.classList.remove('show');
        },

        async confirmDelete() {
          if (!this.conversationToDelete) return;

          try {
            const { error } = await supabaseClient
              .from('conversations')
              .delete()
              .eq('id', this.conversationToDelete);

            if (error) {
              console.error('Error deleting conversation:', error);
              alert('Erreur lors de la suppression de la conversation');
              return;
            }

            if (this.currentConversation === this.conversationToDelete) {
              this.currentConversation = null;
              const main = document.getElementById('messages-main');
              if (main) {
                main.innerHTML = `
                  <div class="msg-empty">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <p>Sélectionnez une conversation</p>
                  </div>
                `;
              }
            }

            await this.loadConversations();
            this.hideDeleteModal();
          } catch (err) {
            console.error('Failed to delete conversation:', err);
            alert('Erreur lors de la suppression');
          }
        },

        async showSettings() {
          const modal = document.getElementById('messages-settings-modal');
          if (!modal) return;

          const { data: { user } } = await supabaseClient.auth.getUser();
          if (!user) return;

          const { data: profile } = await supabaseClient
            .from('users')
            .select('full_name, email')
            .eq('id', user.id)
            .maybeSingle();

          const nameInput = document.getElementById('messages-settings-name');
          const emailDiv = document.getElementById('messages-settings-email');

          if (nameInput) nameInput.value = profile?.full_name || '';
          if (emailDiv) emailDiv.textContent = profile?.email || user.email || '';

          modal.classList.add('show');
        },

        hideSettings() {
          const modal = document.getElementById('messages-settings-modal');
          if (modal) modal.classList.remove('show');
        },

        async saveSettings() {
          const nameInput = document.getElementById('messages-settings-name');
          if (!nameInput) return;

          const newName = nameInput.value.trim();
          if (!newName) {
            alert('Le nom ne peut pas être vide');
            return;
          }

          try {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) {
              alert('Utilisateur non authentifié');
              return;
            }

            const { error } = await supabaseClient
              .from('users')
              .update({ full_name: newName })
              .eq('id', user.id);

            if (error) {
              console.error('Error updating profile:', error);
              alert('Erreur lors de la mise à jour du profil');
              return;
            }

            alert('Nom d\'affichage mis à jour avec succès!');
            this.hideSettings();
            await this.loadConversations();
          } catch (err) {
            console.error('Failed to update profile:', err);
            alert('Erreur lors de la mise à jour');
          }
        },

        toggleAttachmentArea() {
          const area = document.getElementById('messages-attachment-area');
          const btn = document.getElementById('messages-btn-attach');
          if (!area) return;

          if (area.classList.contains('show')) {
            area.classList.remove('show');
            if (btn) btn.classList.remove('active');
          } else {
            area.classList.add('show');
            if (btn) btn.classList.add('active');
            document.getElementById('messages-file-input')?.click();
          }
        },

        async handleFileSelect(event) {
          const files = Array.from(event.target.files || []);
          if (files.length === 0) return;

          const maxFiles = 10 - this.selectedFiles.length;
          const filesToAdd = files.slice(0, maxFiles);

          for (const file of filesToAdd) {
            if (file.size > 524288000) {
              alert(`Le fichier "${file.name}" est trop volumineux (max 500 MB)`);
              continue;
            }

            this.selectedFiles.push({
              file,
              id: Math.random().toString(36).substr(2, 9),
              progress: 0
            });
          }

          this.renderAttachmentList();
          event.target.value = '';

          const area = document.getElementById('messages-attachment-area');
          const btn = document.getElementById('messages-btn-attach');
          if (area) area.classList.add('show');
          if (btn) btn.classList.add('active');
        },

        renderAttachmentList() {
          const list = document.getElementById('messages-attachment-list');
          if (!list) return;

          if (this.selectedFiles.length === 0) {
            list.innerHTML = '<div style="padding:20px;text-align:center;color:#64748b;font-size:13px">Aucun fichier sélectionné</div>';
            return;
          }

          list.innerHTML = this.selectedFiles.map(f => `
            <div class="msg-attachment-item" data-id="${f.id}">
              <div class="msg-attachment-icon">${this.getFileIcon(f.file.type)}</div>
              <div class="msg-attachment-info">
                <div class="msg-attachment-name">${f.file.name}</div>
                <div class="msg-attachment-size">${this.formatFileSize(f.file.size)}</div>
                ${f.progress > 0 && f.progress < 100 ? `
                  <div class="msg-attachment-progress">
                    <div class="msg-attachment-progress-bar">
                      <div class="msg-attachment-progress-fill" style="width:${f.progress}%"></div>
                    </div>
                  </div>
                ` : ''}
              </div>
              <button class="msg-attachment-remove" onclick="WebOS.Apps.Messages.removeFile('${f.id}')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
          `).join('');
        },

        removeFile(fileId) {
          this.selectedFiles = this.selectedFiles.filter(f => f.id !== fileId);
          this.renderAttachmentList();

          if (this.selectedFiles.length === 0) {
            const area = document.getElementById('messages-attachment-area');
            const btn = document.getElementById('messages-btn-attach');
            if (area) area.classList.remove('show');
            if (btn) btn.classList.remove('active');
          }
        },

        async sendMessage() {
          const input = document.getElementById('messages-input');
          const button = document.getElementById('messages-btn-send');
          if (!input || (!input.value.trim() && this.selectedFiles.length === 0) || !this.currentConversation) return;

          const content = input.value.trim() || '[Pièce(s) jointe(s)]';
          input.value = '';
          if (button) button.disabled = true;

          try {
            const { data: message, error: msgError } = await supabaseClient
              .from('messages')
              .insert({
                conversation_id: this.currentConversation,
                sender_id: currentUser.id,
                content: content
              })
              .select()
              .single();

            if (msgError) {
              console.error('Error sending message:', msgError);
              alert('Erreur lors de l\'envoi du message');
              input.value = content;
              return;
            }

            if (this.selectedFiles.length > 0 && message) {
              await this.uploadAttachments(message.id);
            }

            this.selectedFiles = [];
            this.renderAttachmentList();
            const area = document.getElementById('messages-attachment-area');
            const btn = document.getElementById('messages-btn-attach');
            if (area) area.classList.remove('show');
            if (btn) btn.classList.remove('active');

            await this.loadMessages(this.currentConversation);
          } catch (err) {
            console.error('Failed to send message:', err);
            alert('Erreur lors de l\'envoi du message');
            input.value = content;
          } finally {
            if (button) button.disabled = false;
            if (input) input.focus();
          }
        },

        async uploadAttachments(messageId) {
          for (const fileObj of this.selectedFiles) {
            try {
              const timestamp = Date.now();
              const randomStr = Math.random().toString(36).substring(7);
              const safeName = fileObj.file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
              const storagePath = `${currentUser.id}/${timestamp}_${randomStr}_${safeName}`;

              const { error: uploadError } = await supabaseClient.storage
                .from('message-attachments')
                .upload(storagePath, fileObj.file);

              if (uploadError) {
                console.error('Upload error:', uploadError);
                continue;
              }

              await supabaseClient.from('message_attachments').insert({
                message_id: messageId,
                file_name: fileObj.file.name,
                file_size: fileObj.file.size,
                file_type: fileObj.file.type,
                storage_path: storagePath,
                uploaded_by: currentUser.id
              });

            } catch (err) {
              console.error('Failed to upload attachment:', err);
            }
          }
        },

        async loadAttachmentImage(img) {
          try {
            const path = img.dataset.path;
            if (!path) return;

            const { data, error } = await supabaseClient.storage
              .from('message-attachments')
              .createSignedUrl(path, 3600);

            if (error) {
              console.error('Error loading image:', error);
              return;
            }

            img.src = data.signedUrl;
          } catch (err) {
            console.error('Failed to load image:', err);
          }
        },

        async downloadAttachment(storagePath, fileName) {
          try {
            const { data, error } = await supabaseClient.storage
              .from('message-attachments')
              .download(storagePath);

            if (error) {
              console.error('Download error:', error);
              alert('Erreur lors du téléchargement');
              return;
            }

            const url = URL.createObjectURL(data);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          } catch (err) {
            console.error('Failed to download:', err);
            alert('Erreur lors du téléchargement');
          }
        },

        getFileIcon(mimeType) {
          if (mimeType.startsWith('image/')) {
            return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>';
          }
          if (mimeType.startsWith('video/')) {
            return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m22 8-6 4 6 4V8Z"/><rect x="2" y="6" width="14" height="12" rx="2" ry="2"/></svg>';
          }
          if (mimeType.startsWith('audio/')) {
            return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>';
          }
          if (mimeType.includes('pdf')) {
            return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M10 12h4"/><path d="M10 16h4"/></svg>';
          }
          if (mimeType.includes('word') || mimeType.includes('document')) {
            return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>';
          }
          if (mimeType.includes('sheet') || mimeType.includes('excel')) {
            return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M8 13h2"/><path d="M14 13h2"/><path d="M8 17h2"/><path d="M14 17h2"/></svg>';
          }
          if (mimeType.includes('presentation') || mimeType.includes('powerpoint')) {
            return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="m10 11 4 4"/><path d="m14 11-4 4"/></svg>';
          }
          if (mimeType.includes('zip') || mimeType.includes('archive') || mimeType.includes('compressed')) {
            return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 22h2a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v3"/><path d="M14 2v6h6"/><circle cx="10" cy="20" r="2"/><path d="M10 7V6"/><path d="M10 12v-1"/><path d="M10 18v-2"/></svg>';
          }
          if (mimeType.includes('text')) {
            return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>';
          }
          return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>';
        },

        formatFileSize(bytes) {
          if (bytes === 0) return '0 B';
          const k = 1024;
          const sizes = ['B', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
      },

      Mail: {
        currentFolder: 'inbox',
        currentEmail: null,
        searchQuery: '',
        currentView: 'folders',
        currentAccountId: null,

        async open() {
          const content = `
            <div id="mailContainer" style="display: flex; height: 100%; width: 100%; overflow-x: hidden; position: relative;">
              <!-- Sidebar -->
              <div id="mailFolders" style="min-width: 100%; width: 100%; background: #f9fafb; display: flex; flex-direction: column; transition: transform 0.3s ease;">
                <button onclick="WebOS.Apps.Mail.compose()" style="margin: 16px; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline-block;vertical-align:middle;margin-right:6px"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Nouveau</button>

                <nav style="flex: 1; padding: 8px;">
                  <div id="folder-inbox" onclick="WebOS.Apps.Mail.selectFolder('inbox')" style="padding: 10px 12px; cursor: pointer; border-radius: 6px; margin-bottom: 2px; background: #e0e7ff; color: #1e40af; font-weight: 500; display: flex; justify-content: space-between; align-items: center;">
                    <span>Reception</span>
                    <span id="inbox-count" style="background: #1e40af; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">0</span>
                  </div>
                  <div id="folder-sent" onclick="WebOS.Apps.Mail.selectFolder('sent')" style="padding: 10px 12px; cursor: pointer; border-radius: 6px; margin-bottom: 2px;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                    <span>Envoyes</span>
                  </div>
                  <div id="folder-drafts" onclick="WebOS.Apps.Mail.selectFolder('drafts')" style="padding: 10px 12px; cursor: pointer; border-radius: 6px; margin-bottom: 2px;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                    <span>Brouillons</span>
                  </div>
                  <div id="folder-archive" onclick="WebOS.Apps.Mail.selectFolder('archive')" style="padding: 10px 12px; cursor: pointer; border-radius: 6px; margin-bottom: 2px;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                    <span>Archives</span>
                  </div>
                  <div id="folder-trash" onclick="WebOS.Apps.Mail.selectFolder('trash')" style="padding: 10px 12px; cursor: pointer; border-radius: 6px; margin-bottom: 2px;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                    <span>Corbeille</span>
                  </div>
                </nav>

                <div style="padding: 16px; border-top: 1px solid #e5e7eb;">
                  <div style="font-size: 12px; color: #6b7280;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                      <span>Espace utilisé:</span>
                      <span id="storage-used">0 MB</span>
                    </div>
                    <div style="background: #e5e7eb; height: 4px; border-radius: 2px; overflow: hidden;">
                      <div id="storage-bar" style="background: #3b82f6; height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Email List -->
              <div id="mailList" style="min-width: 100%; width: 100%; background: white; display: flex; flex-direction: column; transition: transform 0.3s ease;">
                <div style="padding: 16px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 12px;">
                  <button onclick="WebOS.Apps.Mail.slideToView('folders')" style="width: 36px; height: 36px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'" title="Retour aux dossiers">&lt;</button>
                  <input type="text" id="email-search" placeholder="Rechercher dans les courriels..." style="flex: 1; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" oninput="WebOS.Apps.Mail.search(this.value)" />
                  <button id="emptyTrashBtn" onclick="WebOS.Apps.Mail.emptyTrash()" style="display: none; padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">Vider la corbeille</button>
                </div>
                <div id="emailList" style="flex: 1; overflow-y: auto;">
                  <div style="padding: 20px; text-align: center; color: #9ca3af;">Chargement...</div>
                </div>
              </div>

              <!-- Email Content -->
              <div id="emailContent" style="min-width: 100%; width: 100%; overflow-y: auto; padding: 20px; background: white; transition: transform 0.3s ease;">
                <div style="text-align: center; padding: 60px 40px; color: #9ca3af;">
                  <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin: 0 auto 20px; opacity: 0.5;">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                    <polyline points="22,6 12,13 2,6"></polyline>
                  </svg>
                  <p style="font-size: 16px; margin: 0;">Sélectionnez un courriel pour le lire</p>
                </div>
              </div>
            </div>
          `;

          WindowManager.create('mail', 'Courriel', content, { width: 1400, height: 800 });
          await this.loadEmails();
          await this.updateStats();
        },

        async loadEmails() {
          if (!currentUser) return;

          try {
            const { data: account } = await supabaseClient
              .from('email_accounts')
              .select('id')
              .eq('user_id', currentUser.id)
              .maybeSingle();

            if (!account) {
              await this.createAccount();
              return this.loadEmails();
            }

            this.currentAccountId = account.id;

            let query = supabaseClient
              .from('emails')
              .select('*, email_attachments(count)')
              .eq('account_id', account.id);

            if (this.currentFolder === 'trash') {
              query = query.eq('is_deleted', true);
            } else {
              query = query.eq('is_deleted', false).eq('folder', this.currentFolder);
            }

            if (this.searchQuery) {
              query = query.or(`subject.ilike.%${this.searchQuery}%,body_text.ilike.%${this.searchQuery}%,from_address.ilike.%${this.searchQuery}%`);
            }

            const { data: emails, error } = await query
              .order('created_at', { ascending: false })
              .limit(100);

            if (error) throw error;

            this.renderEmailList(emails || []);
          } catch (error) {
            console.error('Load emails error:', error);
            this.renderEmailList([]);
          }
        },

        async search(query) {
          this.searchQuery = query;
          await this.loadEmails();
        },

        async updateStats() {
          if (!currentUser) return;

          try {
            const { data: account } = await supabaseClient
              .from('email_accounts')
              .select('id, storage_used_mb, storage_quota_mb')
              .eq('user_id', currentUser.id)
              .maybeSingle();

            if (!account) return;

            const { count } = await supabaseClient
              .from('emails')
              .select('*', { count: 'exact', head: true })
              .eq('account_id', account.id)
              .eq('folder', 'inbox')
              .eq('is_read', false)
              .eq('is_deleted', false);

            const countEl = document.getElementById('inbox-count');
            if (countEl) countEl.textContent = count || 0;

            const usedEl = document.getElementById('storage-used');
            if (usedEl) usedEl.textContent = `${account.storage_used_mb || 0} MB`;

            const barEl = document.getElementById('storage-bar');
            if (barEl) {
              const percentage = ((account.storage_used_mb || 0) / account.storage_quota_mb) * 100;
              barEl.style.width = `${Math.min(percentage, 100)}%`;
              if (percentage > 90) {
                barEl.style.background = '#ef4444';
              } else if (percentage > 75) {
                barEl.style.background = '#f59e0b';
              }
            }
          } catch (error) {
            console.error('Update stats error:', error);
          }
        },

        renderEmailList(emails) {
          const listDiv = document.getElementById('emailList');
          if (!listDiv) return;

          if (emails.length === 0) {
            listDiv.innerHTML = '<div style="padding: 40px 20px; text-align: center; color: #9ca3af;"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin: 0 auto 12px; opacity: 0.3;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg><p>Aucun courriel</p></div>';
            return;
          }

          listDiv.innerHTML = emails.map(email => {
            const hasAttachments = email.email_attachments && email.email_attachments.length > 0;
            const initials = email.from_address.split('@')[0].substring(0, 2).toUpperCase();
            const date = new Date(email.sent_at || email.created_at);
            const isToday = new Date().toDateString() === date.toDateString();
            const dateStr = isToday ? date.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' }) : date.toLocaleDateString('fr-CA', { day: 'numeric', month: 'short' });

            return `
            <div onclick="WebOS.Apps.Mail.viewEmail('${email.id}')" style="padding: 14px 16px; border-bottom: 1px solid #e5e7eb; cursor: pointer; ${email.is_read ? 'background: white;' : 'background: #eff6ff;'} transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='${email.is_read ? 'white' : '#eff6ff'}'">
              <div style="display: flex; gap: 10px;">
                <div style="width: 36px; height: 36px; background: ${email.is_read ? '#9ca3af' : '#3b82f6'}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px; flex-shrink: 0;">${initials}</div>
                <div style="flex: 1; min-width: 0;">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                    <span style="font-weight: ${email.is_read ? '500' : '700'}; color: #1f2937; font-size: 14px;">${email.from_address.split('@')[0]}</span>
                    <div style="display: flex; gap: 6px; align-items: center;">
                      ${email.is_starred ? '<span style="color: #f59e0b; font-size: 16px;">*</span>' : ''}
                      ${hasAttachments ? '<span style="color: #6b7280; font-size: 14px;">@</span>' : ''}
                      <span style="font-size: 11px; color: #9ca3af; white-space: nowrap;">${dateStr}</span>
                    </div>
                  </div>
                  <div style="font-size: 13px; font-weight: ${email.is_read ? '400' : '600'}; color: #1f2937; margin-bottom: 3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${email.subject || '(Sans objet)'}</div>
                  <div style="font-size: 12px; color: #6b7280; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${email.body_text ? email.body_text.substring(0, 70) + '...' : ''}</div>
                </div>
              </div>
            </div>
          `}).join('');
        },

        async viewEmail(emailId) {
          try {
            const { data: email, error } = await supabaseClient
              .from('emails')
              .select('*, email_attachments(*)')
              .eq('id', emailId)
              .maybeSingle();

            if (error) throw error;
            if (!email) return;

            this.currentEmail = email;

            if (!email.is_read) {
              await supabaseClient
                .from('emails')
                .update({ is_read: true, read_at: new Date().toISOString() })
                .eq('id', emailId);
              await this.loadEmails();
              await this.updateStats();
            }

            const contentDiv = document.getElementById('emailContent');
            if (!contentDiv) return;

            const attachmentsHtml = email.email_attachments && email.email_attachments.length > 0 ? `
              <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                <div style="font-weight: 600; color: #1f2937; margin-bottom: 12px;">Pieces jointes (${email.email_attachments.length})</div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                  ${email.email_attachments.map(att => `
                    <div style="padding: 10px 14px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; display: flex; align-items: center; gap: 8px; font-size: 13px;">
                      <span>-</span>
                      <span style="color: #1f2937;">${att.filename}</span>
                      <span style="color: #9ca3af;">(${(att.file_size / 1024).toFixed(1)} KB)</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : '';

            contentDiv.innerHTML = `
              <button onclick="WebOS.Apps.Mail.slideToView('list')" style="position: absolute; top: 16px; left: 16px; width: 36px; height: 36px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; z-index: 10; font-size: 18px;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'" title="Retour à la liste">
                &lt;
              </button>
              <div style="border-bottom: 1px solid #e5e7eb; padding: 20px 60px 20px 60px; margin-bottom: 24px;">
                <div style="margin-bottom: 20px;">
                  <h2 style="font-size: 24px; font-weight: 700; color: #1f2937; margin: 0 0 16px 0;">${email.subject || '(Sans objet)'}</h2>
                  <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <button onclick="WebOS.Apps.Mail.toggleStar('${email.id}', ${!email.is_starred})" style="padding: 8px 16px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 14px;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">${email.is_starred ? 'Retirer etoile' : 'Ajouter etoile'}</button>
                    <button onclick="WebOS.Apps.Mail.reply('${email.id}')" style="padding: 8px 16px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 14px;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">Repondre</button>
                    <button onclick="WebOS.Apps.Mail.archiveEmail('${email.id}')" style="padding: 8px 16px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 14px;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">Archiver</button>
                    <button onclick="WebOS.Apps.Mail.deleteEmail('${email.id}')" style="padding: 8px 16px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; color: #ef4444; transition: all 0.2s; font-size: 14px;" onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='white'">Supprimer</button>
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 14px;">
                  <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3); flex-shrink: 0;">${email.from_address[0].toUpperCase()}</div>
                  <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: 600; color: #1f2937; font-size: 15px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${email.from_address}</div>
                    <div style="font-size: 13px; color: #6b7280; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">A: ${email.to_addresses.join(', ')}</div>
                    ${email.cc_addresses && email.cc_addresses.length > 0 ? `<div style="font-size: 13px; color: #6b7280; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Cc: ${email.cc_addresses.join(', ')}</div>` : ''}
                  </div>
                  <div style="text-align: right; flex-shrink: 0;">
                    <div style="font-size: 13px; color: #6b7280; white-space: nowrap;">${new Date(email.sent_at || email.created_at).toLocaleDateString('fr-CA')}</div>
                    <div style="font-size: 12px; color: #9ca3af; white-space: nowrap;">${new Date(email.sent_at || email.created_at).toLocaleTimeString('fr-CA')}</div>
                  </div>
                </div>
              </div>
              <div style="font-size: 15px; line-height: 1.7; color: #1f2937; white-space: pre-wrap; padding: 0 60px 40px 60px; word-wrap: break-word; overflow-wrap: break-word;">${email.body_html || email.body_text}</div>
              ${attachmentsHtml}
            `;

            this.slideToView('content');
          } catch (error) {
            console.error('View email error:', error);
          }
        },

        async toggleStar(emailId, starred) {
          try {
            await supabaseClient
              .from('emails')
              .update({ is_starred: starred })
              .eq('id', emailId);

            await this.viewEmail(emailId);
            await this.loadEmails();
          } catch (error) {
            console.error('Toggle star error:', error);
          }
        },

        async archiveEmail(emailId) {
          try {
            await supabaseClient
              .from('emails')
              .update({ folder: 'archive' })
              .eq('id', emailId);

            await this.loadEmails();
            document.getElementById('emailContent').innerHTML = '<div style="text-align: center; padding: 60px 40px; color: #9ca3af;"><svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin: 0 auto 20px; opacity: 0.5;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg><p style="font-size: 16px; margin: 0;">Courriel archivé</p></div>';
            this.slideToView('list');
          } catch (error) {
            console.error('Archive email error:', error);
          }
        },

        async reply(emailId) {
          if (!this.currentEmail) return;

          const replyTo = this.currentEmail.from_address;
          const subject = this.currentEmail.subject.startsWith('Re:') ? this.currentEmail.subject : `Re: ${this.currentEmail.subject}`;

          const content = `
            <div style="display: flex; flex-direction: column; height: 100%; gap: 16px; padding: 20px;">
              <div>
                <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #374151;">À:</label>
                <input type="text" id="replyTo" value="${replyTo}" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" />
              </div>
              <div>
                <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #374151;">Sujet:</label>
                <input type="text" id="replySubject" value="${subject}" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" />
              </div>
              <div style="flex: 1; display: flex; flex-direction: column;">
                <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #374151;">Message:</label>
                <textarea id="replyBody" placeholder="Écrivez votre réponse..." style="flex: 1; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; resize: none; font-family: inherit; font-size: 14px; line-height: 1.6;"></textarea>
              </div>
              <div style="padding-top: 12px; border-top: 1px solid #e5e7eb;">
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">Message original:</div>
                <div style="padding: 12px; background: #f9fafb; border-left: 3px solid #d1d5db; border-radius: 4px; font-size: 13px; color: #6b7280; max-height: 150px; overflow-y: auto;">
                  <div style="font-weight: 600; margin-bottom: 4px;">De: ${this.currentEmail.from_address}</div>
                  <div style="margin-bottom: 8px;">Date: ${new Date(this.currentEmail.sent_at || this.currentEmail.created_at).toLocaleString('fr-CA')}</div>
                  <div style="white-space: pre-wrap;">${this.currentEmail.body_text}</div>
                </div>
              </div>
              <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button onclick="WebOS.WindowManager.close('reply')" style="padding: 10px 24px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">Annuler</button>
                <button onclick="WebOS.Apps.Mail.sendReply('${emailId}')" style="padding: 10px 24px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; transition: background 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">Envoyer</button>
              </div>
            </div>
          `;

          WindowManager.create('reply', 'Répondre', content, { width: 800, height: 700 });
        },

        async sendReply(inReplyTo) {
          const to = document.getElementById('replyTo')?.value;
          const subject = document.getElementById('replySubject')?.value;
          const body = document.getElementById('replyBody')?.value;

          if (!to || !subject || !body) {
            alert('Veuillez remplir tous les champs');
            return;
          }

          try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
              alert('Session expirée. Veuillez vous reconnecter.');
              return;
            }

            const threadId = this.currentEmail?.thread_id || crypto.randomUUID();

            const response = await fetch(
              `${CONFIG.supabase.url}/functions/v1/send-email`,
              {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${session.access_token}`,
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  to: [to],
                  subject: subject,
                  body: body,
                  threadId: threadId,
                  inReplyTo: inReplyTo,
                }),
              }
            );

            const result = await response.json();

            if (!response.ok || !result.success) {
              throw new Error(result.error || 'Failed to send reply');
            }

            alert('Réponse envoyée!');
            WindowManager.close('reply');
            await this.loadEmails();
            await this.updateStats();
          } catch (error) {
            console.error('Send reply error:', error);
            alert('Erreur lors de l\'envoi: ' + error.message);
          }
        },

        async compose() {
          const content = `
            <div style="display: flex; flex-direction: column; height: 100%; gap: 16px; padding: 20px;">
              <div style="position: relative;">
                <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #374151;">À: <button onclick="WebOS.Apps.Mail.showDirectory()" style="padding: 4px 8px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; cursor: pointer; margin-left: 8px;">⊞ Annuaire</button></label>
                <input type="text" id="mailTo" placeholder="prenom.nom@quebec.gouv.qc.ca" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" oninput="WebOS.Apps.Mail.searchRecipients(this.value)" autocomplete="off" />
                <div id="recipientSuggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; display: none; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
              </div>
              <div>
                <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #374151;">Cc: <span style="font-weight: 400; font-size: 12px; color: #9ca3af;">(optionnel)</span></label>
                <input type="text" id="mailCc" placeholder="copie@exemple.ca" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" />
              </div>
              <div>
                <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #374151;">Sujet:</label>
                <input type="text" id="mailSubject" placeholder="Sujet du message" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" />
              </div>
              <div style="flex: 1; display: flex; flex-direction: column;">
                <label style="display: block; font-weight: 500; margin-bottom: 4px; color: #374151;">Message:</label>
                <textarea id="mailBody" placeholder="Écrivez votre message..." style="flex: 1; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; resize: none; font-family: inherit; font-size: 14px; line-height: 1.6;"></textarea>
              </div>
              <div style="display: flex; gap: 8px; justify-content: space-between;">
                <button onclick="WebOS.Apps.Mail.saveDraft()" style="padding: 10px 20px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">Brouillon</button>
                <div style="display: flex; gap: 8px;">
                  <button onclick="WebOS.WindowManager.close('compose')" style="padding: 10px 20px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">Annuler</button>
                  <button onclick="WebOS.Apps.Mail.send()" style="padding: 10px 24px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; transition: background 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">Envoyer</button>
                </div>
              </div>
            </div>
          `;

          WindowManager.create('compose', 'Nouveau message', content, { width: 800, height: 700 });
        },

        async send() {
          const to = document.getElementById('mailTo')?.value;
          const cc = document.getElementById('mailCc')?.value;
          const subject = document.getElementById('mailSubject')?.value;
          const body = document.getElementById('mailBody')?.value;

          if (!to || !subject || !body) {
            alert('Veuillez remplir les champs obligatoires (À, Sujet, Message)');
            return;
          }

          try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
              alert('Session expirée. Veuillez vous reconnecter.');
              return;
            }

            const toAddresses = to.split(',').map(e => e.trim());
            const ccAddresses = cc ? cc.split(',').map(e => e.trim()) : [];

            const response = await fetch(
              `${CONFIG.supabase.url}/functions/v1/send-email`,
              {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${session.access_token}`,
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  to: toAddresses,
                  cc: ccAddresses,
                  subject: subject,
                  body: body,
                }),
              }
            );

            const result = await response.json();

            if (!response.ok || !result.success) {
              throw new Error(result.error || 'Failed to send email');
            }

            alert('Message envoyé à ' + toAddresses.join(', ') + '!');
            WindowManager.close('compose');
            await this.loadEmails();
            await this.updateStats();
          } catch (error) {
            console.error('Send email error:', error);
            alert('Erreur lors de l\'envoi: ' + error.message);
          }
        },

        async saveDraft() {
          const to = document.getElementById('mailTo')?.value;
          const cc = document.getElementById('mailCc')?.value;
          const subject = document.getElementById('mailSubject')?.value;
          const body = document.getElementById('mailBody')?.value;

          if (!to && !subject && !body) {
            alert('Aucun contenu à sauvegarder');
            return;
          }

          try {
            const { data: account } = await supabaseClient
              .from('email_accounts')
              .select('id, email_address')
              .eq('user_id', currentUser.id)
              .maybeSingle();

            if (!account) throw new Error('Email account not found');

            const emailData = {
              account_id: account.id,
              from_address: account.email_address,
              to_addresses: to ? [to] : [],
              subject: subject || '(Sans objet)',
              body_text: body || '',
              folder: 'drafts',
              is_draft: true
            };

            if (cc) {
              emailData.cc_addresses = cc.split(',').map(e => e.trim());
            }

            const { error } = await supabaseClient
              .from('emails')
              .insert([emailData]);

            if (error) throw error;

            alert('Brouillon sauvegardé!');
            WindowManager.close('compose');
            await this.updateStats();
          } catch (error) {
            console.error('Save draft error:', error);
            alert('Erreur lors de la sauvegarde: ' + error.message);
          }
        },

        async deleteEmail(emailId) {
          if (!confirm('Supprimer ce courriel?')) return;

          try {
            const { error } = await supabaseClient
              .from('emails')
              .update({ is_deleted: true, folder: 'trash' })
              .eq('id', emailId);

            if (error) throw error;

            await this.loadEmails();
            document.getElementById('emailContent').innerHTML = '<div style="text-align: center; padding: 60px 40px; color: #9ca3af;"><svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin: 0 auto 20px; opacity: 0.5;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg><p style="font-size: 16px; margin: 0;">Sélectionnez un courriel pour le lire</p></div>';
            this.slideToView('list');
          } catch (error) {
            console.error('Delete email error:', error);
            alert('Erreur lors de la suppression du courriel');
          }
        },

        async emptyTrash() {
          if (!confirm('Vider definitivement la corbeille? Cette action est irreversible.')) return;

          try {
            if (!this.currentAccountId) {
              alert('Compte de courriel non trouve');
              return;
            }

            const { error } = await supabaseClient
              .from('emails')
              .delete()
              .eq('folder', 'trash')
              .eq('account_id', this.currentAccountId);

            if (error) throw error;

            alert('Corbeille videe avec succes!');
            await this.loadEmails();
            document.getElementById('emailContent').innerHTML = '<div style="text-align: center; padding: 60px 40px; color: #9ca3af;"><svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin: 0 auto 20px; opacity: 0.5;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg><p style="font-size: 16px; margin: 0;">La corbeille est vide</p></div>';
          } catch (error) {
            console.error('Empty trash error:', error);
            alert('Erreur lors du vidage de la corbeille');
          }
        },

        async selectFolder(folder) {
          this.currentFolder = folder;
          this.searchQuery = '';

          const searchInput = document.getElementById('email-search');
          if (searchInput) searchInput.value = '';

          const emptyTrashBtn = document.getElementById('emptyTrashBtn');
          if (emptyTrashBtn) {
            emptyTrashBtn.style.display = folder === 'trash' ? 'block' : 'none';
          }

          ['inbox', 'sent', 'drafts', 'archive', 'trash'].forEach(f => {
            const el = document.getElementById(`folder-${f}`);
            if (el) {
              if (f === folder) {
                el.style.background = '#e0e7ff';
                el.style.color = '#1e40af';
                el.style.fontWeight = '500';
              } else {
                el.style.background = 'transparent';
                el.style.color = '#1f2937';
                el.style.fontWeight = '400';
              }
            }
          });

          document.getElementById('emailContent').innerHTML = '<div style="text-align: center; padding: 60px 40px; color: #9ca3af;"><svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin: 0 auto 20px; opacity: 0.5;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg><p style="font-size: 16px; margin: 0;">Sélectionnez un courriel pour le lire</p></div>';

          await this.loadEmails();
          this.slideToView('list');
        },

        async createAccount() {
          if (!currentUser) return;

          try {
            const { data: user } = await supabaseClient
              .from('users')
              .select('full_name')
              .eq('id', currentUser.id)
              .maybeSingle();

            const fullName = user?.full_name || 'Utilisateur Québec';
            const nameParts = fullName.trim().split(/\s+/);

            let firstName, lastName;
            if (nameParts.length >= 2) {
              firstName = nameParts[0];
              lastName = nameParts.slice(1).join(' ');
            } else {
              firstName = nameParts[0] || 'Utilisateur';
              lastName = 'Quebec';
            }

            const normalizeForEmail = (str) => {
              return str.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]/g, '_')
                .replace(/_+/g, '_')
                .replace(/^_|_$/g, '');
            };

            const emailAddress = `${normalizeForEmail(firstName)}_${normalizeForEmail(lastName)}@quebec.gouv.qc.ca`;

            const { error } = await supabaseClient
              .from('email_accounts')
              .insert([{
                user_id: currentUser.id,
                email_address: emailAddress,
                display_name: fullName,
                signature: `\n\n--\n${fullName}\nGouvernement du Québec`
              }]);

            if (error) throw error;
          } catch (error) {
            console.error('Create email account error:', error);
          }
        },

        async searchRecipients(query) {
          const suggestionsEl = document.getElementById('recipientSuggestions');
          if (!suggestionsEl) return;

          if (!query || query.length < 2) {
            suggestionsEl.style.display = 'none';
            return;
          }

          try {
            const { data: accounts } = await supabaseClient
              .from('email_accounts')
              .select('email_address, display_name')
              .or(`email_address.ilike.%${query}%,display_name.ilike.%${query}%`)
              .limit(10);

            if (!accounts || accounts.length === 0) {
              suggestionsEl.style.display = 'none';
              return;
            }

            suggestionsEl.innerHTML = accounts.map(acc => `
              <div onclick="WebOS.Apps.Mail.selectRecipient('${acc.email_address}')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                <div style="font-weight: 500; font-size: 14px; color: #1f2937;">${acc.display_name}</div>
                <div style="font-size: 12px; color: #6b7280;">${acc.email_address}</div>
              </div>
            `).join('');

            suggestionsEl.style.display = 'block';
          } catch (error) {
            console.error('Search recipients error:', error);
          }
        },

        selectRecipient(email) {
          const inputEl = document.getElementById('mailTo');
          if (inputEl) {
            const current = inputEl.value;
            if (current && !current.endsWith(',')) {
              inputEl.value = current + ', ' + email;
            } else {
              inputEl.value = email;
            }
          }

          const suggestionsEl = document.getElementById('recipientSuggestions');
          if (suggestionsEl) suggestionsEl.style.display = 'none';
        },

        async showDirectory() {
          try {
            const { data: accounts } = await supabaseClient
              .from('email_accounts')
              .select('email_address, display_name, user_id')
              .eq('is_active', true)
              .order('display_name');

            const currentUserId = currentUser?.id;

            const content = `
              <div style="padding: 20px;">
                <h2 style="margin: 0 0 12px 0; font-size: 24px; font-weight: 700; color: #1f2937;">Annuaire des utilisateurs</h2>
                <p style="margin: 0 0 20px 0; font-size: 14px; color: #6b7280;">Comptes actifs du système</p>
                <div style="margin-bottom: 16px;">
                  <input type="text" id="directorySearch" placeholder="Rechercher un utilisateur..." style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" oninput="WebOS.Apps.Mail.filterDirectory(this.value)" />
                </div>
                <div id="directoryList" style="max-height: 500px; overflow-y: auto;">
                  ${(accounts || []).map(acc => {
                    const isCurrentUser = acc.user_id === currentUserId;
                    return `
                    <div class="directory-item" style="padding: 14px; border: 1px solid ${isCurrentUser ? '#3b82f6' : '#e5e7eb'}; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; background: ${isCurrentUser ? '#eff6ff' : 'white'};" onclick="WebOS.Apps.Mail.useEmailFromDirectory('${acc.email_address}')" onmouseover="this.style.background='${isCurrentUser ? '#dbeafe' : '#f9fafb'}'; this.style.borderColor='#3b82f6'" onmouseout="this.style.background='${isCurrentUser ? '#eff6ff' : 'white'}'; this.style.borderColor='${isCurrentUser ? '#3b82f6' : '#e5e7eb'}'">
                      <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; background: ${isCurrentUser ? '#3b82f6' : '#6b7280'}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">${acc.display_name[0].toUpperCase()}</div>
                        <div style="flex: 1;">
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="font-weight: 600; font-size: 15px; color: #1f2937;">${acc.display_name}</div>
                            ${isCurrentUser ? '<span style="font-size: 11px; padding: 2px 8px; background: #3b82f6; color: white; border-radius: 12px; font-weight: 600;">Vous</span>' : ''}
                          </div>
                          <div style="font-size: 13px; color: #6b7280;">${acc.email_address}</div>
                        </div>
                      </div>
                    </div>
                  `}).join('')}
                </div>
              </div>
            `;

            WindowManager.create('directory', 'Annuaire', content, { width: 600, height: 700 });
          } catch (error) {
            console.error('Show directory error:', error);
            alert('Erreur lors du chargement de l\'annuaire');
          }
        },

        filterDirectory(query) {
          const items = document.querySelectorAll('.directory-item');
          const searchTerm = query.toLowerCase();

          items.forEach(item => {
            const text = item.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
              item.style.display = 'block';
            } else {
              item.style.display = 'none';
            }
          });
        },

        useEmailFromDirectory(email) {
          const inputEl = document.getElementById('mailTo');
          if (inputEl) {
            inputEl.value = email;
          }
          WindowManager.close('directory');
        },

        slideToView(view) {
          this.currentView = view;
          const folders = document.getElementById('mailFolders');
          const list = document.getElementById('mailList');
          const content = document.getElementById('emailContent');

          if (!folders || !list || !content) return;

          if (view === 'folders') {
            folders.style.transform = 'translateX(0%)';
            list.style.transform = 'translateX(0%)';
            content.style.transform = 'translateX(0%)';
          } else if (view === 'list') {
            folders.style.transform = 'translateX(-100%)';
            list.style.transform = 'translateX(-100%)';
            content.style.transform = 'translateX(-100%)';
          } else if (view === 'content') {
            folders.style.transform = 'translateX(-200%)';
            list.style.transform = 'translateX(-200%)';
            content.style.transform = 'translateX(-200%)';
          }
        }
      }
    };

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function updateLoadingProgress(percent, status) {
      const fill = document.getElementById('progressFill');
      const statusText = document.getElementById('loadingStatus');

      if (fill) fill.style.width = `${percent}%`;
      if (statusText) statusText.textContent = status;
    }

    function updateSystemTime() {
      const timeEl = document.getElementById('systemTime');
      if (timeEl) {
        const now = new Date();
        timeEl.textContent = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
      }
    }

    function setupTopbarScroll() {
      const topbar = document.getElementById('topbar');
      if (!topbar) return;

      let isDown = false;
      let startX;
      let scrollLeft;

      topbar.addEventListener('mousedown', (e) => {
        if (e.target.closest('.topbar-item')) return;
        isDown = true;
        topbar.style.cursor = 'grabbing';
        startX = e.pageX - topbar.offsetLeft;
        scrollLeft = topbar.scrollLeft;
      });

      topbar.addEventListener('mouseleave', () => {
        isDown = false;
        topbar.style.cursor = 'default';
      });

      topbar.addEventListener('mouseup', () => {
        isDown = false;
        topbar.style.cursor = 'default';
      });

      topbar.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        e.preventDefault();
        const x = e.pageX - topbar.offsetLeft;
        const walk = (x - startX) * 2;
        topbar.scrollLeft = scrollLeft - walk;
      });

      let touchStartX = 0;
      let touchScrollLeft = 0;

      topbar.addEventListener('touchstart', (e) => {
        if (e.target.closest('.topbar-item')) return;
        touchStartX = e.touches[0].pageX;
        touchScrollLeft = topbar.scrollLeft;
      }, { passive: true });

      topbar.addEventListener('touchmove', (e) => {
        const touchX = e.touches[0].pageX;
        const walk = (touchStartX - touchX) * 1.5;
        topbar.scrollLeft = touchScrollLeft + walk;
      }, { passive: true });
    }

    async function showDesktop() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('desktop').style.display = 'block';
      document.getElementById('topbar').style.display = 'flex';
      document.getElementById('dock').style.display = 'flex';

      setupTopbarScroll();

      setInterval(updateSystemTime, 1000);
      updateSystemTime();

      await Notifications.initialize();
      await NotificationCenter.initialize();

      AIHelperService.start();
      AIEmailResponder.start();

      Kernel.emit('desktop:ready');
    }

    function showAbout() {
      const content = `
        <div style="padding: 30px; max-height: 80vh; overflow-y: auto;">
          <!-- Header -->
          <div style="text-align: center; margin-bottom: 40px;">
            <div style="font-size: 96px; margin-bottom: 20px;">⚜️</div>
            <h1 style="font-size: 28px; font-weight: 700; color: #1e40af; margin-bottom: 8px;">MANIFESTE OFFICIEL DE PROPRIÉTÉ INTELLECTUELLE</h1>
            <p style="font-size: 16px; color: #6b7280; font-weight: 500;">WebOS Québec — WOSQ</p>
          </div>

          <!-- Préambule -->
          <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); padding: 24px; border-radius: 12px; border-left: 4px solid #3b82f6; margin-bottom: 24px;">
            <h2 style="font-size: 20px; font-weight: 700; color: #1e40af; margin-bottom: 16px;">Préambule</h2>
            <p style="line-height: 1.8; color: #1e293b;">
              Par la présente, moi, <strong>William Michaud</strong>, créateur indépendant, innovateur technologique et auteur exclusif,
              déclare être : - l'unique concepteur, - l'unique développeur, - l'unique propriétaire intellectuel, - la seule
              autorité décisionnelle du projet <strong>WebOS Québec / WebOS Qc / WOSQ</strong>.
            </p>
          </div>

          <!-- Section 1 -->
          <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e5e7eb;">
            <h3 style="font-size: 18px; font-weight: 700; color: #1e40af; margin-bottom: 12px;">1. Déclaration d'Origine & d'Antériorité</h3>
            <p style="line-height: 1.8; color: #334155;">
              Je déclare que l'intégralité du système, incluant le noyau, le gestionnaire de fenêtres, le FileSystem OPFS,
              les snapshots chiffrés AES-GCM, l'architecture OS monolithique, les modules internes, l'OSINT et
              l'intégration IA locale, a été conçue et écrite par moi-même. La présente constitue la preuve officielle datée
              du : <strong>6 novembre 2025</strong>.
            </p>
          </div>

          <!-- Section 2 -->
          <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e5e7eb;">
            <h3 style="font-size: 18px; font-weight: 700; color: #1e40af; margin-bottom: 12px;">2. Droits d'Auteur</h3>
            <p style="line-height: 1.8; color: #334155;">
              Je détiens 100% des droits d'auteur selon les lois du Canada, du Québec et les conventions internationales :
              WIPO, Berne, ADPIC. Toute reproduction ou exploitation est interdite sans autorisation écrite.
            </p>
          </div>

          <!-- Section 3 -->
          <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e5e7eb;">
            <h3 style="font-size: 18px; font-weight: 700; color: #1e40af; margin-bottom: 12px;">3. Droits Patrimoniaux Réservés</h3>
            <p style="line-height: 1.8; color: #334155;">
              Je conserve tous les droits : reproduction, adaptation, commercialisation, vente, distribution, cryptage,
              dérivations, licences.
            </p>
          </div>

          <!-- Section 4 -->
          <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e5e7eb;">
            <h3 style="font-size: 18px; font-weight: 700; color: #1e40af; margin-bottom: 12px;">4. Protection de la Vision</h3>
            <p style="line-height: 1.8; color: #334155;">
              Le concept WebOS Québec — OS souverain, monolithique, portable, sécurisé et doté d'intelligence locale
              — fait partie intégrante de ma propriété intellectuelle.
            </p>
          </div>

          <!-- Section 5 -->
          <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e5e7eb;">
            <h3 style="font-size: 18px; font-weight: 700; color: #1e40af; margin-bottom: 12px;">5. Interdiction d'Usage Non Autorisé</h3>
            <p style="line-height: 1.8; color: #334155;">
              Toute utilisation sans licence — copie, rebranding, extraction, reverse engineering — constitue une violation légale.
            </p>
          </div>

          <!-- Section 6 -->
          <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e5e7eb;">
            <h3 style="font-size: 18px; font-weight: 700; color: #1e40af; margin-bottom: 12px;">6. Cadre de Licence & Valeur</h3>
            <p style="line-height: 1.8; color: #334155;">
              Valeur estimée selon le type d'octroi :<br>
              - Code brut : 4 000 à 12 000 CAD<br>
              - Produit technologique : 25 000 à 80 000 CAD<br>
              - Propriété intellectuelle complète : 100 000 à 350 000 CAD
            </p>
          </div>

          <!-- Section 7 -->
          <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e5e7eb;">
            <h3 style="font-size: 18px; font-weight: 700; color: #1e40af; margin-bottom: 12px;">7. Juridiction</h3>
            <p style="line-height: 1.8; color: #334155;">
              Document régi par les lois du Canada, du Québec et les traités internationaux sur le droit d'auteur.
            </p>
          </div>

          <!-- Signature -->
          <div style="background: #f8fafc; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
            <h3 style="font-size: 18px; font-weight: 700; color: #1e40af; margin-bottom: 12px;">Signature & Validation</h3>
            <p style="line-height: 1.8; color: #334155; margin-bottom: 12px;">
              Je certifie l'exactitude du présent manifeste. <strong>William Michaud (WM)</strong> Québec, 6 novembre 2025.
            </p>

            <div style="margin-top: 20px;">
              <p style="font-size: 14px; font-weight: 600; color: #64748b; margin-bottom: 8px;">Horodatage SHA-256</p>
              <p style="font-family: 'Courier New', monospace; font-size: 11px; color: #475569; word-break: break-all; background: white; padding: 12px; border-radius: 8px;">
                59632bd3e8de965c83ae338b485f72c8b088b50a887dde4d75825c8648809192
              </p>
            </div>
          </div>

          <!-- Version & Info -->
          <div style="text-align: center; margin-top: 30px; padding-top: 24px; border-top: 2px solid #e5e7eb;">
            <p style="color: #1e40af; font-size: 16px; font-weight: 700; line-height: 1.8; margin-bottom: 12px;">
              Par des rois. Pour le Québec.<br>
              Durable, indestructible, évolutif — à jamais.
            </p>
            <p style="font-size: 14px; color: #6b7280; margin-top: 16px;">
              <strong>Version 1.0.0</strong> • Système d'Exploitation Souverain
            </p>
          </div>
        </div>
      `;

      WindowManager.create('about', 'À propos - Manifeste Officiel', content, { width: 800, height: 700 });
    }

    function showSettings() {
      const content = `
        <div style="display: flex; flex-direction: column; gap: 16px;">
          <button
            id="openProfileBtn"
            style="padding: 16px; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; border-radius: 12px; color: white; font-weight: 600; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 12px; font-size: 15px; transition: transform 0.2s;"
            onmouseover="this.style.transform='scale(1.02)'"
            onmouseout="this.style.transform='scale(1)'"
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
            <div>
              <div style="font-size: 16px;">Profil & Sécurité</div>
              <div style="font-size: 12px; opacity: 0.9;">2FA, numéro de téléphone, compte</div>
            </div>
          </button>

          <button
            onclick="WebOS.Apps.Admin && WebOS.Apps.Admin.open()"
            style="padding: 16px; background: linear-gradient(135deg, #6366f1, #4f46e5); border: none; border-radius: 12px; color: white; font-weight: 600; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 12px; font-size: 15px; transition: transform 0.2s;"
            onmouseover="this.style.transform='scale(1.02)'"
            onmouseout="this.style.transform='scale(1)'"
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 1l3 5.2 5.8.9-4.2 4.1 1 5.8L12 15.8 6.4 17l1-5.8L3.2 7.1 9 6.2z"/>
            </svg>
            <div>
              <div style="font-size: 16px;">Console d'administration</div>
              <div style="font-size: 12px; opacity: 0.9;">Logs, métriques, sécurité du système</div>
            </div>
          </button>

          <div style="padding: 20px; background: #f3f4f6; border-radius: 12px;">
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; color: #1e40af;">Intelligence Artificielle</h3>
            <div style="display: grid; gap: 8px; font-size: 14px;">
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #6b7280;">Modèle:</span>
                <strong>${CONFIG.webllm.model}</strong>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #6b7280;">Température:</span>
                <strong>${CONFIG.webllm.temperature}</strong>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #6b7280;">Top-P:</span>
                <strong>${CONFIG.webllm.topP}</strong>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #6b7280;">Tokens max:</span>
                <strong>${CONFIG.webllm.maxTokens}</strong>
              </div>
            </div>
          </div>

          <div style="padding: 20px; background: #ecfdf5; border: 1px solid #10b981; border-radius: 12px;">
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; color: #059669;">Assistants IA</h3>
            <div style="display: grid; gap: 12px; margin-bottom: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #065f46; font-weight: 500;">Service actif:</span>
                <strong id="aiHelperStatus" style="color: ${AIHelperService.isEnabled() ? '#10b981' : '#6b7280'};">${AIHelperService.isEnabled() ? 'Oui' : 'Non'}</strong>
              </div>
              <div style="font-size: 13px; color: #047857;">
                3 assistants IA disponibles pour vous aider avec des messages périodiques
              </div>
            </div>
            <div style="display: flex; gap: 8px;">
              <button
                onclick="WebOS.AIHelperService.sendTestMessage(); alert('Message test envoyé!');"
                style="flex: 1; padding: 10px 16px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: background 0.2s;"
                onmouseover="this.style.background='#059669'"
                onmouseout="this.style.background='#10b981'"
              >
                Envoyer test
              </button>
              <button
                id="toggleAIHelperBtn"
                onclick="
                  if (WebOS.AIHelperService.isEnabled()) {
                    WebOS.AIHelperService.stop();
                    this.textContent = 'Démarrer';
                    this.style.background = '#10b981';
                    document.getElementById('aiHelperStatus').textContent = 'Non';
                    document.getElementById('aiHelperStatus').style.color = '#6b7280';
                  } else {
                    WebOS.AIHelperService.start();
                    this.textContent = 'Arrêter';
                    this.style.background = '#ef4444';
                    document.getElementById('aiHelperStatus').textContent = 'Oui';
                    document.getElementById('aiHelperStatus').style.color = '#10b981';
                  }
                "
                style="flex: 1; padding: 10px 16px; background: ${AIHelperService.isEnabled() ? '#ef4444' : '#10b981'}; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: background 0.2s;"
              >
                ${AIHelperService.isEnabled() ? 'Arrêter' : 'Démarrer'}
              </button>
            </div>
          </div>

          <div style="padding: 20px; background: #f3f4f6; border-radius: 12px;">
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; color: #1e40af;">Compte</h3>
            <div style="display: grid; gap: 8px; font-size: 14px;">
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #6b7280;">Email:</span>
                <strong>${currentUser?.email || 'Non connecté'}</strong>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #6b7280;">ID:</span>
                <strong style="font-family: monospace; font-size: 12px;">${currentUser?.id?.substring(0, 8) || 'N/A'}...</strong>
              </div>
            </div>
          </div>

          <div style="padding: 16px; background: #dbeafe; border: 1px solid #3b82f6; border-radius: 12px;">
            <div style="display: flex; align-items: start; gap: 12px;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4"/>
                <path d="M12 8h.01"/>
              </svg>
              <div style="font-size: 13px; color: #1e40af; line-height: 1.5;">
                <strong>Astuce:</strong> Activez la double authentification pour sécuriser votre compte avec un code SMS à chaque connexion.
              </div>
            </div>
          </div>
        </div>
      `;

      WindowManager.create('settings', 'Préférences Système', content, { width: 600, height: 600 });

      setTimeout(() => {
        const btn = document.getElementById('openProfileBtn');
        if (btn) {
          btn.addEventListener('click', () => {
            openProfileSettings();
          });
        }
      }, 100);
    }

    async function openProfileSettings() {
      if (!currentUser) {
        alert('Vous devez être connecté');
        return;
      }

      // Charger le profil utilisateur
      const { data: userProfile } = await supabaseClient
        .from('users')
        .select('*')
        .eq('id', currentUser.id)
        .maybeSingle();

      const profile = userProfile || {};

      const content = `
        <style>
          .profile-container { padding: 24px; background: #09090b; color: #fafafa; height: 100%; overflow-y: auto; }
          .profile-section { background: #18181b; border: 1px solid #27272a; border-radius: 12px; padding: 24px; margin-bottom: 24px; }
          .profile-section-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
          .profile-info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #27272a; }
          .profile-info-row:last-child { border-bottom: none; }
          .profile-info-label { color: #a1a1aa; font-size: 14px; }
          .profile-info-value { font-weight: 600; }
          .profile-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; }
          .profile-badge.success { background: #10b98120; color: #10b981; }
          .profile-badge.warning { background: #f59e0b20; color: #f59e0b; }
          .profile-phone-section { background: #27272a; border-radius: 8px; padding: 16px; margin-top: 16px; }
          .profile-input-group { margin-bottom: 16px; }
          .profile-input-group label { display: block; font-size: 14px; font-weight: 600; color: #a1a1aa; margin-bottom: 8px; }
          .profile-input-group input { width: 100%; padding: 12px; background: #09090b; border: 1px solid #3f3f46; border-radius: 8px; color: #fafafa; font-size: 15px; outline: none; }
          .profile-input-group input:focus { border-color: #3b82f6; }
          .profile-btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; font-size: 15px; width: 100%; }
          .profile-btn:hover { opacity: 0.9; }
          .profile-btn:disabled { opacity: 0.5; cursor: not-allowed; }
          .profile-btn-primary { background: #3b82f6; color: white; }
          .profile-btn-success { background: #10b981; color: white; }
          .profile-btn-danger { background: #ef4444; color: white; }
          .profile-btn-secondary { background: transparent; color: #a1a1aa; border: 1px solid #3f3f46; }
          .profile-alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: start; gap: 12px; }
          .profile-alert.error { background: #ef444420; border: 1px solid #ef444440; color: #ef4444; }
          .profile-alert.success { background: #10b98120; border: 1px solid #10b98140; color: #10b981; }
          .profile-toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 16px 0; }
          .profile-toggle-label { font-weight: 600; }
          .profile-toggle-desc { font-size: 13px; color: #a1a1aa; margin-top: 4px; }
          .profile-switch { position: relative; width: 48px; height: 24px; background: #27272a; border-radius: 12px; cursor: pointer; transition: background 0.2s; }
          .profile-switch.active { background: #10b981; }
          .profile-switch.disabled { opacity: 0.5; cursor: not-allowed; }
          .profile-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: transform 0.2s; }
          .profile-switch.active::after { transform: translateX(24px); }
        </style>
        <div class="profile-container">
          <div class="profile-section">
            <div class="profile-section-title">Informations du compte</div>
            <div class="profile-info-row">
              <span class="profile-info-label">Email</span>
              <span class="profile-info-value">${currentUser.email}</span>
            </div>
            <div class="profile-info-row">
              <span class="profile-info-label">ID Utilisateur</span>
              <span class="profile-info-value" style="font-size:12px;font-family:monospace">${currentUser.id.substring(0, 8)}...</span>
            </div>
            <div class="profile-info-row">
              <span class="profile-info-label">Nom complet</span>
              <span class="profile-info-value">${profile.full_name || '<span style="color:#71717a">Non défini</span>'}</span>
            </div>
            <div id="nameEditContainer" class="profile-phone-section" style="display:none">
              <div id="nameAlertContainer"></div>
              <div class="profile-input-group">
                <label>Nouveau nom complet</label>
                <input type="text" id="nameInput" placeholder="Votre nom complet" value="${profile.full_name || ''}" />
              </div>
              <button class="profile-btn profile-btn-primary" style="margin-bottom:12px" id="saveNameBtn">
                Enregistrer
              </button>
              <button class="profile-btn profile-btn-secondary" id="cancelNameBtn">
                Annuler
              </button>
            </div>
            <div style="margin-top:16px">
              <button class="profile-btn profile-btn-primary" id="editNameBtn">
                Modifier le nom
              </button>
            </div>
          </div>

          <div class="profile-section">
            <div class="profile-section-title">Sécurité - Authentification à deux facteurs</div>
            <div class="profile-toggle-row">
              <div>
                <div class="profile-toggle-label">Double authentification (2FA)</div>
                <div class="profile-toggle-desc">
                  ${profile.two_factor_enabled ? 'Activée - Code SMS requis à la connexion' : 'Désactivée - Nécessite un numéro vérifié'}
                </div>
              </div>
              <div class="profile-switch ${profile.two_factor_enabled ? 'active' : ''} ${!profile.phone_verified ? 'disabled' : ''}" id="toggle2FASwitch"></div>
            </div>
          </div>

          <div class="profile-section">
            <div class="profile-section-title">Numéro de téléphone</div>
            ${profile.phone_number ? `
              <div class="profile-info-row">
                <span class="profile-info-label">Numéro</span>
                <span class="profile-info-value">${profile.phone_number}</span>
              </div>
              <div class="profile-info-row">
                <span class="profile-info-label">Statut</span>
                <span class="profile-badge ${profile.phone_verified ? 'success' : 'warning'}">
                  ${profile.phone_verified ? '✓ Vérifié' : '⚠ Non vérifié'}
                </span>
              </div>
              ${!profile.phone_verified ? `
                <div class="profile-phone-section">
                  <button class="profile-btn profile-btn-primary" id="resendBtn">
                    Renvoyer le code de vérification
                  </button>
                </div>
              ` : ''}
              <div class="profile-phone-section">
                <button class="profile-btn profile-btn-danger" id="removePhoneBtn">
                  Retirer le numéro
                </button>
              </div>
            ` : `
              <div class="profile-phone-section">
                <div id="phoneAlertContainer"></div>
                <div class="profile-input-group">
                  <label>Numéro de téléphone</label>
                  <input type="tel" id="phoneInput" placeholder="+1 514-555-0123" />
                  <div style="font-size: 12px; color: #71717a; margin-top: 4px;">Format: +1 XXX-XXX-XXXX (Québec/Canada)</div>
                </div>
                <button class="profile-btn profile-btn-primary" id="sendCodeBtn">
                  Envoyer le code de vérification
                </button>
              </div>
            `}
          </div>
        </div>
      `;

      WindowManager.create('profile-settings', 'Profil & Sécurité', content, { width: 700, height: 800 });

      setTimeout(() => {
        // Modification du nom
        const editBtn = document.getElementById('editNameBtn');
        const saveBtn = document.getElementById('saveNameBtn');
        const cancelBtn = document.getElementById('cancelNameBtn');
        const nameEditContainer = document.getElementById('nameEditContainer');

        if (editBtn) {
          editBtn.addEventListener('click', () => {
            editBtn.style.display = 'none';
            nameEditContainer.style.display = 'block';
          });
        }

        if (cancelBtn) {
          cancelBtn.addEventListener('click', () => {
            nameEditContainer.style.display = 'none';
            editBtn.style.display = 'block';
          });
        }

        if (saveBtn) {
          saveBtn.addEventListener('click', async () => {
            const nameInput = document.getElementById('nameInput');
            const newName = nameInput?.value.trim();
            const alertContainer = document.getElementById('nameAlertContainer');

            if (!newName) {
              if (alertContainer) alertContainer.innerHTML = '<div class="profile-alert error">Le nom ne peut pas être vide</div>';
              return;
            }

            try {
              const { error } = await supabaseClient
                .from('users')
                .update({ full_name: newName })
                .eq('id', currentUser.id);

              if (error) throw error;

              if (alertContainer) alertContainer.innerHTML = '<div class="profile-alert success">Nom mis à jour avec succès</div>';
              setTimeout(() => {
                WindowManager.close('profile-settings');
                openProfileSettings();
              }, 1500);
            } catch (error) {
              if (alertContainer) alertContainer.innerHTML = `<div class="profile-alert error">Erreur: ${error.message}</div>`;
            }
          });
        }

        // Toggle 2FA
        const toggle2FA = document.getElementById('toggle2FASwitch');
        if (toggle2FA && profile.phone_verified) {
          toggle2FA.addEventListener('click', async () => {
            const newValue = !profile.two_factor_enabled;
            try {
              const { error } = await supabaseClient
                .from('users')
                .update({ two_factor_enabled: newValue })
                .eq('id', currentUser.id);

              if (error) throw error;

              await Notifications.createNotification(
                '2FA ' + (newValue ? 'Activée' : 'Désactivée'),
                'Double authentification ' + (newValue ? 'activée' : 'désactivée'),
                'success',
                'security'
              );

              setTimeout(() => {
                WindowManager.close('profile-settings');
                openProfileSettings();
              }, 1000);
            } catch (error) {
              alert('Erreur: ' + error.message);
            }
          });
        }

        // Envoyer code de vérification
        const sendCodeBtn = document.getElementById('sendCodeBtn');
        if (sendCodeBtn) {
          sendCodeBtn.addEventListener('click', async () => {
            const phoneInput = document.getElementById('phoneInput');
            const phone = phoneInput?.value.trim();
            const alertContainer = document.getElementById('phoneAlertContainer');

            if (!phone) {
              if (alertContainer) alertContainer.innerHTML = '<div class="profile-alert error">Le numéro de téléphone est requis</div>';
              return;
            }

            try {
              sendCodeBtn.disabled = true;
              sendCodeBtn.textContent = 'Envoi en cours...';

              const response = await fetch(`${CONFIG.supabase.url}/functions/v1/send-sms-verification`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${CONFIG.supabase.anonKey}`
                },
                body: JSON.stringify({ phone_number: phone })
              });

              const data = await response.json();

              if (data.error) {
                throw new Error(data.error);
              }

              if (alertContainer) alertContainer.innerHTML = '<div class="profile-alert success">Code de vérification envoyé!</div>';

              // Sauvegarder le numéro
              await supabaseClient
                .from('users')
                .update({ phone_number: phone, phone_verified: false })
                .eq('id', currentUser.id);

              setTimeout(() => {
                WindowManager.close('profile-settings');
                openProfileSettings();
              }, 1500);

            } catch (error) {
              if (alertContainer) alertContainer.innerHTML = `<div class="profile-alert error">Erreur: ${error.message}</div>`;
            } finally {
              sendCodeBtn.disabled = false;
              sendCodeBtn.textContent = 'Envoyer le code de vérification';
            }
          });
        }

        // Retirer le numéro
        const removePhoneBtn = document.getElementById('removePhoneBtn');
        if (removePhoneBtn) {
          removePhoneBtn.addEventListener('click', async () => {
            if (!confirm('Êtes-vous sûr de vouloir retirer votre numéro de téléphone?')) return;

            try {
              const { error } = await supabaseClient
                .from('users')
                .update({ phone_number: null, phone_verified: false, two_factor_enabled: false })
                .eq('id', currentUser.id);

              if (error) throw error;

              await Notifications.createNotification(
                'Numéro retiré',
                'Votre numéro de téléphone a été retiré',
                'info',
                'security'
              );

              setTimeout(() => {
                WindowManager.close('profile-settings');
                openProfileSettings();
              }, 1000);
            } catch (error) {
              alert('Erreur: ' + error.message);
            }
          });
        }

        // Renvoyer code
        const resendBtn = document.getElementById('resendBtn');
        if (resendBtn) {
          resendBtn.addEventListener('click', async () => {
            try {
              resendBtn.disabled = true;
              resendBtn.textContent = 'Envoi en cours...';

              const response = await fetch(`${CONFIG.supabase.url}/functions/v1/send-sms-verification`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${CONFIG.supabase.anonKey}`
                },
                body: JSON.stringify({ phone_number: profile.phone_number })
              });

              const data = await response.json();

              if (data.error) {
                throw new Error(data.error);
              }

              await Notifications.createNotification(
                'Code envoyé',
                'Un nouveau code a été envoyé',
                'success',
                'security'
              );

              resendBtn.textContent = 'Code envoyé!';
              setTimeout(() => {
                resendBtn.disabled = false;
                resendBtn.textContent = 'Renvoyer le code de vérification';
              }, 3000);

            } catch (error) {
              alert('Erreur: ' + error.message);
              resendBtn.disabled = false;
              resendBtn.textContent = 'Renvoyer le code de vérification';
            }
          });
        }
      }, 100);
    }

    // ============================================
    // EARLY GLOBAL EXPOSURE
    // ============================================
    // Exposition précoce de WebOS pour les event handlers HTML (onclick)
    // Ceci permet aux boutons dans le HTML d'accéder à WebOS.Apps avant le boot complet
    if (typeof window.WebOS === 'undefined') {
      window.WebOS = {};
    }
    window.WebOS.Apps = Apps;
    window.WebOS.Kernel = Kernel;
    window.WebOS.WindowManager = WindowManager;
    // NotificationCenter sera ajouté plus tard après sa définition (ligne ~9837)

    console.log('[WOSQ v4] WebOS exposé - Apps, Kernel et WindowManager accessibles');

    // ============================================
    // INITIALIZATION
    // ============================================
    function preventMobileZoom() {
      let lastTouchEnd = 0;
      document.addEventListener('touchend', (e) => {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) {
          e.preventDefault();
        }
        lastTouchEnd = now;
      }, { passive: false });

      document.addEventListener('gesturestart', (e) => {
        e.preventDefault();
      });

      document.addEventListener('gesturechange', (e) => {
        e.preventDefault();
      });

      document.addEventListener('gestureend', (e) => {
        e.preventDefault();
      });
    }

    async function initialize() {
      try {
        console.log('[WOSQ v4] Début initialisation architecture cellulaire');

        preventMobileZoom();

        updateLoadingProgress(10, 'Initialisation Supabase...');
        console.log('[INIT] Connexion à Supabase...');
        const hasSession = await initSupabase();
        console.log('[OK] Supabase OK, session:', hasSession);

        updateLoadingProgress(25, 'Création du Database Module...');
        console.log('[INIT] Démarrage Database Module (Local-First CRDT)...');
        const dbPid = Kernel.createProcess('database-module');
        if (dbPid) {
          await Kernel.sendRequest(dbPid, 'init');
          console.log('[OK] Database Module démarré (PID:', dbPid + ')');
        }

        updateLoadingProgress(40, 'Démarrage du Sync Provider...');
        console.log('[INIT] Démarrage Sync Provider (Multi-Canal)...');
        const syncPid = Kernel.createProcess('sync-provider');
        if (syncPid) {
          await Kernel.sendRequest(syncPid, 'start');
          console.log('[OK] Sync Provider démarré (PID:', syncPid + ')');
        }

        updateLoadingProgress(55, 'Initialisation du système de fichiers...');
        console.log('[INIT] Initialisation OPFS...');
        await FileSystem.initialize();
        console.log('[OK] OPFS OK');

        updateLoadingProgress(70, 'Préparation de l\'interface...');
        console.log('[INIT] Interface...');
        await new Promise(resolve => setTimeout(resolve, 500));

        updateLoadingProgress(85, 'Écoute des événements système...');
        Kernel.on('process:created', (data) => {
          console.log(`[System] Processus créé: ${data.name} (${data.pid})`);
        });

        Kernel.on('process:terminated', (data) => {
          console.log(`[System] Processus terminé: ${data.pid}`);
        });

        Kernel.on('process:error', (data) => {
          console.error(`[System] Erreur processus ${data.name}:`, data.error);
        });

        Kernel.on('db:updated', (data) => {
          console.log(`[DB] Mise à jour collection ${data.collection}`);
        });

        Kernel.on('peer:discovered', (data) => {
          console.log('[P2P] Peer découvert:', data.peerId);
        });

        updateLoadingProgress(100, 'Prêt!');
        console.log('[OK] WOSQ v4 Cellular prêt! Processus actifs:', Kernel.getProcesses().length);

        setTimeout(() => {
          document.getElementById('loadingScreen').style.display = 'none';

          if (hasSession) {
            console.log('[AUTH] Affichage bureau (utilisateur connecté)');
            showDesktop();

            setTimeout(() => {
              console.log('[WOSQ v4] Ouverture du TaskManager pour démonstration...');
              WebOS.Apps.TaskManager.open();
            }, 1000);
          } else {
            console.log('[AUTH] Affichage écran de connexion');
            document.getElementById('loginScreen').style.display = 'flex';
          }
        }, 500);
      } catch (error) {
        console.error('[ERROR] Erreur initialisation:', error);
        updateLoadingProgress(0, 'Erreur: ' + error.message);
        alert('Erreur critique lors du démarrage:\n\n' + error.message);
      }
    }

    // ============================================
    // NOTIFICATION CENTER
    // ============================================
    const NotificationCenter = (() => {
      let notifications = [];
      let unreadCount = 0;
      let isOpen = false;
      let subscription = null;

      async function loadNotifications() {
        if (!currentUser) return;

        try {
          const { data, error } = await supabaseClient
            .from('notifications')
            .select('*')
            .eq('user_id', currentUser.id)
            .eq('is_dismissed', false)
            .order('created_at', { ascending: false })
            .limit(50);

          if (error) throw error;

          notifications = data || [];
          unreadCount = notifications.filter(n => !n.is_read).length;
          updateBadge();
          updateDockBadges();

          if (isOpen) {
            render();
          }
        } catch (error) {
          console.error('[NotificationCenter] Error loading notifications:', error);
        }
      }

      function updateBadge() {
        const badge = document.getElementById('notification-badge');
        if (badge) {
          if (unreadCount > 0) {
            badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            badge.style.display = 'flex';
          } else {
            badge.style.display = 'none';
          }
        }
      }

      function updateDockBadges() {
        const emailCount = notifications.filter(n => n.type === 'email' && !n.is_read).length;
        const messageCount = notifications.filter(n => n.type === 'message' && !n.is_read).length;

        const mailIcon = document.getElementById('dock-mail');
        const messagesIcon = document.getElementById('dock-messages');

        updateDockBadge(mailIcon, emailCount);
        updateDockBadge(messagesIcon, messageCount);
      }

      function updateDockBadge(iconElement, count) {
        if (!iconElement) return;

        let badge = iconElement.querySelector('.dock-badge');
        if (!badge) {
          badge = document.createElement('div');
          badge.className = 'dock-badge';
          badge.style.cssText = 'position: absolute; top: -4px; right: -4px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center; border: 2px solid #09090b;';
          iconElement.style.position = 'relative';
          iconElement.appendChild(badge);
        }

        if (count > 0) {
          badge.textContent = count > 99 ? '99+' : count;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      }

      function render() {
        const content = `
          <div style="display: flex; flex-direction: column; height: 100%; background: #09090b;">
            <div style="padding: 20px; border-bottom: 1px solid #27272a;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h2 style="font-size: 20px; font-weight: 700; margin: 0;">Portail Citoyen</h2>
                  <div style="font-size: 13px; color: #71717a; margin-top: 2px;">Centre de notifications</div>
                </div>
                <button onclick="WebOS.NotificationCenter.clearAll()" style="padding: 6px 12px; background: #27272a; border: 1px solid #3f3f46; border-radius: 6px; color: #fafafa; cursor: pointer; font-size: 13px;">Tout effacer</button>
              </div>
              ${unreadCount > 0 ? `<div style="margin-top: 12px; padding: 10px; background: #1e293b; border: 1px solid #3b82f6; border-radius: 6px; font-size: 13px; color: #93c5fd;">${unreadCount} notification${unreadCount > 1 ? 's' : ''} non lue${unreadCount > 1 ? 's' : ''}</div>` : ''}
            </div>
            <div style="flex: 1; overflow-y: auto; padding: 12px;">
              ${notifications.length === 0 ? `
                <div style="text-align: center; padding: 60px 20px; color: #71717a;">
                  <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 16px; opacity: 0.5;">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                  </svg>
                  <p style="font-size: 15px; margin: 0;">Aucune notification</p>
                </div>
              ` : notifications.map(n => `
                <div class="notification-item" data-id="${n.id}" style="background: ${n.is_read ? '#18181b' : '#1e293b'}; border: 1px solid ${n.is_read ? '#27272a' : '#3b82f6'}; border-radius: 8px; padding: 14px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;" onmouseenter="this.style.background='#27272a'" onmouseleave="this.style.background='${n.is_read ? '#18181b' : '#1e293b'}'" onclick="WebOS.NotificationCenter.handleClick('${n.id}', '${n.action_url || ''}')">
                  <div style="display: flex; align-items: start; gap: 12px;">
                    <div style="flex-shrink: 0; width: 40px; height: 40px; background: ${getIconColor(n.type)}15; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                      ${getIcon(n.type, n.icon)}
                    </div>
                    <div style="flex: 1; min-width: 0;">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                        <div style="font-weight: 600; font-size: 14px; color: #fafafa;">${escapeHtml(n.title)}</div>
                        <button onclick="event.stopPropagation(); WebOS.NotificationCenter.dismiss('${n.id}')" style="padding: 4px; background: transparent; border: none; color: #71717a; cursor: pointer; font-size: 16px; line-height: 1;" title="Ignorer">×</button>
                      </div>
                      <div style="font-size: 13px; color: #a1a1aa; margin-bottom: 6px; line-height: 1.4;">${escapeHtml(n.body || n.message || '')}</div>
                      <div style="font-size: 11px; color: #71717a;">${formatTime(n.created_at)}</div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;

        const existingWindow = document.getElementById('window-notifications');
        if (existingWindow) {
          const contentDiv = existingWindow.querySelector('.window-content');
          if (contentDiv) {
            contentDiv.innerHTML = content;
          }
        }
      }

      function getIconColor(type) {
        switch (type) {
          case 'email': return '#3b82f6';
          case 'message': return '#10b981';
          case 'system': return '#f59e0b';
          case 'app': return '#8b5cf6';
          default: return '#6b7280';
        }
      }

      function getIcon(type, icon) {
        const color = getIconColor(type);

        if (type === 'email') {
          return `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>`;
        } else if (type === 'message') {
          return `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`;
        } else if (type === 'system') {
          return `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`;
        }
        return `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>`;
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function formatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return 'À l\'instant';
        if (minutes < 60) return `Il y a ${minutes} min`;
        if (hours < 24) return `Il y a ${hours}h`;
        if (days < 7) return `Il y a ${days}j`;
        return date.toLocaleDateString('fr-CA');
      }

      async function handleClick(notificationId, actionUrl) {
        await markAsRead(notificationId);

        if (actionUrl && actionUrl !== 'null') {
          if (actionUrl.includes('/apps/mail')) {
            await WebOS.Apps.Mail.open();
          } else if (actionUrl.includes('/apps/messages')) {
            await WebOS.Apps.Messages.open();
          }
        }
      }

      async function markAsRead(notificationId) {
        try {
          const { error } = await supabaseClient
            .from('notifications')
            .update({ is_read: true, read_at: new Date().toISOString() })
            .eq('id', notificationId);

          if (error) throw error;

          await loadNotifications();
        } catch (error) {
          console.error('[NotificationCenter] Error marking as read:', error);
        }
      }

      async function dismiss(notificationId) {
        try {
          const { error } = await supabaseClient
            .from('notifications')
            .update({ is_dismissed: true, dismissed_at: new Date().toISOString() })
            .eq('id', notificationId);

          if (error) throw error;

          await loadNotifications();
        } catch (error) {
          console.error('[NotificationCenter] Error dismissing notification:', error);
        }
      }

      async function clearAll() {
        if (!confirm('Effacer toutes les notifications?')) return;

        try {
          const { error } = await supabaseClient
            .from('notifications')
            .update({ is_dismissed: true, dismissed_at: new Date().toISOString() })
            .eq('user_id', currentUser.id)
            .eq('is_dismissed', false);

          if (error) throw error;

          await loadNotifications();
        } catch (error) {
          console.error('[NotificationCenter] Error clearing notifications:', error);
        }
      }

      function toggle() {
        const existingWindow = document.getElementById('window-notifications');
        if (existingWindow) {
          WindowManager.close('notifications');
          isOpen = false;
        } else {
          open();
        }
      }

      function open() {
        isOpen = true;
        render();
        WindowManager.create('notifications', 'Portail Citoyen', '', { width: 500, height: 700 });
        const contentDiv = document.getElementById('window-content-notifications');
        if (contentDiv) {
          contentDiv.innerHTML = document.querySelector('.notification-item')?.parentElement?.parentElement?.outerHTML || '';
        }
        render();
      }

      function subscribeToUpdates() {
        if (!currentUser || subscription) return;

        subscription = supabaseClient
          .channel('notifications')
          .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'notifications',
            filter: `user_id=eq.${currentUser.id}`
          }, () => {
            loadNotifications();
          })
          .subscribe();
      }

      async function initialize() {
        if (!currentUser) return;
        await loadNotifications();
        subscribeToUpdates();
      }

      return {
        initialize,
        loadNotifications,
        toggle,
        open,
        handleClick,
        dismiss,
        clearAll,
        getUnreadCount: () => unreadCount
      };
    })();

    // Exposer NotificationCenter maintenant qu'il est défini
    window.WebOS.NotificationCenter = NotificationCenter;
    console.log('[WOSQ v4] NotificationCenter ajouté à WebOS');

    // Make global objects available
    let calendarPopup = null;

    function toggleCalendar(event) {
      if (calendarPopup) {
        calendarPopup.remove();
        calendarPopup = null;
        return;
      }

      const now = new Date();
      const days = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
      const months = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      const prevLastDay = new Date(now.getFullYear(), now.getMonth(), 0);

      const firstDayIndex = firstDay.getDay();
      const lastDayDate = lastDay.getDate();
      const prevLastDayDate = prevLastDay.getDate();

      let daysHTML = '';

      for (let x = firstDayIndex; x > 0; x--) {
        daysHTML += `<div class="calendar-grid-day other-month">${prevLastDayDate - x + 1}</div>`;
      }

      for (let i = 1; i <= lastDayDate; i++) {
        const isToday = i === now.getDate();
        daysHTML += `<div class="calendar-grid-day ${isToday ? 'today' : ''}">${i}</div>`;
      }

      const popup = document.createElement('div');
      popup.className = 'calendar-popup';
      popup.innerHTML = `
        <div class="calendar-header">${months[now.getMonth()]} ${now.getFullYear()}</div>
        <div class="calendar-date">${now.getDate()}</div>
        <div class="calendar-day">${days[now.getDay()]}</div>
        <div class="calendar-grid">
          <div class="calendar-grid-header">D</div>
          <div class="calendar-grid-header">L</div>
          <div class="calendar-grid-header">M</div>
          <div class="calendar-grid-header">M</div>
          <div class="calendar-grid-header">J</div>
          <div class="calendar-grid-header">V</div>
          <div class="calendar-grid-header">S</div>
          ${daysHTML}
        </div>
      `;

      const rect = event.target.getBoundingClientRect();
      popup.style.top = `${rect.bottom + 8}px`;
      popup.style.right = '20px';

      document.body.appendChild(popup);
      calendarPopup = popup;

      setTimeout(() => {
        document.addEventListener('click', function closeCalendar(e) {
          if (calendarPopup && !calendarPopup.contains(e.target) && !event.target.contains(e.target)) {
            calendarPopup.remove();
            calendarPopup = null;
            document.removeEventListener('click', closeCalendar);
          }
        });
      }, 100);
    }

    window.WebOS = {
      Kernel,
      WindowManager,
      Auth,
      Apps,
      FileSystem,
      AI,
      AIHelperService,
      AIEmailResponder,
      Notifications,
      NotificationCenter,
      Logger,
      showAbout,
      showSettings,
      openProfileSettings,
      toggleCalendar
    };

    console.log('WebOS Québec v1.0 - Système de logs activé');
    console.info('Tous les logs de la console (F12) apparaissent maintenant dans le Moniteur Système');

    // Start the system
    initialize().catch(console.error);

    // Register Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(err => {
        console.warn('[ServiceWorker] Registration failed - this is expected in development mode and does not affect functionality:', err.message);
      });
    }
  </script>
  <!-- <script src="/file-manager-advanced.js"></script> -->
</body>
</html>